---
title: "Phase 1 - Tables, Figures, Statistics"
author: "D King"
date: "`r Sys.Date()`"
always_allow_html: true
output:
  html_document:
    pandoc_args:
    - +RTS
    - -K64m
    - -RTS
    df_print: kable
    toc: yes
  word_document:
    toc: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}

# Loading required packages

library(sailr)
library(ggplot2)
library(tidyr)
library(patchwork)
library(scales)
library(gt)
library(stringr)
library(tidyverse)
library(tibble)
library(dplyr)
library(furniture)
library(knitr)
library(kableExtra)
library(caret)
library(egg)
library(glue)
library(sqldf)
library(performance)
library(questionr)
library(stats)
library(jtools)
library(MASS)

```

```{r, include=FALSE}

cbPalette <- c('#56026a','#4d5ca9','#34aa6f','#bddd1d','#e66914')

cbPalette_Overall <- c('#000000','#56026a','#4d5ca9','#34aa6f','#bddd1d','#e66914')

```

```{r, include=FALSE}

check_decimal <- function(df) {
  df$pct <- apply(df, 1, function(row) {
    if(any(sapply(row, function(cell) grepl("\\.[1-9]", cell))))
      return(1)
    else
      return(0)
  })
  return(df)
}

Insert_total_of_n <- function(df,n) {
  Total <- t(round(colSums(df[1:n,2:ncol(df)]),2))
  Total <- cbind(df[1,1], Total)
  Total$Name <- factor(Total$Name, levels = c('Overall','IHD','Stroke','PAD','Poly-vascular'))
  Total[1,1] <- 'Overall'
  df <- rbind(Total, df)
  
  return(df)
}

Pct_denominator_inc <- function(base_df, count_df, pct_df) {
  
  Denom <- base_df %>% group_by(Year) %>% summarise(Val=sum(Incidence)) %>% t() %>% as.data.frame()
  names(Denom) <- Denom[1,]
  Denom <- Denom[-1,] 

  pct_df[1,2:ncol(pct_df)] <- round((count_df[1,2:ncol(count_df)] / Denom[1,1:ncol(Denom)])*100,2)
  
  return(pct_df)
}

Pct_denominator_prev <- function(base_df, count_df, pct_df) {
  
  Denom <- base_df %>% group_by(Year) %>% summarise(Val=sum(Prevalence)) %>% t() %>% as.data.frame()
  names(Denom) <- Denom[1,]
  Denom <- Denom[-1,] 

  pct_df[1,2:ncol(pct_df)] <- round((count_df[1,2:ncol(count_df)] / Denom[1,1:ncol(Denom)])*100,2)
  
  return(pct_df)
}

Insert_mean_of_n <- function(df,n) {
  Mean <- round(t(colSums(df[1:n,2:ncol(df)]))/n,1)
  Mean <- cbind(df[1,1], Mean)
  Mean$Name <- factor(Mean$Name, levels = c('Overall','IHD','Stroke','PAD','Poly-vascular'))
  Mean[1,1] <- 'Overall'
  df <- rbind(Mean, df)
  
  return(df)
}

logit2prob <- function(logit){
  odds <- exp(logit)
  prob <- odds / (1 + odds)
  return(prob)
}


logit2odds <- function(logit){
  odds <- exp(logit)
  return(odds)
}
```

```{r, include=FALSE}

# Connecting to DB2

Connection <- db2_open()
```

## Section 1: Temporal Trends in ASCVD

```{r, include=FALSE}

# Query master table in DB2

Cohort_Master <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.COHORT_MASTER_FINAL')

```

```{r, include=FALSE}

#SQL table transformations

Cohort_Master$diabetes_before <- replace(Cohort_Master$diabetes_before, Cohort_Master$diabetes_before == '0', '')
Cohort_Master$diabetes_before <- replace(Cohort_Master$diabetes_before, Cohort_Master$diabetes_before == '1', 'Diabetes')

Cohort_Master$dementia_before <- replace(Cohort_Master$dementia_before, Cohort_Master$dementia_before == '0', '')
Cohort_Master$dementia_before <- replace(Cohort_Master$dementia_before, Cohort_Master$dementia_before == '1', 'Dementia')

Cohort_Master$malignant_before <- replace(Cohort_Master$malignant_before, Cohort_Master$malignant_before == '0', '')
Cohort_Master$malignant_before <- replace(Cohort_Master$malignant_before, Cohort_Master$malignant_before == '1', 'Malignant')

Cohort_Master$asthma_before <- replace(Cohort_Master$asthma_before, Cohort_Master$asthma_before == '0', '')
Cohort_Master$asthma_before <- replace(Cohort_Master$asthma_before, Cohort_Master$asthma_before == '1', 'Asthma')

Cohort_Master$copd_before <- replace(Cohort_Master$copd_before, Cohort_Master$copd_before == '0', '')
Cohort_Master$copd_before <- replace(Cohort_Master$copd_before, Cohort_Master$copd_before == '1', 'COPD')

Cohort_Master$liver_before <- replace(Cohort_Master$liver_before, Cohort_Master$liver_before == '0', '')
Cohort_Master$liver_before <- replace(Cohort_Master$liver_before, Cohort_Master$liver_before == '1', 'Liver Disease')

Cohort_Master$renal_before <- replace(Cohort_Master$renal_before, Cohort_Master$renal_before == '0', '')
Cohort_Master$renal_before <- replace(Cohort_Master$renal_before, Cohort_Master$renal_before == '1', 'CKD')

Cohort_Master$resp_before <- replace(Cohort_Master$resp_before, Cohort_Master$resp_before == '0', '')
Cohort_Master$resp_before <- replace(Cohort_Master$resp_before, Cohort_Master$resp_before == '1', 'Respiratory Disease')

Cohort_Master$hf_before <- replace(Cohort_Master$hf_before, Cohort_Master$hf_before == '0', '')
Cohort_Master$hf_before <- replace(Cohort_Master$hf_before, Cohort_Master$hf_before == '1', 'Heart Failure')

Cohort_Master$hypertension_before <- replace(Cohort_Master$hypertension_before, Cohort_Master$hypertension_before == '0', '')
Cohort_Master$hypertension_before <- replace(Cohort_Master$hypertension_before, Cohort_Master$hypertension_before == '1', 'Hypertension')

Cohort_Master$Comorbidities <- paste(Cohort_Master$diabetes_before, Cohort_Master$dementia_before, Cohort_Master$malignant_before, Cohort_Master$asthma_before, Cohort_Master$copd_before, Cohort_Master$liver_before, Cohort_Master$renal_before, Cohort_Master$resp_before, Cohort_Master$hf_before, Cohort_Master$hypertension_before, sep=' ')

Cohort_Master$smoking_status <- replace(Cohort_Master$smoking_status, Cohort_Master$smoking_status == 'E', 'Ex-smoker')
Cohort_Master$smoking_status <- replace(Cohort_Master$smoking_status, Cohort_Master$smoking_status == 'N', 'Non-smoker')
Cohort_Master$smoking_status <- replace(Cohort_Master$smoking_status, Cohort_Master$smoking_status == 'S', 'Active smoker')

Cohort_Master$weight_cat <- ifelse(is.na(Cohort_Master$weight_cat), 'UN', Cohort_Master$weight_cat)
Cohort_Master$weight_cat <- ifelse(is.na(Cohort_Master$bmi), 'UN', Cohort_Master$weight_cat)

Cohort_Master$weight_cat <- replace(Cohort_Master$weight_cat, Cohort_Master$weight_cat == 'OW', 'Overweight')
Cohort_Master$weight_cat <- replace(Cohort_Master$weight_cat, Cohort_Master$weight_cat == 'UW', 'Underweight')
Cohort_Master$weight_cat <- replace(Cohort_Master$weight_cat, Cohort_Master$weight_cat == 'N', 'Normal weight')
Cohort_Master$weight_cat <- replace(Cohort_Master$weight_cat, Cohort_Master$weight_cat == 'NORM', 'Normal weight')
Cohort_Master$weight_cat <- replace(Cohort_Master$weight_cat, Cohort_Master$weight_cat == 'OB', 'Obese')
Cohort_Master$weight_cat <- replace(Cohort_Master$weight_cat, Cohort_Master$weight_cat == 'UN', 'Unknown')

Cohort_Master$ethnicity <- replace(Cohort_Master$ethnicity, Cohort_Master$ethnicity == 'Other', NA)
Cohort_Master$ethnicity <- ifelse(is.na(Cohort_Master$ethnicity), 'Unknown', Cohort_Master$ethnicity)

```

<br>
<br>


### Table 1. Baseline Cohort Characteristics

```{r, include=FALSE}

#Table 1

#Transformations
colnames(Cohort_Master)[2] <- 'Sex'
Cohort_Master$Sex <- replace(Cohort_Master$Sex, Cohort_Master$Sex == 1, 'Male')
Cohort_Master$Sex <- replace(Cohort_Master$Sex, Cohort_Master$Sex == 2, 'Female')
Cohort_Master$Sex <- replace(Cohort_Master$Sex, Cohort_Master$Sex == 0, NA)
Cohort_Master$Sex <- replace(Cohort_Master$Sex, Cohort_Master$Sex == 3, NA)
Cohort_Master$Sex <- replace(Cohort_Master$Sex, Cohort_Master$Sex == 9, NA)

Cohort_Master$type <- replace(Cohort_Master$type, Cohort_Master$type == 'ST', 'Stroke')

Cohort_Master$censor_reason <- replace(Cohort_Master$censor_reason, Cohort_Master$censor_reason == 'DEATH', 'Death')
Cohort_Master$censor_reason <- replace(Cohort_Master$censor_reason, Cohort_Master$censor_reason == 'GP_LOSS', 'GP Registration Loss')
Cohort_Master$censor_reason <- replace(Cohort_Master$censor_reason, Cohort_Master$censor_reason == 'MIGRATION', 'Migration Loss')

Cohort_Master$has_2_terr <- replace(Cohort_Master$has_2_terr, Cohort_Master$has_2_terr == '0', '')
Cohort_Master$has_2_terr <- replace(Cohort_Master$has_2_terr, Cohort_Master$has_2_terr == '1', ' ')

Cohort_Master$has_3_terr <- replace(Cohort_Master$has_3_terr, Cohort_Master$has_3_terr == '0', '')
Cohort_Master$has_3_terr <- replace(Cohort_Master$has_3_terr, Cohort_Master$has_3_terr == '1', ' ')

Cohort_Master$type <- ifelse(Cohort_Master$index_multi_terr == 1, 'Poly-vascular', Cohort_Master$type)

Cohort_Master$type <- factor(Cohort_Master$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))
Cohort_Master$weight_cat <- factor(Cohort_Master$weight_cat, levels= c('Obese', 'Overweight', 'Normal weight', 'Underweight', 'Unknown'))
Cohort_Master$ethnicity <- factor(Cohort_Master$ethnicity, levels= c('White', 'Asian', 'Black',  'Mixed', 'Unknown'))

```

```{r, include=FALSE}

#Cohort characteristics - incident

tab_inc <- table1(subset(Cohort_Master, Cohort_Master$first_year >= 2010), 
       'Sex' = Sex, 
       'Age at entry/diagnosis' = age_diag, 
       'Age at death' = age_at_death, 
       'Territory' = type, 
       'Respiratory Disease' = factor(ifelse(grepl('Respiratory Disease', Comorbidities), ' ', '')),
       'Dementia' = factor(ifelse(grepl('Dementia', Comorbidities), ' ', '')),      
       'CKD' = factor(ifelse(grepl('CKD', Comorbidities), ' ', '')),
       'Liver Disease' = factor(ifelse(grepl('Liver Disease', Comorbidities), ' ', '')),          
       'Diabetes' = factor(ifelse(grepl('Diabetes', Comorbidities), ' ', '')), 
       'Heart Failure' = factor(ifelse(grepl('Heart Failure', Comorbidities), ' ', '')),
       'Hypertension' = factor(ifelse(grepl('Hypertension', Comorbidities), ' ', '')),       
       'Smoker Status' = smoking_status,
       'Weight' = weight_cat,
       'BMI' = bmi,
       'Ethnicity' = ethnicity,
       'WIMD' = factor(wimd_2019_quintile),
        splitby = ~first_year,
        na.rm=FALSE)

tab_inc <- as.data.frame(tab_inc)
```

```{r, include=FALSE}

tab_prev <- table1(subset(Cohort_Master, Cohort_Master$first_year < 2010), 
       'Sex' = Sex, 
       'Age at entry/diagnosis' = age_entry, 
       'Age at death' = age_at_death, 
       'Territory' = type, 
       'Respiratory Disease' = factor(ifelse(grepl('Respiratory Disease', Comorbidities),' ', '')),
       'Dementia' = factor(ifelse(grepl('Dementia', Comorbidities), ' ', '')),      
       'CKD' = factor(ifelse(grepl('CKD', Comorbidities), ' ', '')),
       'Liver Disease' = factor(ifelse(grepl('Liver Disease', Comorbidities), ' ', '')),          
       'Diabetes' = factor(ifelse(grepl('Diabetes', Comorbidities), ' ', '')), 
       'Heart Failure' = factor(ifelse(grepl('Heart Failure', Comorbidities), ' ', '')),
       'Hypertension' = factor(ifelse(grepl('Hypertension', Comorbidities), ' ', '')),             
       'Smoker Status' = smoking_status,
       'Weight' = weight_cat,
       'BMI' = bmi,
       'Ethnicity' = ethnicity,
       'WIMD' = factor(wimd_2019_quintile), 
        na.rm=FALSE)

tab_prev <- as.data.frame(tab_prev)
```

```{r, include=FALSE}

tab_overall <- table1(Cohort_Master, 
       'Sex' = Sex, 
       'Age at entry/diagnosis' = ifelse(Cohort_Master$prevalent == 1,age_entry, age_diag),
       'Age at death' = age_at_death, 
       'Territory' = type, 
       'Respiratory Disease' = factor(ifelse(grepl('Respiratory Disease', Comorbidities), ' ', '')),
       'Dementia' = factor(ifelse(grepl('Dementia', Comorbidities), ' ', '')),      
       'CKD' = factor(ifelse(grepl('CKD', Comorbidities), ' ', '')),
       'Liver Disease' = factor(ifelse(grepl('Liver Disease', Comorbidities), ' ', '')),          
       'Diabetes' = factor(ifelse(grepl('Diabetes', Comorbidities), ' ', '')), 
       'Heart Failure' = factor(ifelse(grepl('Heart Failure', Comorbidities), ' ', '')),
       'Hypertension' = factor(ifelse(grepl('Hypertension', Comorbidities), ' ', '')),             
       'Smoker Status' = smoking_status,
       'Weight' = weight_cat,
       'BMI' = bmi,
       'Ethnicity' = ethnicity,
       'WIMD' = factor(wimd_2019_quintile), 
        na.rm=FALSE)

tab_overall <- as.data.frame(tab_overall)
```

```{r, include=FALSE}

#Combine prevalent and incident
tab_comb <- cbind(tab_prev['Mean.Count..SD...'], tab_inc)
tab_comb <- cbind(tab_comb, tab_overall['Mean.Count..SD...'])

#Reorder columns
tab_comb <- tab_comb[, c(2,1,3,4,5,6,7,8,9,10,11,12,13,14,15,16)]

#Rename columns
names(tab_comb)[names(tab_comb)=='Mean.Count..SD...'] <- ''
names(tab_comb)[names(tab_comb)=='Mean.Count..SD....1'] <- ''
names(tab_comb)[names(tab_comb)=='.'] <- ''

#Move names
tab_comb[7,1] <- 'Entry to study'
tab_comb[9,1] <- 'Death'
tab_comb[18,1] <- 'Respiratory Disease'
tab_comb[22,1] <- 'Dementia'
tab_comb[26,1] <- 'CKD'
tab_comb[30,1] <- 'Liver Disease'
tab_comb[34,1] <- 'Diabetes'
tab_comb[38,1] <- 'Heart Failure'
tab_comb[42,1] <- 'Hypertension'
tab_comb[48,1] <- 'Unknown'
tab_comb[71,1] <- 'Unknown'
tab_comb[71,2] <- '< 10 (0%)'

#Remove rows
tab_comb <- tab_comb[-c(2,3,5,6,8,9,10,11,12,13,14,15,16,17,19,20,21,23,24,25,27,28,29,31,32,33,35,36,37,38,39,40,41,43,44,49,55,56,58,64,65),]

rownames(tab_comb) <- NULL

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
tab_comb %>% 
  kbl(caption = 'Table 1. Cohort characteristics and comorbidities, for prevalent cases described at study start and incident cases described at entry, by year.') %>%
  pack_rows('Sex',2,2, label_row_css = 'background-color: #999; color: #fff') %>%
  pack_rows('Age (years)',3,3, label_row_css = 'background-color: #999; color: #fff') %>%
  pack_rows('Comorbidities',4,9, label_row_css = 'background-color: #999; color: #fff') %>%
  pack_rows('Smoker status',10,13, label_row_css = 'background-color: #999; color: #fff') %>%  
  pack_rows('Weight',14,18, label_row_css = 'background-color: #999; color: #fff') %>% 
  pack_rows('Body Mass Index (BMI)',19,19, label_row_css = 'background-color: #999; color: #fff') %>% 
  pack_rows('Ethnic group',20,24, label_row_css = 'background-color: #999; color: #fff') %>%  
  pack_rows('Welsh Index of Multiple Deprivation (WIMD) Quintile',25,30, label_row_css = 'background-color: #999; color: #fff') %>%  
  add_header_above(c(' '=1, 'Prevalent'=1, 'Incident'=13, 'Overall'=1)) %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  column_spec(1, border_right = T) %>%
  column_spec(2, border_right = T) %>%
  column_spec(15, border_right = T) %>%  
  footnote(general = 'Categorical descriptors are presented as the % of the cohort included in that category. Continuous descriptors are presented as mean(SD).') %>%
  kable_paper()
```

<br>
<br>

### Figure 2. Incidence & Prevalence

```{r, include=FALSE}

inc_by_terr <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.PREP_INC_PER_YEAR ORDER BY YEAR')

inc_by_terr_stack <- dplyr::select(inc_by_terr,'year', 'ihd', 'st', 'pad', 'poly')
inc_by_terr_stack <- inc_by_terr_stack %>% pivot_longer(!year, names_to = 'Territory', values_to = 'Count')

colnames(inc_by_terr_stack)[1] <- 'Year'

inc_by_terr_stack[inc_by_terr_stack == 'ihd'] <- 'IHD'
inc_by_terr_stack[inc_by_terr_stack == 'st'] <- 'Stroke'
inc_by_terr_stack[inc_by_terr_stack == 'pad'] <- 'PAD'
inc_by_terr_stack[inc_by_terr_stack == 'poly'] <- 'Poly-vascular'

inc_by_terr_stack$Territory <- factor(inc_by_terr_stack$Territory, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

```

```{r, include=FALSE}

prev_by_terr_stack <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.PREP_PREV_PER_YEAR')

prev_by_terr_stack  <- subset(prev_by_terr_stack, prev_by_terr_stack$year < 2023)
names(prev_by_terr_stack)[names(prev_by_terr_stack)=='terr'] <- 'Territory'

prev_by_terr_stack[prev_by_terr_stack == 'ST'] <- 'Stroke'
prev_by_terr_stack[prev_by_terr_stack == 'POLY'] <- 'Poly-vascular'

prev_by_terr_stack$Territory <- factor(prev_by_terr_stack$Territory, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

prev_by_terr_group <- prev_by_terr_stack %>% group_by(year) %>% summarise(total=sum(count))

```

```{r, warning=FALSE, echo=FALSE, message=FALSE}

Inc <- ggplot(data=inc_by_terr_stack, aes(x=Year, y=Count, fill=Territory, label=Count)) + 
geom_bar(position = 'stack',stat = 'identity') +
labs(x = 'Year',  y = 'Patients', title='Incidence') +
scale_x_continuous(breaks=seq(0,2022, 2)) +
scale_fill_manual(values=cbPalette) +
theme(plot.title = element_text(size = 20, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),  axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15), axis.line.x = element_line(),legend.text = element_text(size = 15), legend.title = element_text(size = 15), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')
  
```

```{r, warning=FALSE, echo=FALSE, message=FALSE}

Prev <- ggplot(data=prev_by_terr_stack, aes(x=factor(year), y=count, fill=Territory, label=count)) + 
geom_bar(position = 'stack',stat = 'identity') +
labs(x = 'Year', y = 'Patients', color = 'Legend', title = 'Prevalence') +
scale_x_discrete(breaks=seq(0,2022, 2)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 20, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 15), axis.title.x = element_text(size = 15), axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), legend.text = element_text(size = 20), legend.title = element_text(size = 20), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')

```

```{r, include=FALSE}

denominator_yr <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.PREP_DENOM_YR')

denominator_yr <- as.data.frame(t(denominator_yr)) 
denominator_yr <- rownames_to_column(denominator_yr)
colnames(denominator_yr) <- c('Year','Denom')
denominator_yr$Year <- str_replace(denominator_yr$Year, 'in_', '')
denominator_yr$Denom_100k <- denominator_yr$Denom / 100000

```

```{r, include=FALSE}

inc_by_terr_stack <- merge(inc_by_terr_stack, denominator_yr, by.x='Year', by.y = 'Year')
inc_by_terr_stack$total_Per100k <- round(inc_by_terr_stack$Count / inc_by_terr_stack$Denom_100k,0)

colnames(prev_by_terr_stack)[1] <- 'Year'
colnames(prev_by_terr_stack)[3] <- 'Count'

prev_by_terr_stack <- merge(prev_by_terr_stack, denominator_yr, by.x='Year')
prev_by_terr_stack$total_Per100k <- round(prev_by_terr_stack$Count / prev_by_terr_stack$Denom_100k,0)

```

```{r, include=FALSE}

Inc_line_100k <- ggplot(data=inc_by_terr_stack, aes(x=factor(Year), color=Territory)) + 
geom_line(aes(y=total_Per100k, group = Territory), size=1) +
geom_point(aes(y=total_Per100k, group = Territory), size=2) +
labs(x = 'Year', y = 'Patients (per 100,000)', color = 'Legend', title = 'Incidence (per 100,000)') +
scale_color_manual(values=cbPalette)+    
scale_x_discrete(breaks=seq(0,2022, 2)) +
theme(plot.title = element_text(size = 20, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), legend.text = element_text(size = 15), legend.title = element_text(size = 15), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'right')

```

```{r, include=FALSE}

Prev_line_100k <- ggplot(data=prev_by_terr_stack, aes(x=factor(Year), color=Territory)) + 
geom_line(aes(y=total_Per100k, group = Territory), size=1) +
geom_point(aes(y=total_Per100k, group = Territory), size=2) +
labs(x = 'Year', y = 'Patients (per 100,000)', color = 'Legend', title = 'Prevalence (per 100,000)') +
scale_color_manual(values=cbPalette)+ 
scale_x_discrete(breaks=seq(2010,2023,2)) +  
theme(plot.title = element_text(size = 20, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 15), axis.title.x = element_text(size = 15), axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), legend.text = element_text(size = 15), legend.title = element_text(size = 15), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

```

```{r, echo=FALSE,  fig.width=16, fig.height=12, fig.align = 'center'}

FourPanelIncPrev <- egg::ggarrange(Prev, Prev_line_100k, Inc, Inc_line_100k, ncol=2)

```

```{r, echo = FALSE}

#ggsave(filename = 'FourPanelIncPrev.tiff', plot = FourPanelIncPrev, device = 'tiff', width=15, height=10, units ='in', dpi=300, compression = 'lzw')

```

<br>
<br>


## Section 2: Trends in Lipid Treatment, Testing and Control

### Figure 3. Incident & Prevalent LLT

```{r, include=FALSE}

# Prevalent - all patients

LLT_2010_2022_PREV_ALL <- db2_run(conn = Connection, query = 'SELECT YR AS YEAR, LLT, TYPE, COUNT(LLT) AS LLT FROM SAILW1483V.TEMP_PREV_LLT GROUP BY YR, TYPE, LLT ORDER BY YR, TYPE, LLT')

LLT_2010_2022_PREV_ALL[LLT_2010_2022_PREV_ALL < 10] <- 10
LLT_2010_2022_PREV_ALL <- subset(LLT_2010_2022_PREV_ALL, LLT_2010_2022_PREV_ALL$year <= 2023)

#Rename columns
names(LLT_2010_2022_PREV_ALL)[names(LLT_2010_2022_PREV_ALL)=='llt'] <- 'LLT'
names(LLT_2010_2022_PREV_ALL)[names(LLT_2010_2022_PREV_ALL)=='llt_1'] <- 'Count'

LLT_2010_2022_PREV_ALL$LLT <- replace(LLT_2010_2022_PREV_ALL$LLT, LLT_2010_2022_PREV_ALL$LLT == 'HIGH_STATIN', 'High-intensity statin')
LLT_2010_2022_PREV_ALL$LLT <- replace(LLT_2010_2022_PREV_ALL$LLT, LLT_2010_2022_PREV_ALL$LLT == 'LOW_STATIN', 'Non-high-intensity statin')
LLT_2010_2022_PREV_ALL$LLT <- replace(LLT_2010_2022_PREV_ALL$LLT, LLT_2010_2022_PREV_ALL$LLT == 'NOTX', 'No treatment')
LLT_2010_2022_PREV_ALL$LLT <- replace(LLT_2010_2022_PREV_ALL$LLT, LLT_2010_2022_PREV_ALL$LLT == 'INEGY', 'Combination statin')
LLT_2010_2022_PREV_ALL$LLT <- replace(LLT_2010_2022_PREV_ALL$LLT, LLT_2010_2022_PREV_ALL$LLT == 'STATIN_COMBI', 'Combination statin')
LLT_2010_2022_PREV_ALL$LLT <- replace(LLT_2010_2022_PREV_ALL$LLT, LLT_2010_2022_PREV_ALL$LLT == 'OTHER', 'Other treatment')
LLT_2010_2022_PREV_ALL$type <- replace(LLT_2010_2022_PREV_ALL$type, LLT_2010_2022_PREV_ALL$type == 'ST', 'Stroke')
LLT_2010_2022_PREV_ALL$type <- replace(LLT_2010_2022_PREV_ALL$type, LLT_2010_2022_PREV_ALL$type == 'POLY', 'Poly-vascular')

colnames(LLT_2010_2022_PREV_ALL)[4] <- 'Treated'

LLT_2010_2022_PREV_ALL$LLT <- factor(LLT_2010_2022_PREV_ALL$LLT, levels= c('Combination statin', 'High-intensity statin', 'Non-high-intensity statin', 'Other treatment', 'No treatment'))

LLT_2010_PREV_ALL <- subset(subset(LLT_2010_2022_PREV_ALL, year == 2010), !is.na(year))
LLT_2022_PREV_ALL <- subset(subset(LLT_2010_2022_PREV_ALL, year == 2022), !is.na(year))

LLT_2010_PREV_ALL[LLT_2010_PREV_ALL == 'ST'] <- 'Stroke'
LLT_2010_PREV_ALL[LLT_2010_PREV_ALL == 'POLY'] <- 'Poly-vascular'
LLT_2010_PREV_ALL$type <- factor(LLT_2010_PREV_ALL$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

LLT_2022_PREV_ALL[LLT_2022_PREV_ALL == 'ST'] <- 'Stroke'
LLT_2022_PREV_ALL[LLT_2022_PREV_ALL == 'POLY'] <- 'Poly-vascular'
LLT_2022_PREV_ALL$type <- factor(LLT_2022_PREV_ALL$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

LLT_2010_IHD_PREV_ALL <- subset(LLT_2010_PREV_ALL, type == 'IHD')
LLT_2010_ST_PREV_ALL <-  subset(LLT_2010_PREV_ALL, type == 'Stroke')
LLT_2010_PAD_PREV_ALL <- subset(LLT_2010_PREV_ALL, type == 'PAD')
LLT_2010_Poly_PREV_ALL <- subset(LLT_2010_PREV_ALL, type == 'Poly-vascular')
LLT_2022_IHD_PREV_ALL <- subset(LLT_2022_PREV_ALL, type == 'IHD')
LLT_2022_ST_PREV_ALL <-  subset(LLT_2022_PREV_ALL, type == 'Stroke')
LLT_2022_PAD_PREV_ALL <- subset(LLT_2022_PREV_ALL, type == 'PAD')
LLT_2022_Poly_PREV_ALL <- subset(LLT_2022_PREV_ALL, type == 'Poly-vascular')

```


```{r, include=FALSE}

#Incident

LLT_2010_2021 <- db2_run(conn = Connection, query = 'SELECT DRUG_YR AS YEAR, LLT, TYPE, COUNT(LLT) AS LLT FROM SAILW1483V.TEMP_INC_LLT GROUP BY DRUG_YR, TYPE, LLT ORDER BY DRUG_YR, TYPE, LLT')

LLT_2010_2021[LLT_2010_2021 < 10] <- 10
LLT_2010_2021 <- subset(LLT_2010_2021, LLT_2010_2021$year < 2022)

#Rename columns
names(LLT_2010_2021)[names(LLT_2010_2021)=='llt'] <- 'LLT'
names(LLT_2010_2021)[names(LLT_2010_2021)=='llt_1'] <- 'Count'

LLT_2010_2021$LLT <- replace(LLT_2010_2021$LLT, LLT_2010_2021$LLT == 'HIGH_STATIN', 'High-intensity statin')
LLT_2010_2021$LLT <- replace(LLT_2010_2021$LLT, LLT_2010_2021$LLT == 'LOW_STATIN', 'Non-high-intensity statin')
LLT_2010_2021$LLT <- replace(LLT_2010_2021$LLT, LLT_2010_2021$LLT == 'NOTX', 'No treatment')
LLT_2010_2021$LLT <- replace(LLT_2010_2021$LLT, LLT_2010_2021$LLT == 'INEGY', 'Combination statin')
LLT_2010_2021$LLT <- replace(LLT_2010_2021$LLT, LLT_2010_2021$LLT == 'STATIN_COMBI', 'Combination statin')
LLT_2010_2021$LLT <- replace(LLT_2010_2021$LLT, LLT_2010_2021$LLT == 'OTHER', 'Other treatment')
LLT_2010_2021$type <- replace(LLT_2010_2021$type, LLT_2010_2021$type == 'ST', 'Stroke')
LLT_2010_2021$type <- replace(LLT_2010_2021$type, LLT_2010_2021$type == 'POLY', 'Poly-vascular')

colnames(LLT_2010_2021)[4] <- 'Treated'

LLT_2010_2021$LLT <- factor(LLT_2010_2021$LLT, levels= c('Combination statin', 'High-intensity statin', 'Non-high-intensity statin', 'Other treatment', 'No treatment'))

LLT_2010 <- subset(subset(LLT_2010_2021, year == 2010), !is.na(year))
LLT_2021 <- subset(subset(LLT_2010_2021, year == 2021), !is.na(year))

LLT_2010[LLT_2010 == 'ST'] <- 'Stroke'
LLT_2010[LLT_2010 == 'POLY'] <- 'Poly-vascular'
LLT_2010$type <- factor(LLT_2010$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

LLT_2021[LLT_2021 == 'ST'] <- 'Stroke'
LLT_2021[LLT_2021 == 'POLY'] <- 'Poly-vascular'
LLT_2021$type <- factor(LLT_2021$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

LLT_2010_IHD <- subset(LLT_2010, type == 'IHD')
LLT_2010_ST <-  subset(LLT_2010, type == 'Stroke')
LLT_2010_PAD <- subset(LLT_2010, type == 'PAD')
LLT_2010_Poly <- subset(LLT_2010, type == 'Poly-vascular')
LLT_2021_IHD <- subset(LLT_2021, type == 'IHD')
LLT_2021_ST <-  subset(LLT_2021, type == 'Stroke')
LLT_2021_PAD <- subset(LLT_2021, type == 'PAD')
LLT_2021_Poly <- subset(LLT_2021, type == 'Poly-vascular')

```

```{r, include=FALSE}

# 2010 - All patients
LLT_2010_PREV_ALL_grouped <- LLT_2010_PREV_ALL %>% group_by(LLT) %>% summarise(treated = sum(Treated), year= min(year))

Treat_2010_PREV_ALL <- ggplot(data=LLT_2010_PREV_ALL_grouped, aes(x=year, y=treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'All patients', y = 'Proportion', title = '2010', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 11), axis.title.x = element_text(size = 11),  axis.text.y = element_text(size = 10), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')

# 2010 - IHD
IHD_Treat_2010_PREV_ALL <- ggplot(data=LLT_2010_IHD_PREV_ALL, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'IHD', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 11), axis.title.x = element_text(size = 11),  axis.text.y = element_text(size = 10), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')

# 2010 - ST
ST_Treat_2010_PREV_ALL <- ggplot(data=LLT_2010_ST_PREV_ALL, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'Stroke', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022,1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 11), axis.title.x = element_text(size = 11),  axis.text.y = element_text(size = 10), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')

# 2010 - PAD
PAD_Treat_2010_PREV_ALL <- ggplot(data=LLT_2010_PAD_PREV_ALL, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'PAD', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 11), axis.title.x = element_text(size = 11), axis.text.y = element_text(size = 10), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')

# 2010 - Poly
Poly_Treat_2010_PREV_ALL <- ggplot(data=LLT_2010_Poly_PREV_ALL, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'Poly-vascular', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+  
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 11), axis.title.x = element_text(size = 11), axis.text.y = element_text(size = 10), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')

# 2022 - All patients
LLT_2022_PREV_ALL_grouped <- LLT_2022_PREV_ALL %>% group_by(LLT) %>% summarise(treated = sum(Treated), year= min(year))

Treat_2022_PREV_ALL <- ggplot(data=LLT_2022_PREV_ALL_grouped, aes(x=year, y=treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'All patients', y = 'Patients', title = '2022', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank(), axis.title.x = element_text(size = 11),  axis.text.y = element_blank(), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_blank(), axis.ticks.y = element_blank(), panel.background = element_blank(), legend.position = 'none')

# 2022 - IHD
IHD_Treat_2022_PREV_ALL <- ggplot(data=LLT_2022_IHD_PREV_ALL, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'IHD', y = 'Patients', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank(), axis.title.x = element_text(size = 11),  axis.text.y = element_blank(), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_blank(), axis.ticks.y = element_blank(), panel.background = element_blank(), legend.position = 'none')

# 2022 - ST
ST_Treat_2022_PREV_ALL <- ggplot(data=LLT_2022_ST_PREV_ALL, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'Stroke', y = 'Patients', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank(), axis.title.x = element_text(size = 11),  axis.text.y = element_blank(), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_blank(), axis.ticks.y = element_blank(), panel.background = element_blank())

# 2022 - PAD
PAD_Treat_2022_PREV_ALL <- ggplot(data=LLT_2022_PAD_PREV_ALL, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'PAD', y = 'Patients', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank(), axis.title.x = element_text(size = 11),  axis.text.y = element_blank(), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_blank(), axis.ticks.y = element_blank(), panel.background = element_blank(), legend.position = 'none')

# 2022 - Poly
Poly_Treat_2022_PREV_ALL <- ggplot(data=LLT_2022_Poly_PREV_ALL, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'Poly-vascular', y = 'Patients', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank(), axis.title.x = element_text(size = 11), axis.text.y = element_blank(), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_blank(), axis.ticks.y = element_blank(), panel.background = element_blank(), legend.position = 'none')

```

```{r, include=FALSE}

PREV_ALL_Treat <- Treat_2010_PREV_ALL + Treat_2022_PREV_ALL + IHD_Treat_2010_PREV_ALL + IHD_Treat_2022_PREV_ALL + ST_Treat_2010_PREV_ALL + ST_Treat_2022_PREV_ALL + PAD_Treat_2010_PREV_ALL + PAD_Treat_2022_PREV_ALL + Poly_Treat_2010_PREV_ALL + Poly_Treat_2022_PREV_ALL + plot_layout(ncol=2) + plot_annotation(title = 'Prevalent', theme=theme(plot.title = element_text(hjust = 0.3, size = 17)))

```

```{r, include=FALSE}

# 2010 - All patients
LLT_2010_grouped <- LLT_2010 %>% group_by(LLT) %>% summarise(treated = sum(Treated), year= min(year))

Treat_2010 <- ggplot(data=LLT_2010_grouped, aes(x=year, y=treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'All patients', y = 'Proportion', title = '2010', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.x = element_text(size = 11),  axis.text.y = element_text(size = 10), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')

# 2010 - IHD
IHD_Treat_2010 <- ggplot(data=LLT_2010_IHD, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'IHD', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.x = element_text(size = 11),  axis.text.y = element_text(size = 10), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')

# 2010 - ST
ST_Treat_2010 <- ggplot(data=LLT_2010_ST, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'Stroke', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.x = element_text(size = 11),  axis.text.y = element_text(size = 10), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')

# 2010 - PAD
PAD_Treat_2010 <- ggplot(data=LLT_2010_PAD, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'PAD', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.x = element_text(size = 11),  axis.text.y = element_text(size = 10), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')

# 2010 - Poly
Poly_Treat_2010 <- ggplot(data=LLT_2010_Poly, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'Poly-vascular', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),  axis.title.x = element_text(size = 11), axis.text.y = element_text(size = 10), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')

# 2021 - All patients
LLT_2021_grouped <- LLT_2021 %>% group_by(LLT) %>% summarise(treated = sum(Treated), year= min(year))

Treat_2021 <- ggplot(data=LLT_2021_grouped, aes(x=year, y=treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'All patients', y = 'Proportion', title = '2021', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank(), axis.title.x = element_text(size = 11),  axis.text.y = element_blank(), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(),  axis.line.y = element_blank(), axis.ticks.y = element_blank(), panel.background = element_blank(), legend.position = 'none')

# 2021 - IHD
IHD_Treat_2021 <- ggplot(data=LLT_2021_IHD, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'IHD', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank(), axis.title.x = element_text(size = 11),  axis.text.y = element_blank(), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(),  axis.line.y = element_blank(), axis.ticks.y = element_blank(), panel.background = element_blank(), legend.position = 'none')

# 2021 - ST
ST_Treat_2021 <- ggplot(data=LLT_2021_ST, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'Stroke', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank(), axis.title.x = element_text(size = 11),  axis.text.y = element_blank(), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(),  axis.line.y = element_blank(), axis.ticks.y = element_blank(), panel.background = element_blank())

# 2021 - PAD
PAD_Treat_2021 <- ggplot(data=LLT_2021_PAD, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'PAD', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank(), axis.title.x = element_text(size = 11),  axis.text.y = element_blank(), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(),  axis.line.y = element_blank(), axis.ticks.y = element_blank(), panel.background = element_blank(), legend.position = 'none')

# 2021 - Poly
Poly_Treat_2021 <- ggplot(data=LLT_2021_Poly, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'Poly-vascular', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_fill_manual(values=cbPalette)+
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.x = element_text(size = 11), axis.title.y = element_blank(), axis.text.y = element_blank(), axis.text.x = element_blank(), legend.text = element_text(size = 10), legend.title = element_text(size = 11),  axis.line.x = element_line(), axis.line.y = element_blank(), axis.ticks.y = element_blank(), panel.background = element_blank(), legend.position = 'none')

```

```{r, include=FALSE}

INC_Treat <- Treat_2010 + Treat_2021 + IHD_Treat_2010 + IHD_Treat_2021 + ST_Treat_2010 + ST_Treat_2021 + PAD_Treat_2010 + PAD_Treat_2021 + Poly_Treat_2010 + Poly_Treat_2021 + plot_layout(ncol=2) + plot_annotation(title = 'Incident', theme=theme(plot.title = element_text(hjust = 0.3, size = 17)))

```

```{r, echo=FALSE, fig.width=7, fig.height=10, fig.align = 'center', message=FALSE, warning=FALSE}

PREV_ALL_Treat

```

```{r, echo = FALSE}

#ggsave(filename = 'PREV_ALL_Treat.tiff', plot = PREV_ALL_Treat, device = 'tiff', width=6, height=10, units ='in', dpi=300, compression = 'lzw')

```

<br>
<br>

```{r, echo=FALSE, fig.width=7, fig.height=10, fig.align = 'center', message=FALSE, warning=FALSE}

INC_Treat

```

```{r, echo = FALSE}

#ggsave(filename = 'INC_Treat.tiff', plot = INC_Treat, device = 'tiff', width=6, height=10, units ='in', dpi=300, compression = 'lzw')

```

<br>
<br>

```{r, include=FALSE}

#Prevalent treated per year
names(LLT_2010_2022_PREV_ALL)[names(LLT_2010_2022_PREV_ALL)=='year'] <- 'Year'
LLT_2010_2022_PREV_ALL_Denom <- LLT_2010_2022_PREV_ALL %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))

#Incident treated per year
names(LLT_2010_2021)[names(LLT_2010_2021)=='year'] <- 'Year'
LLT_2010_2021_Denom <- LLT_2010_2021 %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))

#IHD
LLT_2010_2022_PREV_ALL_IHD <- subset(LLT_2010_2022_PREV_ALL, LLT_2010_2022_PREV_ALL$type == 'IHD')
LLT_2010_2022_PREV_ALL_Denom_IHD <- LLT_2010_2022_PREV_ALL_IHD %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_2010_2021_IHD <- subset(LLT_2010_2021, LLT_2010_2021$type == 'IHD')
LLT_2010_2021_Denom_IHD <- LLT_2010_2021_IHD %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))

#ST
LLT_2010_2022_PREV_ALL_ST <- subset(LLT_2010_2022_PREV_ALL, LLT_2010_2022_PREV_ALL$type == 'Stroke')
LLT_2010_2022_PREV_ALL_Denom_ST <- LLT_2010_2022_PREV_ALL_ST %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_2010_2021_ST <- subset(LLT_2010_2021, LLT_2010_2021$type == 'Stroke')
LLT_2010_2021_Denom_ST <- LLT_2010_2021_ST %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))

#PAD
LLT_2010_2022_PREV_ALL_PAD <- subset(LLT_2010_2022_PREV_ALL, LLT_2010_2022_PREV_ALL$type == 'PAD')
LLT_2010_2022_PREV_ALL_Denom_PAD <- LLT_2010_2022_PREV_ALL_PAD %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_2010_2021_PAD <- subset(LLT_2010_2021, LLT_2010_2021$type == 'PAD')
LLT_2010_2021_Denom_PAD <- LLT_2010_2021_PAD %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))

#POLY
LLT_2010_2022_PREV_ALL_POLY <- subset(LLT_2010_2022_PREV_ALL, LLT_2010_2022_PREV_ALL$type == 'Poly-vascular')
LLT_2010_2022_PREV_ALL_Denom_POLY <- LLT_2010_2022_PREV_ALL_POLY %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_2010_2021_POLY <- subset(LLT_2010_2021, LLT_2010_2021$type == 'Poly-vascular')
LLT_2010_2021_Denom_POLY <- LLT_2010_2021_POLY %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))

names(LLT_2010_2022_PREV_ALL)[names(LLT_2010_2022_PREV_ALL)=='Year'] <- 'year'
names(LLT_2010_2021)[names(LLT_2010_2021)=='Year'] <- 'year'

```

```{r, include=FALSE}

#Prev
LLT_2010_2022_PREV_ALL_Denom_IHD$Territory <- 'IHD'
Denom_df_prev <- LLT_2010_2022_PREV_ALL_Denom_IHD

LLT_2010_2022_PREV_ALL_Denom_ST$Territory <- 'Stroke'
Denom_df_prev <- rbind(Denom_df_prev, LLT_2010_2022_PREV_ALL_Denom_ST)

LLT_2010_2022_PREV_ALL_Denom_PAD$Territory <- 'PAD'
Denom_df_prev <- rbind(Denom_df_prev, LLT_2010_2022_PREV_ALL_Denom_PAD)

LLT_2010_2022_PREV_ALL_Denom_POLY$Territory <- 'Poly-vascular'
Denom_df_prev <- rbind(Denom_df_prev, LLT_2010_2022_PREV_ALL_Denom_POLY)

#Inc
LLT_2010_2021_Denom_IHD$Territory <- 'IHD'
Denom_df_inc <- LLT_2010_2021_Denom_IHD

LLT_2010_2021_Denom_ST$Territory <- 'Stroke'
Denom_df_inc <- rbind(Denom_df_inc, LLT_2010_2021_Denom_ST)

LLT_2010_2021_Denom_PAD$Territory <- 'PAD'
Denom_df_inc <- rbind(Denom_df_inc, LLT_2010_2021_Denom_PAD)

LLT_2010_2021_Denom_POLY$Territory <- 'Poly-vascular'
Denom_df_inc <- rbind(Denom_df_inc, LLT_2010_2021_Denom_POLY)

```

### Figure 4. LDL-C Documented per year

```{r, include=FALSE}

Lipid_Test_Per_Year_LDL_GP <- db2_run(conn = Connection, query = 'SELECT ALF_PE, YEAR(DIAG) AS YEAR, TYPE FROM SAILW1483V.TEMP_LDL_CONTROL')
Lipid_Test_Per_Year_Prev_LDL_GP <- db2_run(conn = Connection, query = 'SELECT ALF_PE, YEAR(TEST) AS YEAR, TYPE FROM SAILW1483V.TEMP_LDL_CONTROL_PREV')

Lipid_Test_Per_Year_Inc_LDL_GP <- Lipid_Test_Per_Year_LDL_GP %>% group_by(year, type) %>% summarise(n=n())
Lipid_Test_Per_Year_Prev_LDL_GP <- Lipid_Test_Per_Year_Prev_LDL_GP %>% group_by(year, type) %>% summarise(n=n())

colnames(Lipid_Test_Per_Year_Prev_LDL_GP)[1] <- 'Year'
colnames(Lipid_Test_Per_Year_Prev_LDL_GP)[2] <- 'Territory'
colnames(Lipid_Test_Per_Year_Prev_LDL_GP)[3] <- 'Count'

colnames(Lipid_Test_Per_Year_Inc_LDL_GP)[1] <- 'Year'
colnames(Lipid_Test_Per_Year_Inc_LDL_GP)[2] <- 'Territory'
colnames(Lipid_Test_Per_Year_Inc_LDL_GP)[3] <- 'Count'

Lipid_Test_Per_Year_Prev_LDL_GP[Lipid_Test_Per_Year_Prev_LDL_GP == 'ST'] <- 'Stroke'
Lipid_Test_Per_Year_Prev_LDL_GP[Lipid_Test_Per_Year_Prev_LDL_GP == 'POLY'] <- 'Poly-vascular'
Lipid_Test_Per_Year_Prev_LDL_GP$Territory <- factor(Lipid_Test_Per_Year_Prev_LDL_GP$Territory, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

Lipid_Test_Per_Year_Inc_LDL_GP[Lipid_Test_Per_Year_Inc_LDL_GP == 'ST'] <- 'Stroke'
Lipid_Test_Per_Year_Inc_LDL_GP[Lipid_Test_Per_Year_Inc_LDL_GP == 'POLY'] <- 'Poly-vascular'
Lipid_Test_Per_Year_Inc_LDL_GP$Territory <- factor(Lipid_Test_Per_Year_Inc_LDL_GP$Territory, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

```

```{r, include=FALSE}

Lipid_Test_Per_Year_Inc_LDL_GP <- inner_join(x=Lipid_Test_Per_Year_Inc_LDL_GP, y=Denom_df_inc, by = c('Year' = 'Year', 'Territory' = 'Territory'))
colnames(Lipid_Test_Per_Year_Inc_LDL_GP)[3] <- 'Tested'
colnames(Lipid_Test_Per_Year_Inc_LDL_GP)[4] <- 'Incidence'
Lipid_Test_Per_Year_Inc_LDL_GP$pct_tested <- round((Lipid_Test_Per_Year_Inc_LDL_GP$Tested / Lipid_Test_Per_Year_Inc_LDL_GP$Incidence) * 100,2)
prev_by_terr_stack$Year <- as.numeric(prev_by_terr_stack$Year)

Lipid_Test_Per_Year_Prev_LDL_GP <- inner_join(x=Lipid_Test_Per_Year_Prev_LDL_GP, y=Denom_df_prev, by = c('Year' = 'Year', 'Territory' = 'Territory'))
colnames(Lipid_Test_Per_Year_Prev_LDL_GP)[3] <- 'Tested'
colnames(Lipid_Test_Per_Year_Prev_LDL_GP)[4] <- 'Prevalence'
Lipid_Test_Per_Year_Prev_LDL_GP$pct_tested <- round((Lipid_Test_Per_Year_Prev_LDL_GP$Tested / Lipid_Test_Per_Year_Prev_LDL_GP$Prevalence) * 100,2)

```

```{r, include=FALSE}

Overall_Prev_LDL_GP_pct <- Lipid_Test_Per_Year_Prev_LDL_GP %>% group_by(Year) %>% summarise(Tested = sum(Tested), Prevalence = sum(Prevalence))
Overall_Prev_LDL_GP_pct$pct_tested <- round((Overall_Prev_LDL_GP_pct$Tested / Overall_Prev_LDL_GP_pct$Prevalence) * 100,2)
Overall_Prev_LDL_GP_pct$Territory <- 'Overall'

Lipid_Test_Per_Year_Prev_LDL_GP_Calc <- rbind(dplyr::select(Lipid_Test_Per_Year_Prev_LDL_GP, Year, Territory, pct_tested, Tested, Prevalence), Overall_Prev_LDL_GP_pct)

Lipid_Test_Per_Year_Prev_LDL_GP_Calc$Territory <- factor(Lipid_Test_Per_Year_Prev_LDL_GP_Calc$Territory, levels= c('Overall', 'IHD', 'Stroke', 'PAD', 'Poly-vascular'))

```

```{r, include=FALSE}

Prev_LDL_Test_Plot_df <- subset(Lipid_Test_Per_Year_Prev_LDL_GP_Calc, Year <= 2022)
Prev_LDL_Test_Plot_df$line_type <- ifelse(Prev_LDL_Test_Plot_df$Territory == 'Overall', 0, 1)

Prev_LDL_GP_test_pct <- ggplot(data=Prev_LDL_Test_Plot_df, aes(x=Year, y=pct_tested, label=pct_tested)) + 
geom_line(aes(y=pct_tested, group = Territory, colour = Territory, linetype = factor(line_type)), size=1, show_guide = FALSE) +
geom_point(aes(y=pct_tested, group = Territory, colour = Territory), size=2) +
labs(x = 'Year', y = '% of Patients tested', title='Prevalent') +
scale_linetype_manual(values = c('dashed', 'solid'))+
scale_x_continuous(breaks=seq(0,2022, 1)) +
scale_color_manual(values=cbPalette_Overall)+  
ylim(0,100) +
theme(plot.title = element_text(size = 20, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 15), axis.title.x = element_text(size = 15), axis.text.y = element_text(size = 15), axis.text.x = element_text(size = 15), legend.text = element_text(size = 20), legend.title = element_text(size = 20), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')

```

```{r, include=FALSE}

Prev_LDL_GP_test_pct_text<- ggplot(data=subset(Lipid_Test_Per_Year_Prev_LDL_GP_Calc, Year <= 2022), aes(x=Year, y=factor(Territory, levels= c('Poly-vascular', 'PAD', 'Stroke', 'IHD', 'Overall')), label=Prevalence, colour = Territory)) + 
geom_text(size= 5) + 
theme_bw() + 
labs(x = 'Prevalence (full year follow-up)') +  
scale_x_continuous(breaks=seq(0,2022, 2)) +
scale_y_discrete(position='left') +
scale_color_manual(values=cbPalette_Overall)+  
theme_minimal() + 
theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line.x = element_blank(), axis.line.y = element_blank(), element_blank(), axis.title.x = element_text(size = 15), axis.text.x = element_blank(), axis.title.y = element_blank(), axis.text.y = element_text(size=14), panel.background = element_blank(), legend.position = 'none')

```

```{r, include=FALSE}

Overall_Inc_LDL_GP_pct <- Lipid_Test_Per_Year_Inc_LDL_GP %>% group_by(Year) %>% summarise(Tested = sum(Tested), Incidence = sum(Incidence))
Overall_Inc_LDL_GP_pct$pct_tested <- round((Overall_Inc_LDL_GP_pct$Tested / Overall_Inc_LDL_GP_pct$Incidence) * 100,2)
Overall_Inc_LDL_GP_pct$Territory <- 'Overall'

Lipid_Test_Per_Year_Inc_LDL_GP_Calc <- rbind(dplyr::select(Lipid_Test_Per_Year_Inc_LDL_GP, Year, Territory, pct_tested, Tested, Incidence), Overall_Inc_LDL_GP_pct)

Lipid_Test_Per_Year_Inc_LDL_GP_Calc$Territory <- factor(Lipid_Test_Per_Year_Inc_LDL_GP_Calc$Territory, levels= c('Overall', 'IHD', 'Stroke', 'PAD', 'Poly-vascular'))

```

```{r, include=FALSE}

Inc_LDL_Test_Plot_df <- subset(Lipid_Test_Per_Year_Inc_LDL_GP_Calc, Year < 2022)
Inc_LDL_Test_Plot_df$line_type <- ifelse(Inc_LDL_Test_Plot_df$Territory == 'Overall', 0, 1)

Inc_LDL_GP_test_pct <- ggplot(data=Inc_LDL_Test_Plot_df, aes(x=Year, y=pct_tested, label=pct_tested)) + 
geom_line(aes(y=pct_tested, group = Territory, colour = Territory, linetype = factor(line_type)), size=1, show_guide = FALSE) +
geom_point(aes(y=pct_tested, group = Territory, colour = Territory), size=2) +
labs(x = 'Year', y = '% of Patients tested', title='Incident') +
scale_linetype_manual(values = c('dashed', 'solid'))+
scale_x_continuous(breaks=seq(0,2021, 1)) +
scale_y_continuous(position = 'right') + 
ylim(0,100) +
scale_color_manual(values=cbPalette_Overall)+   
theme(plot.title = element_text(size = 20, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),  axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15), axis.line.x = element_line(),legend.text = element_text(size = 15), legend.title = element_text(size = 15), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'right') 

```

```{r, include=FALSE}

Inc_LDL_GP_test_pct_text<- ggplot(data=subset(Lipid_Test_Per_Year_Inc_LDL_GP_Calc, Year < 2022), aes(x=Year, y=factor(Territory, levels= c('Poly-vascular', 'PAD', 'Stroke', 'IHD', 'Overall')), label=Incidence, colour = Territory)) + 
geom_text(size= 5) + 
theme_bw() + 
labs(x = 'Incidence (full year follow-up)') +  
scale_x_continuous(breaks=seq(0,2021, 2)) +
scale_color_manual(values=cbPalette_Overall)+  
theme_minimal() + 
theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line.y = element_blank(), axis.title.y = element_blank(), axis.text.y = element_blank(), axis.text.x = element_blank(), axis.title.x = element_text(size = 15), panel.background = element_blank(), legend.position = 'none')

```

```{r, echo=FALSE,  fig.width=24, fig.height=10, fig.align = 'center'}

LDL_Test_Plot <- egg::ggarrange(Prev_LDL_GP_test_pct, Inc_LDL_GP_test_pct, Prev_LDL_GP_test_pct_text, Inc_LDL_GP_test_pct_text, ncol=2, heights=c(4,1))

```

```{r, echo = FALSE}

#ggsave(filename = 'LDL_Test_Plot.tiff', plot = LDL_Test_Plot, device = 'tiff', width=24, height=10, units ='in', dpi=300, compression = 'lzw')

```

<br>
<br>

### Figure 5. LDL-C Control 

```{r, include=FALSE}

MIN_LDL_Test_2010_2022_PREV <- db2_run(conn = Connection, query = 'SELECT year(TEST) AS event_year, type, MIN_LDL AS MIN_LDL FROM SAILW1483V.TEMP_LDL_CONTROL_PREV WHERE MIN_LDL <= 10')
MIN_LDL_Test_2010_PREV <- subset(subset(MIN_LDL_Test_2010_2022_PREV, event_year == 2010), !is.na(event_year))
MIN_LDL_Test_2022_PREV <- subset(subset(MIN_LDL_Test_2010_2022_PREV, event_year == 2022), !is.na(event_year))

MIN_LDL_Test_2010_PREV[MIN_LDL_Test_2010_PREV == 'ST'] <- 'Stroke'
MIN_LDL_Test_2010_PREV[MIN_LDL_Test_2010_PREV == 'POLY'] <- 'Poly-vascular'
MIN_LDL_Test_2010_PREV$type <- factor(MIN_LDL_Test_2010_PREV$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

MIN_LDL_Test_2022_PREV[MIN_LDL_Test_2022_PREV== 'ST'] <- 'Stroke'
MIN_LDL_Test_2022_PREV[MIN_LDL_Test_2022_PREV== 'POLY'] <- 'Poly-vascular'
MIN_LDL_Test_2022_PREV$type <- factor(MIN_LDL_Test_2022_PREV$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

MIN_LDL_Test_2010_IHD_PREV <- subset(MIN_LDL_Test_2010_PREV, type == 'IHD')
MIN_LDL_Test_2010_ST_PREV <-  subset(MIN_LDL_Test_2010_PREV, type == 'Stroke')
MIN_LDL_Test_2010_PAD_PREV <- subset(MIN_LDL_Test_2010_PREV, type == 'PAD')
MIN_LDL_Test_2010_Poly_PREV <- subset(MIN_LDL_Test_2010_PREV, type == 'Poly-vascular')
MIN_LDL_Test_2022_IHD_PREV <- subset(MIN_LDL_Test_2022_PREV, type == 'IHD')
MIN_LDL_Test_2022_ST_PREV <-  subset(MIN_LDL_Test_2022_PREV, type == 'Stroke')
MIN_LDL_Test_2022_PAD_PREV <- subset(MIN_LDL_Test_2022_PREV, type == 'PAD')
MIN_LDL_Test_2022_Poly_PREV <- subset(MIN_LDL_Test_2022_PREV, type == 'Poly-vascular')

```


```{r, include=FALSE}

L<-seq(0,4,0.001)

#2010 - All patients
LDL_2010_min_PREV<-MIN_LDL_Test_2010_PREV$min_ldl
y<-ecdf(LDL_2010_min_PREV)(L)
LDL_2010_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_S <- ggplot(LDL_2010_min_PREV,aes(x=L,y=y))+
labs(title='2010')+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4)) +
geom_vline(xintercept=1.8,linetype="dashed")+
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(plot.title = element_text(size = 15, hjust=0.5),panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - IHD
LDL_2010_IHD_min_PREV<-MIN_LDL_Test_2010_IHD_PREV$min_ldl
y<-ecdf(LDL_2010_IHD_min_PREV)(L)
df_LDL_2010_IHD_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_IHD_S <- ggplot(df_LDL_2010_IHD_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[2])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8), axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - ST
LDL_2010_ST_min_PREV<-MIN_LDL_Test_2010_ST_PREV$min_ldl
y<-ecdf(LDL_2010_ST_min_PREV)(L)
df_LDL_2010_ST_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_ST_S <- ggplot(df_LDL_2010_ST_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[3])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+  
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - PAD
LDL_2010_PAD_min_PREV<-MIN_LDL_Test_2010_PAD_PREV$min_ldl
y<-ecdf(LDL_2010_PAD_min_PREV)(L)
df_LDL_2010_PAD_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_PAD_S <- ggplot(df_LDL_2010_PAD_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[4])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+  
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - Poly
LDL_2010_Poly_min_PREV<-MIN_LDL_Test_2010_Poly_PREV$min_ldl
y<-ecdf(LDL_2010_Poly_min_PREV)(L)
df_LDL_2010_Poly_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_Poly_S <- ggplot(df_LDL_2010_Poly_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[5])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+  
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8), axis.title.y = element_text(face="bold",family="Arial",size=8))


#2022 - All patients
LDL_2022_min_PREV<-MIN_LDL_Test_2022_PREV$min_ldl
y<-ecdf(LDL_2022_min_PREV)(L)
LDL_2022_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2022_S <- ggplot(LDL_2022_min_PREV,aes(x=L,y=y))+
labs(title='2022')+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+  
theme(plot.title = element_text(size = 15, hjust=0.5),panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2022 - IHD
LDL_2022_IHD_min_PREV<-MIN_LDL_Test_2022_IHD_PREV$min_ldl
y<-ecdf(LDL_2022_IHD_min_PREV)(L)
df_LDL_2022_IHD_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2022_IHD_S <- ggplot(df_LDL_2022_IHD_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[2])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2022 - ST
LDL_2022_ST_min_PREV<-MIN_LDL_Test_2022_ST_PREV$min_ldl
y<-ecdf(LDL_2022_ST_min_PREV)(L)
df_LDL_2022_ST_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2022_ST_S <- ggplot(df_LDL_2022_ST_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[3])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2022 - PAD
LDL_2022_PAD_min_PREV<-MIN_LDL_Test_2022_PAD_PREV$min_ldl
y<-ecdf(LDL_2022_PAD_min_PREV)(L)
df_LDL_2022_PAD_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2022_PAD_S <- ggplot(df_LDL_2022_PAD_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[4])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+   
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2022 - Poly
LDL_2022_Poly_min_PREV<-MIN_LDL_Test_2022_Poly_PREV$min_ldl
y<-ecdf(LDL_2022_Poly_min_PREV)(L)
df_LDL_2022_Poly_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2022_Poly_S <- ggplot(df_LDL_2022_Poly_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[5])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., name = 'Poly-vascular', breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

```

```{r, echo=FALSE, fig.width=5, fig.height=10, fig.align = 'center', message=FALSE, warning=FALSE}

LDL_S_Prev <- LDL_2010_S + LDL_2022_S + LDL_2010_IHD_S + LDL_2022_IHD_S + LDL_2010_ST_S + LDL_2022_ST_S + LDL_2010_PAD_S + LDL_2022_PAD_S + LDL_2010_Poly_S + LDL_2022_Poly_S + plot_layout(ncol = 2) + plot_annotation(title = 'Prevalent', theme=theme(plot.title = element_text(hjust = 0.5, size = 17)))

LDL_S_Prev

```

```{r, echo = FALSE}

#ggsave(filename = 'LDL_S_Prev.tiff', plot = LDL_S_Prev, device = 'tiff', width=5, height=12, units ='in', dpi=300, compression = 'lzw')

```

<br>
<br>


```{r, include=FALSE}

MIN_LDL_Test_2010_2021 <- db2_run(conn = Connection, query = 'SELECT year(DIAG) AS event_year, type, MIN_LDL AS MIN_LDL FROM SAILW1483V.TEMP_LDL_CONTROL WHERE MIN_LDL <= 10')
MIN_LDL_Test_2010 <- subset(subset(MIN_LDL_Test_2010_2021, event_year == 2010), !is.na(event_year))
MIN_LDL_Test_2021 <- subset(subset(MIN_LDL_Test_2010_2021, event_year == 2021), !is.na(event_year))

MIN_LDL_Test_2010[MIN_LDL_Test_2010 == 'ST'] <- 'Stroke'
MIN_LDL_Test_2010[MIN_LDL_Test_2010 == 'POLY'] <- 'Poly-vascular'
MIN_LDL_Test_2010$type <- factor(MIN_LDL_Test_2010$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

MIN_LDL_Test_2021[MIN_LDL_Test_2021 == 'ST'] <- 'Stroke'
MIN_LDL_Test_2021[MIN_LDL_Test_2021 == 'POLY'] <- 'Poly-vascular'
MIN_LDL_Test_2021$type <- factor(MIN_LDL_Test_2021$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

MIN_LDL_Test_2010_IHD <- subset(MIN_LDL_Test_2010, type == 'IHD')
MIN_LDL_Test_2010_ST <-  subset(MIN_LDL_Test_2010, type == 'Stroke')
MIN_LDL_Test_2010_PAD <- subset(MIN_LDL_Test_2010, type == 'PAD')
MIN_LDL_Test_2010_Poly <- subset(MIN_LDL_Test_2010, type == 'Poly-vascular')
MIN_LDL_Test_2021_IHD <- subset(MIN_LDL_Test_2021, type == 'IHD')
MIN_LDL_Test_2021_ST <-  subset(MIN_LDL_Test_2021, type == 'Stroke')
MIN_LDL_Test_2021_PAD <- subset(MIN_LDL_Test_2021, type == 'PAD')
MIN_LDL_Test_2021_Poly <- subset(MIN_LDL_Test_2021, type == 'Poly-vascular')

```

```{r, include=FALSE}

L<-seq(0,4,0.001)

#2010 - All patients
LDL_2010_min<-MIN_LDL_Test_2010$min_ldl
y<-ecdf(LDL_2010_min)(L)
LDL_2010_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_S <- ggplot(LDL_2010_min,aes(x=L,y=y))+
labs(title='2010')+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4)) +
geom_vline(xintercept=1.8,linetype="dashed")+
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+
theme(plot.title = element_text(size = 15, hjust=0.5),panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - IHD
LDL_2010_IHD_min<-MIN_LDL_Test_2010_IHD$min_ldl
y<-ecdf(LDL_2010_IHD_min)(L)
df_LDL_2010_IHD_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_IHD_S <- ggplot(df_LDL_2010_IHD_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[2])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8), axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - ST
LDL_2010_ST_min<-MIN_LDL_Test_2010_ST$min_ldl
y<-ecdf(LDL_2010_ST_min)(L)
df_LDL_2010_ST_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_ST_S <- ggplot(df_LDL_2010_ST_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[3])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+  
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - PAD
LDL_2010_PAD_min<-MIN_LDL_Test_2010_PAD$min_ldl
y<-ecdf(LDL_2010_PAD_min)(L)
df_LDL_2010_PAD_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_PAD_S <- ggplot(df_LDL_2010_PAD_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[4])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+  
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - Poly
LDL_2010_Poly_min<-MIN_LDL_Test_2010_Poly$min_ldl
y<-ecdf(LDL_2010_Poly_min)(L)
df_LDL_2010_Poly_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_Poly_S <- ggplot(df_LDL_2010_Poly_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[5])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+  
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8), axis.title.y = element_text(face="bold",family="Arial",size=8))


#2021 - All patients
LDL_2021_min<-MIN_LDL_Test_2021$min_ldl
y<-ecdf(LDL_2021_min)(L)
LDL_2021_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2021_S <- ggplot(LDL_2021_min,aes(x=L,y=y))+
labs(title='2021')+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+  
theme(plot.title = element_text(size = 15, hjust=0.5),panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2021 - IHD
LDL_2021_IHD_min<-MIN_LDL_Test_2021_IHD$min_ldl
y<-ecdf(LDL_2021_IHD_min)(L)
df_LDL_2021_IHD_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2021_IHD_S <- ggplot(df_LDL_2021_IHD_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[2])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2021 - ST
LDL_2021_ST_min<-MIN_LDL_Test_2021_ST$min_ldl
y<-ecdf(LDL_2021_ST_min)(L)
df_LDL_2021_ST_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2021_ST_S <- ggplot(df_LDL_2021_ST_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[3])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2021 - PAD
LDL_2021_PAD_min<-MIN_LDL_Test_2021_PAD$min_ldl
y<-ecdf(LDL_2021_PAD_min)(L)
df_LDL_2021_PAD_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2021_PAD_S <- ggplot(df_LDL_2021_PAD_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[4])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+   
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2021 - Poly
LDL_2021_Poly_min<-MIN_LDL_Test_2021_Poly$min_ldl
y<-ecdf(LDL_2021_Poly_min)(L)
df_LDL_2021_Poly_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2021_Poly_S <- ggplot(df_LDL_2021_Poly_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[5])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., name = 'Poly-vascular', breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

```

```{r, echo=FALSE, fig.width=5, fig.height=10, fig.align = 'center', message=FALSE, warning=FALSE}

LDL_S_Inc <- LDL_2010_S + LDL_2021_S + LDL_2010_IHD_S + LDL_2021_IHD_S + LDL_2010_ST_S + LDL_2021_ST_S + LDL_2010_PAD_S + LDL_2021_PAD_S + LDL_2010_Poly_S + LDL_2021_Poly_S + plot_layout(ncol = 2) + plot_annotation(title = 'Incident', theme=theme(plot.title = element_text(hjust = 0.5, size = 17)))

LDL_S_Inc

```

```{r, echo = FALSE}

#ggsave(filename = 'LDL_S_Inc.tiff', plot = LDL_S_Inc, device = 'tiff', width=5, height=12, units ='in', dpi=300, compression = 'lzw')

```

<br>
<br>


### Figure 6. LDL-C Controlled vs Not controlled - LLT

```{r, include=FALSE}

#Controlled
LLT_LDL_CTRL_PREV <- db2_run(conn = Connection, query = 'SELECT YEAR, LLT, TYPE, COUNT(LLT) AS LLT FROM SAILW1483V.TEMP_PREV_LLT_LDL_CTRL GROUP BY YEAR, TYPE, LLT ORDER BY YEAR, TYPE, LLT')

LLT_LDL_CTRL_PREV[LLT_LDL_CTRL_PREV < 10] <- 10
LLT_LDL_CTRL_PREV <- subset(LLT_LDL_CTRL_PREV, LLT_LDL_CTRL_PREV$year < 2023)

#Rename columns
names(LLT_LDL_CTRL_PREV)[names(LLT_LDL_CTRL_PREV)=='llt'] <- 'LLT'
names(LLT_LDL_CTRL_PREV)[names(LLT_LDL_CTRL_PREV)=='llt_1'] <- 'Count'

LLT_LDL_CTRL_PREV$LLT <- replace(LLT_LDL_CTRL_PREV$LLT, LLT_LDL_CTRL_PREV$LLT == 'HIGH_STATIN', 'High-intensity statin')
LLT_LDL_CTRL_PREV$LLT <- replace(LLT_LDL_CTRL_PREV$LLT, LLT_LDL_CTRL_PREV$LLT == 'LOW_STATIN', 'Non-high-intensity statin')
LLT_LDL_CTRL_PREV$LLT <- replace(LLT_LDL_CTRL_PREV$LLT, LLT_LDL_CTRL_PREV$LLT == 'NOTX', 'No treatment')
LLT_LDL_CTRL_PREV$LLT <- replace(LLT_LDL_CTRL_PREV$LLT, LLT_LDL_CTRL_PREV$LLT == 'INEGY', 'Combination statin')
LLT_LDL_CTRL_PREV$LLT <- replace(LLT_LDL_CTRL_PREV$LLT, LLT_LDL_CTRL_PREV$LLT == 'STATIN_COMBI', 'Combination statin')
LLT_LDL_CTRL_PREV$LLT <- replace(LLT_LDL_CTRL_PREV$LLT, LLT_LDL_CTRL_PREV$LLT == 'OTHER', 'Other treatment')
LLT_LDL_CTRL_PREV$type <- replace(LLT_LDL_CTRL_PREV$type, LLT_LDL_CTRL_PREV$type == 'ST', 'Stroke')
LLT_LDL_CTRL_PREV$type <- replace(LLT_LDL_CTRL_PREV$type, LLT_LDL_CTRL_PREV$type == 'POLY', 'Poly-vascular')

LLT_LDL_CTRL_PREV_n <- LLT_LDL_CTRL_PREV %>% group_by(year, type) %>% summarise(n = sum(Count))
LLT_LDL_CTRL_PREV <- LLT_LDL_CTRL_PREV %>% inner_join(LLT_LDL_CTRL_PREV_n, by = c('year' = 'year', 'type' = 'type'))
colnames(LLT_LDL_CTRL_PREV)[4] <- 'Treated'
LLT_LDL_CTRL_PREV <- LLT_LDL_CTRL_PREV %>% dplyr::select(year, LLT, type,Treated,n)
LLT_LDL_CTRL_PREV$pct_treated <- round((LLT_LDL_CTRL_PREV$Treated/LLT_LDL_CTRL_PREV$n)*100,2)

LLT_LDL_CTRL_PREV$LLT <- factor(LLT_LDL_CTRL_PREV$LLT, levels= c('Combination statin', 'High-intensity statin', 'Non-high-intensity statin', 'Other treatment', 'No treatment'))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

CTRL_Fill_PREV <- ggplot(data=LLT_LDL_CTRL_PREV, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(title = 'Controlled  (< 1.8 mmol/l)', x = 'Year', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 2)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title = element_text(size = 11), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 11), legend.position = 'none', axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

LLT_LDL_CTRL_PREV_grouped <- LLT_LDL_CTRL_PREV %>% dplyr::select(year, LLT, Treated, n) %>% group_by(year, LLT) %>% summarise(Treated_sum = sum(Treated), n_sum = sum(n))
LLT_LDL_CTRL_PREV_grouped$pct_treated <- round((LLT_LDL_CTRL_PREV_grouped$Treated_sum/LLT_LDL_CTRL_PREV_grouped$n_sum)*100,2)

CTRL_Fill_PREV_text <- ggplot(data=LLT_LDL_CTRL_PREV_grouped, aes(x=year, y=factor(LLT_LDL_CTRL_PREV_grouped$LLT, levels= c('No treatment', 'Other treatment', 'Non-high-intensity statin', 'High-intensity statin', 'Combination statin')), label=pct_treated, colour = LLT)) + 
geom_text(size= 4) + 
theme_bw() + 
labs(x = 'Year') +  
scale_x_continuous(breaks=seq(0,2023, 2)) +
scale_y_discrete(position='left') +
scale_color_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank(), axis.title.x = element_text(size = 11), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 11), legend.position = 'none', axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

```

```{r, include=FALSE}

#Not Controlled
LLT_LDL_NO_CTRL_PREV <- db2_run(conn = Connection, query = 'SELECT YEAR, LLT, TYPE, COUNT(LLT) AS LLT FROM SAILW1483V.TEMP_PREV_LLT_LDL_NO_CTRL GROUP BY YEAR, TYPE, LLT ORDER BY YEAR, TYPE, LLT')

LLT_LDL_NO_CTRL_PREV[LLT_LDL_NO_CTRL_PREV < 10] <- 10
LLT_LDL_NO_CTRL_PREV <- subset(LLT_LDL_NO_CTRL_PREV, LLT_LDL_NO_CTRL_PREV$year < 2023)

#Rename columns
names(LLT_LDL_NO_CTRL_PREV)[names(LLT_LDL_NO_CTRL_PREV)=='llt'] <- 'LLT'
names(LLT_LDL_NO_CTRL_PREV)[names(LLT_LDL_NO_CTRL_PREV)=='llt_1'] <- 'Count'

LLT_LDL_NO_CTRL_PREV$LLT <- replace(LLT_LDL_NO_CTRL_PREV$LLT, LLT_LDL_NO_CTRL_PREV$LLT == 'HIGH_STATIN', 'High-intensity statin')
LLT_LDL_NO_CTRL_PREV$LLT <- replace(LLT_LDL_NO_CTRL_PREV$LLT, LLT_LDL_NO_CTRL_PREV$LLT == 'LOW_STATIN', 'Non-high-intensity statin')
LLT_LDL_NO_CTRL_PREV$LLT <- replace(LLT_LDL_NO_CTRL_PREV$LLT, LLT_LDL_NO_CTRL_PREV$LLT == 'NOTX', 'No treatment')
LLT_LDL_NO_CTRL_PREV$LLT <- replace(LLT_LDL_NO_CTRL_PREV$LLT, LLT_LDL_NO_CTRL_PREV$LLT == 'INEGY', 'Combination statin')
LLT_LDL_NO_CTRL_PREV$LLT <- replace(LLT_LDL_NO_CTRL_PREV$LLT, LLT_LDL_NO_CTRL_PREV$LLT == 'STATIN_COMBI', 'Combination statin')
LLT_LDL_NO_CTRL_PREV$LLT <- replace(LLT_LDL_NO_CTRL_PREV$LLT, LLT_LDL_NO_CTRL_PREV$LLT == 'OTHER', 'Other treatment')
LLT_LDL_NO_CTRL_PREV$type <- replace(LLT_LDL_NO_CTRL_PREV$type, LLT_LDL_NO_CTRL_PREV$type == 'ST', 'Stroke')
LLT_LDL_NO_CTRL_PREV$type <- replace(LLT_LDL_NO_CTRL_PREV$type, LLT_LDL_NO_CTRL_PREV$type == 'POLY', 'Poly-vascular')

LLT_LDL_NO_CTRL_PREV_n <- LLT_LDL_NO_CTRL_PREV %>% group_by(year, type) %>% summarise(n = sum(Count))
LLT_LDL_NO_CTRL_PREV <- LLT_LDL_NO_CTRL_PREV %>% inner_join(LLT_LDL_NO_CTRL_PREV_n, by = c('year' = 'year', 'type' = 'type'))
colnames(LLT_LDL_NO_CTRL_PREV)[4] <- 'Treated'
LLT_LDL_NO_CTRL_PREV <- LLT_LDL_NO_CTRL_PREV %>% dplyr::select(year, LLT, type,Treated,n)
LLT_LDL_NO_CTRL_PREV$pct_treated <- round((LLT_LDL_NO_CTRL_PREV$Treated/LLT_LDL_NO_CTRL_PREV$n)*100,2)

LLT_LDL_NO_CTRL_PREV$LLT <- factor(LLT_LDL_NO_CTRL_PREV$LLT, levels= c('Combination statin', 'High-intensity statin', 'Non-high-intensity statin', 'Other treatment', 'No treatment'))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

No_CTRL_Fill_PREV <- ggplot(data=LLT_LDL_NO_CTRL_PREV, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(title = 'Not controlled (>= 1.8 mmol/l)', x = 'Year', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 2)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title = element_text(size = 11), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

LLT_LDL_NO_CTRL_PREV_grouped <- LLT_LDL_NO_CTRL_PREV %>% dplyr::select(year, LLT, Treated, n) %>% group_by(year, LLT) %>% summarise(Treated_sum = sum(Treated), n_sum = sum(n))
LLT_LDL_NO_CTRL_PREV_grouped$pct_treated <- round((LLT_LDL_NO_CTRL_PREV_grouped$Treated_sum/LLT_LDL_NO_CTRL_PREV_grouped$n_sum)*100,2)

No_CTRL_Fill_PREV_text <- ggplot(data=LLT_LDL_NO_CTRL_PREV_grouped, aes(x=year, y=factor(LLT_LDL_NO_CTRL_PREV_grouped$LLT, levels= c('No treatment', 'Other treatment', 'Non-high-intensity statin', 'High-intensity statin', 'Combination statin')), label=pct_treated, colour = LLT)) + 
geom_text(size= 4) + 
theme_bw() + 
labs(x = 'Year') +
scale_x_continuous(breaks=seq(0,2023, 2)) +
scale_y_discrete(position='left') +
scale_color_manual(values=cbPalette)+  
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank(), axis.title.x = element_text(size = 11), axis.text.y = element_blank(), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 11), legend.position = 'none', axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

```


```{r, include=FALSE}

#Controlled
LLT_LDL_CTRL <- db2_run(conn = Connection, query = 'SELECT FIRST_YEAR AS YEAR, LLT, TYPE, COUNT(LLT) AS LLT FROM SAILW1483V.TEMP_INC_LLT_LDL_CTRL GROUP BY FIRST_YEAR, TYPE, LLT ORDER BY FIRST_YEAR, TYPE, LLT')

LLT_LDL_CTRL[LLT_LDL_CTRL < 10] <- 10
LLT_LDL_CTRL <- subset(LLT_LDL_CTRL, LLT_LDL_CTRL$year < 2022)

#Rename columns
names(LLT_LDL_CTRL)[names(LLT_LDL_CTRL)=='llt'] <- 'LLT'
names(LLT_LDL_CTRL)[names(LLT_LDL_CTRL)=='llt_1'] <- 'Count'

LLT_LDL_CTRL$LLT <- replace(LLT_LDL_CTRL$LLT, LLT_LDL_CTRL$LLT == 'HIGH_STATIN', 'High-intensity statin')
LLT_LDL_CTRL$LLT <- replace(LLT_LDL_CTRL$LLT, LLT_LDL_CTRL$LLT == 'LOW_STATIN', 'Non-high-intensity statin')
LLT_LDL_CTRL$LLT <- replace(LLT_LDL_CTRL$LLT, LLT_LDL_CTRL$LLT == 'NOTX', 'No treatment')
LLT_LDL_CTRL$LLT <- replace(LLT_LDL_CTRL$LLT, LLT_LDL_CTRL$LLT == 'INEGY', 'Combination statin')
LLT_LDL_CTRL$LLT <- replace(LLT_LDL_CTRL$LLT, LLT_LDL_CTRL$LLT == 'STATIN_COMBI', 'Combination statin')
LLT_LDL_CTRL$LLT <- replace(LLT_LDL_CTRL$LLT, LLT_LDL_CTRL$LLT == 'OTHER', 'Other treatment')
LLT_LDL_CTRL$type <- replace(LLT_LDL_CTRL$type, LLT_LDL_CTRL$type == 'ST', 'Stroke')
LLT_LDL_CTRL$type <- replace(LLT_LDL_CTRL$type, LLT_LDL_CTRL$type == 'POLY', 'Poly-vascular')

LLT_LDL_CTRL_n <- LLT_LDL_CTRL %>% group_by(year, type) %>% summarise(n = sum(Count))
LLT_LDL_CTRL <- LLT_LDL_CTRL %>% inner_join(LLT_LDL_CTRL_n, by = c('year' = 'year', 'type' = 'type'))
colnames(LLT_LDL_CTRL)[4] <- 'Treated'
LLT_LDL_CTRL <- LLT_LDL_CTRL %>% dplyr::select(year, LLT, type,Treated,n)
LLT_LDL_CTRL$pct_treated <- round((LLT_LDL_CTRL$Treated/LLT_LDL_CTRL$n)*100,2)

LLT_LDL_CTRL$LLT <- factor(LLT_LDL_CTRL$LLT, levels= c('Combination statin', 'High-intensity statin', 'Non-high-intensity statin', 'Other treatment', 'No treatment'))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

CTRL_Fill <- ggplot(data=LLT_LDL_CTRL, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'Year', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2021, 2)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title = element_text(size = 11), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 11), legend.position = 'none', axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

```


```{r, echo=FALSE, message=FALSE, warning=FALSE}

LLT_LDL_CTRL_grouped <- LLT_LDL_CTRL %>% dplyr::select(year, LLT, Treated, n) %>% group_by(year, LLT) %>% summarise(Treated_sum = sum(Treated), n_sum = sum(n))
LLT_LDL_CTRL_grouped$pct_treated <- round((LLT_LDL_CTRL_grouped$Treated_sum/LLT_LDL_CTRL_grouped$n_sum)*100,2)

CTRL_Fill_text <- ggplot(data=LLT_LDL_CTRL_grouped, aes(x=year, y=factor(LLT_LDL_CTRL_grouped$LLT, levels= c('No treatment', 'Other treatment', 'Non-high-intensity statin', 'High-intensity statin', 'Combination statin')), label=pct_treated, colour = LLT)) + 
geom_text(size= 4) + 
theme_bw() + 
labs(x = 'Year') +  
scale_x_continuous(breaks=seq(0,2023, 2)) +
scale_y_discrete(position='left') +
scale_color_manual(values=cbPalette)+  
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank(), axis.title.x = element_text(size = 11), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 11), legend.position = 'none', axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

```


```{r, include=FALSE}

#Not Controlled
LLT_LDL_NO_CTRL <- db2_run(conn = Connection, query = 'SELECT FIRST_YEAR AS YEAR, LLT, TYPE, COUNT(LLT) AS LLT FROM SAILW1483V.TEMP_INC_LLT_LDL_NO_CTRL GROUP BY FIRST_YEAR, TYPE, LLT ORDER BY FIRST_YEAR, TYPE, LLT')

LLT_LDL_NO_CTRL[LLT_LDL_NO_CTRL < 10] <- 10
LLT_LDL_NO_CTRL <- subset(LLT_LDL_NO_CTRL, LLT_LDL_NO_CTRL$year < 2022)

#Rename columns
names(LLT_LDL_NO_CTRL)[names(LLT_LDL_NO_CTRL)=='llt'] <- 'LLT'
names(LLT_LDL_NO_CTRL)[names(LLT_LDL_NO_CTRL)=='llt_1'] <- 'Count'

LLT_LDL_NO_CTRL$LLT <- replace(LLT_LDL_NO_CTRL$LLT, LLT_LDL_NO_CTRL$LLT == 'HIGH_STATIN', 'High-intensity statin')
LLT_LDL_NO_CTRL$LLT <- replace(LLT_LDL_NO_CTRL$LLT, LLT_LDL_NO_CTRL$LLT == 'LOW_STATIN', 'Non-high-intensity statin')
LLT_LDL_NO_CTRL$LLT <- replace(LLT_LDL_NO_CTRL$LLT, LLT_LDL_NO_CTRL$LLT == 'NOTX', 'No treatment')
LLT_LDL_NO_CTRL$LLT <- replace(LLT_LDL_NO_CTRL$LLT, LLT_LDL_NO_CTRL$LLT == 'INEGY', 'Combination statin')
LLT_LDL_NO_CTRL$LLT <- replace(LLT_LDL_NO_CTRL$LLT, LLT_LDL_NO_CTRL$LLT == 'STATIN_COMBI', 'Combination statin')
LLT_LDL_NO_CTRL$LLT <- replace(LLT_LDL_NO_CTRL$LLT, LLT_LDL_NO_CTRL$LLT == 'OTHER', 'Other treatment')
LLT_LDL_NO_CTRL$type <- replace(LLT_LDL_NO_CTRL$type, LLT_LDL_NO_CTRL$type == 'ST', 'Stroke')
LLT_LDL_NO_CTRL$type <- replace(LLT_LDL_NO_CTRL$type, LLT_LDL_NO_CTRL$type == 'POLY', 'Poly-vascular')

LLT_LDL_NO_CTRL_n <- LLT_LDL_NO_CTRL %>% group_by(year, type) %>% summarise(n = sum(Count))
LLT_LDL_NO_CTRL <- LLT_LDL_NO_CTRL %>% inner_join(LLT_LDL_NO_CTRL_n, by = c('year' = 'year', 'type' = 'type'))
colnames(LLT_LDL_NO_CTRL)[4] <- 'Treated'
LLT_LDL_NO_CTRL <- LLT_LDL_NO_CTRL %>% dplyr::select(year, LLT, type,Treated,n)
LLT_LDL_NO_CTRL$pct_treated <- round((LLT_LDL_NO_CTRL$Treated/LLT_LDL_NO_CTRL$n)*100,2)

LLT_LDL_NO_CTRL$LLT <- factor(LLT_LDL_NO_CTRL$LLT, levels= c('Combination statin', 'High-intensity statin', 'Non-high-intensity statin', 'Other treatment', 'No treatment'))

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

No_CTRL_Fill <- ggplot(data=LLT_LDL_NO_CTRL, aes(x=year, y=Treated, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'Year', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2021, 2)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title = element_text(size = 11), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

LLT_LDL_NO_CTRL_grouped <- LLT_LDL_NO_CTRL %>% dplyr::select(year, LLT, Treated, n) %>% group_by(year, LLT) %>% summarise(Treated_sum = sum(Treated), n_sum = sum(n))
LLT_LDL_NO_CTRL_grouped$pct_treated <- round((LLT_LDL_NO_CTRL_grouped$Treated_sum/LLT_LDL_NO_CTRL_grouped$n_sum)*100,2)

No_CTRL_Fill_text <- ggplot(data=LLT_LDL_NO_CTRL_grouped, aes(x=year, y=factor(LLT_LDL_NO_CTRL_grouped$LLT, levels= c('No treatment', 'Other treatment', 'Non-high-intensity statin', 'High-intensity statin', 'Combination statin')), label=pct_treated, colour = LLT)) + 
geom_text(size= 4) + 
theme_bw() + 
labs(x = 'Year') +  
scale_x_continuous(breaks=seq(0,2023, 2)) +
scale_y_discrete(position='left') +
scale_color_manual(values=cbPalette)+  
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank(), axis.title.x = element_text(size = 11), axis.text.y = element_blank(), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 11), legend.position = 'none', axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

```

```{r, include=FALSE}

LDL_CTRL <- egg::ggarrange(CTRL_Fill_PREV, No_CTRL_Fill_PREV, CTRL_Fill, No_CTRL_Fill, ncol=2)

```

```{r, echo=FALSE, fig.width=10, fig.height=8, fig.align = 'center', message=FALSE, warning=FALSE}

LDL_CTRL

```

```{r, echo = FALSE}

# tiff(filename = 'LDL_CTRL.tiff', width=3600, height=2700, res = 300, compression = 'lzw')
# LDL_CTRL
# dev.off()

```

<br>
<br>

## Statistical modelling
### Logistic regression
#### Tested in incident year

```{r,include=FALSE}

set.seed(12345)

Lipid_test_regr <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_LDL_TEST_INC_REGR')

Lipid_test_regr$smoking_status <- ifelse(is.na(Lipid_test_regr$smoking_status), 'U', Lipid_test_regr$smoking_status)
Lipid_test_regr$weight_cat <- ifelse(is.na(Lipid_test_regr$weight_cat), 'U', Lipid_test_regr$weight_cat)
Lipid_test_regr$wimd_2019_quintile <- ifelse(is.na(Lipid_test_regr$wimd_2019_quintile), 'U', Lipid_test_regr$wimd_2019_quintile)

Lipid_test_regr$gender <- replace(Lipid_test_regr$gender, Lipid_test_regr$gender == 1, 'Male')
Lipid_test_regr$gender <- replace(Lipid_test_regr$gender, Lipid_test_regr$gender == 2, 'Female')
Lipid_test_regr$llt <- replace(Lipid_test_regr$llt, Lipid_test_regr$llt == 'INEGY', 'STATIN_COMBI')
Lipid_test_regr$type <- as.factor(Lipid_test_regr$type)
Lipid_test_regr$smoking_status <- factor(Lipid_test_regr$smoking_status, levels = c('N','E','S', 'U'))
Lipid_test_regr$wimd_2019_quintile <- as.factor(Lipid_test_regr$wimd_2019_quintile)
Lipid_test_regr$weight_cat <- as.factor(Lipid_test_regr$weight_cat)
Lipid_test_regr$llt <- factor(Lipid_test_regr$llt, levels = c('NOTX', 'OTHER', 'LOW_STATIN', 'HIGH_STATIN', 'STATIN_COMBI'))

Lipid_test_regr_final <- data.frame(Lipid_test_regr)
  
#Rename columns
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='gender'] <- 'Sex'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='first_year'] <- 'Diagnosis Year'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='age_diag'] <- 'Age at Diagnosis'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='type'] <- 'Territory'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='index_multi_terr'] <- 'Index Poly'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='has_2_terr'] <- '2 Territories'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='has_3_terr'] <- '3 Territories'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='study_30d_follow_up'] <- '30 days follow-up'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='study_60d_follow_up'] <- '60 days follow-up'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='study_90d_follow_up'] <- '90 days follow-up'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='study_120d_follow_up'] <- '120 days follow-up'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='study_365d_follow_up'] <- '1 year follow-up'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='pedw_admis_first'] <- 'Index PEDW'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='gp_admis_first'] <- 'Index WLGP'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='has_gp_diag'] <- 'Has GP Diagnosis'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='diabetes_before'] <- 'Diabetes'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='dementia_before'] <- 'Dementia'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='resp_before'] <- 'Respiratory Disease'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='liver_before'] <- 'Liver Disease'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='renal_before'] <- 'CKD'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='hypertension_before'] <- 'Hypertension'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='smoking_status'] <- 'Smoker Status'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='wimd_2019_quintile'] <- 'WIMD'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='llt'] <- 'Treatment'
names(Lipid_test_regr_final)[names(Lipid_test_regr_final)=='had_lipid_test'] <- 'LDL Test'

Lipid_test_regr_final <- Lipid_test_regr_final[,!names(Lipid_test_regr_final) %in% c('1 year follow-up', '120 days follow-up', '90 days follow-up', '60 days follow-up', '30 days follow-up', 'Has GP Diagnosis', 'Index Poly', '3 Territories', '2 Territories')]

Lipid_test_regr_final <- na.omit(Lipid_test_regr_final)

```

```{r,include=FALSE}

Lipid_test_regr_final$id <-  1:nrow(Lipid_test_regr_final)
  
train <- Lipid_test_regr_final %>% sample_frac(0.70)
test <- anti_join(Lipid_test_regr_final, train, by='id')

train$id <- NULL
test$id <- NULL

```

```{r,include=FALSE}

fullModel <- glm(`LDL Test` ~ ., data=train, family = 'binomial')

stepModel <- fullModel %>% stepAIC(direction = 'both')

```

```{r, include=FALSE}

OR_LDL_TEST <- as.data.frame(odds.ratio(stepModel, level = 0.95))

```

```{r, include=FALSE}

options(scipen = 999)

```


```{r, echo=FALSE, message=FALSE}

OR_LDL_TEST %>% 
  kbl(caption = 'Multivariable logistic regression model to predict the likelihood of receiving a recorded LDL-C level during incident year.') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()

```

<br>
<br>

#### LDL - Control (<=1.8)

```{r,include=FALSE}

Lipid_control_ldl_regr <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_LIPID_control_LDL_INC_REGR')

Lipid_control_ldl_regr$smoking_status <- ifelse(is.na(Lipid_control_ldl_regr$smoking_status), 'U', Lipid_control_ldl_regr$smoking_status)
Lipid_control_ldl_regr$weight_cat <- ifelse(is.na(Lipid_control_ldl_regr$weight_cat), 'U', Lipid_control_ldl_regr$weight_cat)
Lipid_control_ldl_regr$wimd_2019_quintile <- ifelse(is.na(Lipid_control_ldl_regr$wimd_2019_quintile), 'U', Lipid_control_ldl_regr$wimd_2019_quintile)

Lipid_control_ldl_regr$gender <- replace(Lipid_control_ldl_regr$gender, Lipid_control_ldl_regr$gender == 1, 'Male')
Lipid_control_ldl_regr$gender <- replace(Lipid_control_ldl_regr$gender, Lipid_control_ldl_regr$gender == 2, 'Female')
Lipid_control_ldl_regr$type <- as.factor(Lipid_control_ldl_regr$type)
Lipid_control_ldl_regr$smoking_status <- factor(Lipid_control_ldl_regr$smoking_status, levels = c('N','E','S', 'U'))
Lipid_control_ldl_regr$llt <- ifelse(Lipid_control_ldl_regr$llt == 'INEGY', 'STATIN_COMBI', Lipid_control_ldl_regr$llt)
Lipid_control_ldl_regr$llt <- factor(Lipid_control_ldl_regr$llt, levels = c('NOTX', 'OTHER', 'LOW_STATIN', 'HIGH_STATIN', 'STATIN_COMBI'))
Lipid_control_ldl_regr$wimd_2019_quintile <- as.factor(Lipid_control_ldl_regr$wimd_2019_quintile)
Lipid_control_ldl_regr$weight_cat <- as.factor(Lipid_control_ldl_regr$weight_cat)

Lipid_control_ldl_regr_final <- data.frame(Lipid_control_ldl_regr)
  
#Rename columns
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='gender'] <- 'Sex'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='first_year'] <- 'Diagnosis Year'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='age_diag'] <- 'Age at Diagnosis'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='type'] <- 'Territory'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='index_multi_terr'] <- 'Index Poly'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='has_2_terr'] <- '2 Territories'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='has_3_terr'] <- '3 Territories'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='study_30d_follow_up'] <- '30 days follow-up'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='study_60d_follow_up'] <- '60 days follow-up'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='study_90d_follow_up'] <- '90 days follow-up'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='study_120d_follow_up'] <- '120 days follow-up'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='study_365d_follow_up'] <- '1 year follow-up'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='pedw_admis_first'] <- 'Index PEDW'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='gp_admis_first'] <- 'Index WLGP'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='has_gp_diag'] <- 'Has GP Diagnosis'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='diabetes_before'] <- 'Diabetes'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='dementia_before'] <- 'Dementia'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='resp_before'] <- 'Respiratory Disease'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='liver_before'] <- 'Liver Disease'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='renal_before'] <- 'CKD'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='hypertension_before'] <- 'Hypertension'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='smoking_status'] <- 'Smoker Status'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='wimd_2019_quintile'] <- 'WIMD'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='llt'] <- 'Treatment'
names(Lipid_control_ldl_regr_final)[names(Lipid_control_ldl_regr_final)=='ldl_controlled'] <- 'LDL controlled'

Lipid_control_ldl_regr_final <- Lipid_control_ldl_regr_final[,!names(Lipid_control_ldl_regr_final) %in% c('Sex F', 'Index WLGP', '1 year follow-up', '120 days follow-up', '90 days follow-up', '60 days follow-up', '30 days follow-up', 'Has GP Diagnosis', 'Index PAD', 'Index IHD', 'Index Poly', '3 Territories', '2 Territories')]

Lipid_control_ldl_regr_final <- na.omit(Lipid_control_ldl_regr_final)

```


```{r,include=FALSE}

Lipid_control_ldl_regr_final$id <-  1:nrow(Lipid_control_ldl_regr_final)
  
train <- Lipid_control_ldl_regr_final %>% sample_frac(0.70)
test <- anti_join(Lipid_control_ldl_regr_final, train, by='id')

train$id <- NULL
test$id <- NULL

```


```{r,include=FALSE}

fullModel <- glm(`LDL controlled` ~ ., data=train, family = 'binomial')

stepModel <- fullModel %>% stepAIC(direction = 'both')

```

```{r, include=FALSE}

OR_LDL_CTRL <- round(as.data.frame(odds.ratio(stepModel, level = 0.95)),2)

```

```{r, echo=FALSE, message=FALSE}

OR_LDL_CTRL %>% 
  kbl(caption = 'Multivariable logistic regression model to predict the likelihood of achieving LDL-C control (<1.8 mmol/L) during incident year.') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()

```

<br>
<br>

#### High-intensity statin

```{r,include=FALSE}

HI_statin_regr <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_LIPID_TREAT_HI_STATIN_INC_REGR')

HI_statin_regr$smoking_status <- ifelse(is.na(HI_statin_regr$smoking_status), 'U', HI_statin_regr$smoking_status)
HI_statin_regr$weight_cat <- ifelse(is.na(HI_statin_regr$weight_cat), 'U', HI_statin_regr$weight_cat)
HI_statin_regr$wimd_2019_quintile <- ifelse(is.na(HI_statin_regr$wimd_2019_quintile), 'U', HI_statin_regr$wimd_2019_quintile)

HI_statin_regr$gender <- replace(HI_statin_regr$gender, HI_statin_regr$gender == 1, 'Male')
HI_statin_regr$gender <- replace(HI_statin_regr$gender, HI_statin_regr$gender == 2, 'Female')
HI_statin_regr$type <- as.factor(HI_statin_regr$type)
HI_statin_regr$smoking_status <- factor(HI_statin_regr$smoking_status, levels = c('N','E','S', 'U'))
HI_statin_regr$wimd_2019_quintile <- as.factor(HI_statin_regr$wimd_2019_quintile)
HI_statin_regr$weight_cat <- as.factor(HI_statin_regr$weight_cat)

HI_statin_regr_final <- data.frame(HI_statin_regr)
  
#Rename columns
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='gender'] <- 'Sex'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='first_year'] <- 'Diagnosis Year'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='age_diag'] <- 'Age at Diagnosis'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='type'] <- 'Territory'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='index_multi_terr'] <- 'Index Poly'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='has_2_terr'] <- '2 Territories'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='has_3_terr'] <- '3 Territories'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='study_30d_follow_up'] <- '30 days follow-up'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='study_60d_follow_up'] <- '60 days follow-up'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='study_90d_follow_up'] <- '90 days follow-up'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='study_120d_follow_up'] <- '120 days follow-up'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='study_365d_follow_up'] <- '1 year follow-up'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='pedw_admis_first'] <- 'Index PEDW'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='gp_admis_first'] <- 'Index WLGP'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='has_gp_diag'] <- 'Has GP Diagnosis'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='diabetes_before'] <- 'Diabetes'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='dementia_before'] <- 'Dementia'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='resp_before'] <- 'Respiratory Disease'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='liver_before'] <- 'Liver Disease'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='renal_before'] <- 'CKD'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='hypertension_before'] <- 'Hypertension'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='smoking_status'] <- 'Smoker Status'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='wimd_2019_quintile'] <- 'WIMD'
names(HI_statin_regr_final)[names(HI_statin_regr_final)=='hi_statin'] <- 'Prescribed HI-statin'

HI_statin_regr_final <- HI_statin_regr_final[,!names(HI_statin_regr_final) %in% c('Sex F', 'Index WLGP', '1 year follow-up', '120 days follow-up', '90 days follow-up', '60 days follow-up', '30 days follow-up', 'Has GP Diagnosis', 'Index PAD', 'Index IHD', 'Index Poly', '3 Territories', '2 Territories')]

HI_statin_regr_final <- na.omit(HI_statin_regr_final)

```

```{r,include=FALSE}

HI_statin_regr_final$id <-  1:nrow(HI_statin_regr_final)
  
train <- HI_statin_regr_final %>% sample_frac(0.70)
test <- anti_join(HI_statin_regr_final, train, by='id')

train$id <- NULL
test$id <- NULL

```

```{r,include=FALSE}

fullModel <- glm(`Prescribed HI-statin` ~ ., data=train, family = 'binomial')

stepModel <- fullModel %>% stepAIC(direction = 'both')

```

```{r, include=FALSE}

OR_HI_STAT <- round(as.data.frame(odds.ratio(stepModel, level = 0.95)),2)

```

```{r, echo=FALSE, message=FALSE}

OR_HI_STAT %>% 
  kbl(caption = 'Multivariable logistic regression model to predict the likelihood of being prescribed high-intensity statin therapy during incident year.') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()

```

<br>
<br>


## Supplementary Figures

### Incidence & Prevalence by age group

```{r, include=FALSE}

inc_by_terr_ages <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.PREP_INC_PER_YEAR_AGES ORDER BY YEAR')

inc_by_terr_stack_ages <- dplyr::select(inc_by_terr_ages,'year', 'age_cat', 'ihd', 'st', 'pad', 'poly')

inc_by_terr_stack_ages <- inc_by_terr_stack_ages %>% pivot_longer(!c(year, age_cat), names_to = 'Territory', values_to = 'Count')

colnames(inc_by_terr_stack_ages)[1] <- 'Year'
colnames(inc_by_terr_stack_ages)[2] <- 'Age'

inc_by_terr_stack_ages[inc_by_terr_stack_ages == 'ihd'] <- 'IHD'
inc_by_terr_stack_ages[inc_by_terr_stack_ages == 'st'] <- 'Stroke'
inc_by_terr_stack_ages[inc_by_terr_stack_ages == 'pad'] <- 'PAD'
inc_by_terr_stack_ages[inc_by_terr_stack_ages == 'poly'] <- 'Poly-vascular'

inc_by_terr_stack_ages$Territory <- factor(inc_by_terr_stack_ages$Territory, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))
inc_by_terr_stack_ages$Age <- factor(inc_by_terr_stack_ages$Age, levels= c('< 60', '60 - 85', '> 85'))


```

```{r, include=FALSE}

prev_by_terr_stack_ages <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.PREP_PREV_PER_YEAR_AGES')

prev_by_terr_stack_ages  <- subset(prev_by_terr_stack_ages, prev_by_terr_stack_ages$year < 2023)

names(prev_by_terr_stack_ages)[names(prev_by_terr_stack_ages)=='terr'] <- 'Territory'
names(prev_by_terr_stack_ages)[names(prev_by_terr_stack_ages)=='age'] <- 'Age'

prev_by_terr_stack_ages[prev_by_terr_stack_ages == 'ST'] <- 'Stroke'
prev_by_terr_stack_ages[prev_by_terr_stack_ages == 'POLY'] <- 'Poly-vascular'

prev_by_terr_stack_ages$Territory <- factor(prev_by_terr_stack_ages$Territory, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))
prev_by_terr_stack_ages$Age <- factor(prev_by_terr_stack_ages$Age, levels= c('< 60', '60 - 85', '> 85'))

prev_by_terr_group <- prev_by_terr_stack_ages %>% group_by(year, Age) %>% summarise(total=sum(count))
```

```{r, warning=FALSE, echo=FALSE, message=FALSE}

Inc <- ggplot(data=inc_by_terr_stack_ages, aes(x=Year, y=Count, fill=Territory, label=Count)) + 
geom_bar(position = 'stack',stat = 'identity') +
labs(x = 'Year',  y = 'Patients', title='Incidence') +
scale_x_continuous(breaks=seq(0,2022, 3)) +
facet_wrap(~Age)+
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 10), axis.text.y = element_text(size = 10),  axis.title.x = element_text(size = 10), axis.text.x = element_text(size = 10), axis.line.x = element_line(),legend.text = element_text(size = 10), legend.title = element_text(size = 10), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none') +
scale_fill_manual(values=cbPalette)

```

```{r, warning=FALSE, echo=FALSE, message=FALSE}

Prev <- ggplot(data=prev_by_terr_stack_ages, aes(x=factor(year), y=count, fill=Territory, label=count)) + 
geom_bar(position = 'stack',stat = 'identity') +
labs(x = 'Year', y = 'Patients', color = 'Legend', title = 'Prevalence') +
scale_x_discrete(breaks=seq(0,2022, 3)) +
scale_fill_manual(values=cbPalette)+ 
facet_wrap(~Age)+
theme(plot.title = element_text(size =15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 10), axis.title.x = element_text(size = 10), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 15), legend.title = element_text(size = 15), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')
```

```{r, include=FALSE}

denominator_yr_ages <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.AGES_DENOM')

denominator_yr_ages$Denom_100k <- denominator_yr_ages$count / 100000
denominator_yr_ages %>% arrange(age, year)

```

```{r, include=FALSE}

inc_by_terr_stack_ages_denom <- merge(inc_by_terr_stack_ages, denominator_yr_ages, by.x=c('Year', 'Age'), by.y = c('year', 'age'))
inc_by_terr_stack_ages_denom$total_Per100k <- round(inc_by_terr_stack_ages_denom$Count / inc_by_terr_stack_ages_denom$Denom_100k,0)

prev_by_terr_stack_ages_denom <- merge(prev_by_terr_stack_ages, denominator_yr_ages, by.x=c('year', 'Age'), by.y = c('year', 'age'))
prev_by_terr_stack_ages_denom$total_Per100k <- round(prev_by_terr_stack_ages_denom$count.x / prev_by_terr_stack_ages_denom$Denom_100k,0)

```

```{r, include=FALSE}

Inc_line_100k <- ggplot(data=inc_by_terr_stack_ages_denom, aes(x=factor(Year), color=Territory)) + 
geom_line(aes(y=total_Per100k, group = Territory), size=1) +
geom_point(aes(y=total_Per100k, group = Territory), size=2) +
labs(x = 'Year', y = 'Patients (per 100,000)', color = 'Legend', title = 'Incidence (per 100,000)') +
scale_color_manual(values=cbPalette)+    
scale_x_discrete(breaks=seq(0,2022, 3)) +
facet_wrap(~Age)+  
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.x = element_text(size = 10), axis.title.y = element_text(size = 10), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 10), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'right')

```

```{r, include=FALSE}

Prev_line_100k <- ggplot(data=prev_by_terr_stack_ages_denom, aes(x=factor(year), color=Territory)) + 
geom_line(aes(y=total_Per100k, group = Territory), size=1) +
geom_point(aes(y=total_Per100k, group = Territory), size=2) +
scale_x_discrete(breaks=seq(2010,2023,3)) +
labs(x = 'Year', y = 'Patients (per 100,000)', color = 'Legend', title = 'Prevalence (per 100,000)') +
facet_wrap(~Age)+  
scale_color_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 10), axis.title.x = element_text(size = 10), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 10), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

```

```{r, echo=FALSE,  fig.width=18, fig.height=8, fig.align = 'center'}

FourPanelIncPrev_Ages <- egg::ggarrange(Prev, Prev_line_100k, Inc, Inc_line_100k, ncol=2)

```

```{r, echo = FALSE}

#ggsave(filename = 'FourPanelIncPrev_Ages.tiff', plot = FourPanelIncPrev_Ages, device = 'tiff', width=18, height=8, units ='in', dpi=300, compression = 'lzw')

```

<br>
<br>

```{r, warning=FALSE, echo=FALSE, message=FALSE}

Inc <- ggplot(data=inc_by_terr_stack_ages %>% filter(Age == '< 60'), aes(x=Year, y=Count, fill=Territory, label=Count)) + 
geom_bar(position = 'stack',stat = 'identity') +
labs(x = 'Year',  y = 'Patients', title='Incidence') +
scale_x_continuous(breaks=seq(0,2022, 3)) +
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 10), axis.text.y = element_text(size = 10),  axis.title.x = element_text(size = 10), axis.text.x = element_text(size = 10), axis.line.x = element_line(),legend.text = element_text(size = 10), legend.title = element_text(size = 10), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none') +
scale_fill_manual(values=cbPalette)

```

```{r, warning=FALSE, echo=FALSE, message=FALSE}

Prev <- ggplot(data=prev_by_terr_stack_ages %>% filter(Age == '< 60'), aes(x=factor(year), y=count, fill=Territory, label=count)) + 
geom_bar(position = 'stack',stat = 'identity') +
labs(x = 'Year', y = 'Patients', color = 'Legend', title = 'Prevalence') +
scale_x_discrete(breaks=seq(0,2022, 3)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size =15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 10), axis.title.x = element_text(size = 10), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 15), legend.title = element_text(size = 15), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')

```

```{r, include=FALSE}

Inc_line_100k <- ggplot(data=inc_by_terr_stack_ages_denom %>% filter(Age == '< 60'), aes(x=factor(Year), color=Territory)) + 
geom_line(aes(y=total_Per100k, group = Territory), size=1) +
geom_point(aes(y=total_Per100k, group = Territory), size=2) +
labs(x = 'Year', y = 'Patients (per 100,000)', color = 'Legend', title = 'Incidence (per 100,000)') +
scale_color_manual(values=cbPalette)+    
scale_x_discrete(breaks=seq(0,2022, 3)) +
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.x = element_text(size = 10), axis.title.y = element_text(size = 10), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 10), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'right')

```

```{r, include=FALSE}

Prev_line_100k <- ggplot(data=prev_by_terr_stack_ages_denom %>% filter(Age == '< 60'), aes(x=factor(year), color=Territory)) + 
geom_line(aes(y=total_Per100k, group = Territory), size=1) +
geom_point(aes(y=total_Per100k, group = Territory), size=2) +
scale_x_discrete(breaks=seq(2010,2023,3)) +
labs(x = 'Year', y = 'Patients (per 100,000)', color = 'Legend', title = 'Prevalence (per 100,000)') +
scale_color_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 10), axis.title.x = element_text(size = 10), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 10), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

```

```{r, echo=FALSE,  fig.width=10, fig.height=7, fig.align = 'center'}

FourPanelIncPrev_Ages_U60 <- egg::ggarrange(Prev, Prev_line_100k, Inc, Inc_line_100k, ncol=2)

```

```{r, echo = FALSE}

#ggsave(filename = 'FourPanelIncPrev_Ages_U60.tiff', plot = FourPanelIncPrev_Ages_U60, device = 'tiff', width=10, height=7, units ='in', dpi=300, compression = 'lzw')

```

<br>
<br>

```{r, warning=FALSE, echo=FALSE, message=FALSE}

Inc <- ggplot(data=inc_by_terr_stack_ages %>% filter(Age == '60 - 85'), aes(x=Year, y=Count, fill=Territory, label=Count)) + 
geom_bar(position = 'stack',stat = 'identity') +
labs(x = 'Year',  y = 'Patients', title='Incidence') +
scale_x_continuous(breaks=seq(0,2022, 3)) +
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 10), axis.text.y = element_text(size = 10),  axis.title.x = element_text(size = 10), axis.text.x = element_text(size = 10), axis.line.x = element_line(),legend.text = element_text(size = 10), legend.title = element_text(size = 10), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none') +
scale_fill_manual(values=cbPalette)

```

```{r, warning=FALSE, echo=FALSE, message=FALSE}

Prev <- ggplot(data=prev_by_terr_stack_ages %>% filter(Age == '60 - 85'), aes(x=factor(year), y=count, fill=Territory, label=count)) + 
geom_bar(position = 'stack',stat = 'identity') +
labs(x = 'Year', y = 'Patients', color = 'Legend', title = 'Prevalence') +
scale_x_discrete(breaks=seq(0,2022, 3)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size =15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 10), axis.title.x = element_text(size = 10), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 15), legend.title = element_text(size = 15), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')
```

```{r, include=FALSE}

Inc_line_100k <- ggplot(data=inc_by_terr_stack_ages_denom %>% filter(Age == '60 - 85'), aes(x=factor(Year), color=Territory)) + 
geom_line(aes(y=total_Per100k, group = Territory), size=1) +
geom_point(aes(y=total_Per100k, group = Territory), size=2) +
labs(x = 'Year', y = 'Patients (per 100,000)', color = 'Legend', title = 'Incidence (per 100,000)') +
scale_color_manual(values=cbPalette)+    
scale_x_discrete(breaks=seq(0,2022, 3)) +
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.x = element_text(size = 10), axis.title.y = element_text(size = 10), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 10), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'right')

```

```{r, include=FALSE}

Prev_line_100k <- ggplot(data=prev_by_terr_stack_ages_denom %>% filter(Age == '60 - 85'), aes(x=factor(year), color=Territory)) + 
geom_line(aes(y=total_Per100k, group = Territory), size=1) +
geom_point(aes(y=total_Per100k, group = Territory), size=2) +
scale_x_discrete(breaks=seq(2010,2023,3)) +
labs(x = 'Year', y = 'Patients (per 100,000)', color = 'Legend', title = 'Prevalence (per 100,000)') +
scale_color_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 10), axis.title.x = element_text(size = 10), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 10), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

```

```{r, echo=FALSE,  fig.width=10, fig.height=7, fig.align = 'center'}

FourPanelIncPrev_Ages_60_85 <- egg::ggarrange(Prev, Prev_line_100k, Inc, Inc_line_100k, ncol=2)

```

```{r, echo = FALSE}

#ggsave(filename = 'FourPanelIncPrev_Ages_60_85.tiff', plot = FourPanelIncPrev_Ages_60_85, device = 'tiff', width=10, height=7, units ='in', dpi=300, compression = 'lzw')

```

<br>
<br>

```{r, warning=FALSE, echo=FALSE, message=FALSE}

Inc <- ggplot(data=inc_by_terr_stack_ages %>% filter(Age == '> 85'), aes(x=Year, y=Count, fill=Territory, label=Count)) + 
geom_bar(position = 'stack',stat = 'identity') +
labs(x = 'Year',  y = 'Patients', title='Incidence') +
scale_x_continuous(breaks=seq(0,2022, 3)) +
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 10), axis.text.y = element_text(size = 10),  axis.title.x = element_text(size = 10), axis.text.x = element_text(size = 10), axis.line.x = element_line(),legend.text = element_text(size = 10), legend.title = element_text(size = 10), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none') +
scale_fill_manual(values=cbPalette)

```

```{r, warning=FALSE, echo=FALSE, message=FALSE}

Prev <- ggplot(data=prev_by_terr_stack_ages %>% filter(Age == '> 85'), aes(x=factor(year), y=count, fill=Territory, label=count)) + 
geom_bar(position = 'stack',stat = 'identity') +
labs(x = 'Year', y = 'Patients', color = 'Legend', title = 'Prevalence') +
scale_x_discrete(breaks=seq(0,2022, 3)) +
scale_fill_manual(values=cbPalette)+ 
theme(plot.title = element_text(size =15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 10), axis.title.x = element_text(size = 10), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 15), legend.title = element_text(size = 15), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'none')
```

```{r, include=FALSE}

Inc_line_100k <- ggplot(data=inc_by_terr_stack_ages_denom %>% filter(Age == '> 85'), aes(x=factor(Year), color=Territory)) + 
geom_line(aes(y=total_Per100k, group = Territory), size=1) +
geom_point(aes(y=total_Per100k, group = Territory), size=2) +
labs(x = 'Year', y = 'Patients (per 100,000)', color = 'Legend', title = 'Incidence (per 100,000)') +
scale_color_manual(values=cbPalette)+    
scale_x_discrete(breaks=seq(0,2022, 3)) +
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.x = element_text(size = 10), axis.title.y = element_text(size = 10), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 10), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank(), legend.position = 'right')

```

```{r, include=FALSE}

Prev_line_100k <- ggplot(data=prev_by_terr_stack_ages_denom %>% filter(Age == '> 85'), aes(x=factor(year), color=Territory)) + 
geom_line(aes(y=total_Per100k, group = Territory), size=1) +
geom_point(aes(y=total_Per100k, group = Territory), size=2) +
scale_x_discrete(breaks=seq(2010,2023,3)) +
labs(x = 'Year', y = 'Patients (per 100,000)', color = 'Legend', title = 'Prevalence (per 100,000)') +
scale_color_manual(values=cbPalette)+ 
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_text(size = 10), axis.title.x = element_text(size = 10), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 10), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

```

```{r, echo=FALSE,  fig.width=10, fig.height=7, fig.align = 'center'}

FourPanelIncPrev_Ages_O85 <- egg::ggarrange(Prev, Prev_line_100k, Inc, Inc_line_100k, ncol=2)

```

```{r, echo = FALSE}

#ggsave(filename = 'FourPanelIncPrev_Ages_O85.tiff', plot = FourPanelIncPrev_Ages_O85, device = 'tiff', width=10, height=7, units ='in', dpi=300, compression = 'lzw')

```

<br>
<br>

### LDL-C Control by age group

```{r, include=FALSE}

MIN_LDL_Test_2010_2022_PREV_AGES <- db2_run(conn = Connection, query = 'SELECT year(TEST) AS event_year, age_cat, MIN_LDL AS MIN_LDL FROM SAILW1483V.TEMP_LDL_CONTROL_PREV_AGES WHERE MIN_LDL <= 10')

MIN_LDL_Test_2010_PREV_AGES <- subset(subset(MIN_LDL_Test_2010_2022_PREV_AGES, event_year == 2010), !is.na(event_year))
MIN_LDL_Test_2022_PREV_AGES <- subset(subset(MIN_LDL_Test_2010_2022_PREV_AGES, event_year == 2022), !is.na(event_year))

MIN_LDL_Test_2010_U60_PREV <- subset(MIN_LDL_Test_2010_PREV_AGES, age_cat == '< 60')
MIN_LDL_Test_2010_60_85_PREV <-  subset(MIN_LDL_Test_2010_PREV_AGES, age_cat == '60 - 85')
MIN_LDL_Test_2010_O85_PREV <- subset(MIN_LDL_Test_2010_PREV_AGES, age_cat == '> 85')
MIN_LDL_Test_2022_U60_PREV <- subset(MIN_LDL_Test_2022_PREV_AGES, age_cat == '< 60')
MIN_LDL_Test_2022_60_85_PREV <-  subset(MIN_LDL_Test_2022_PREV_AGES, age_cat == '60 - 85')
MIN_LDL_Test_2022_O85_PREV <- subset(MIN_LDL_Test_2022_PREV_AGES, age_cat == '> 85')

```

```{r, include=FALSE}

L<-seq(0,4,0.001)

#2010 - All patients
LDL_2010_min_PREV<-MIN_LDL_Test_2010_PREV$min_ldl
y<-ecdf(LDL_2010_min_PREV)(L)
LDL_2010_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_S <- ggplot(LDL_2010_min_PREV,aes(x=L,y=y))+
labs(title='2010')+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4)) +
geom_vline(xintercept=1.8,linetype="dashed")+
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+
theme(plot.title = element_text(size = 15, hjust=0.5),panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - U60
LDL_2010_U60_min_PREV<-MIN_LDL_Test_2010_U60_PREV$min_ldl
y<-ecdf(LDL_2010_U60_min_PREV)(L)
df_LDL_2010_U60_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_U60_S <- ggplot(df_LDL_2010_U60_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8), axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - 60_85
LDL_2010_60_85_min_PREV<-MIN_LDL_Test_2010_60_85_PREV$min_ldl
y<-ecdf(LDL_2010_60_85_min_PREV)(L)
df_LDL_2010_60_85_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_60_85_S <- ggplot(df_LDL_2010_60_85_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+  
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - O85
LDL_2010_O85_min_PREV<-MIN_LDL_Test_2010_O85_PREV$min_ldl
y<-ecdf(LDL_2010_O85_min_PREV)(L)
df_LDL_2010_O85_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_O85_S <- ggplot(df_LDL_2010_O85_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+  
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_text(face="bold",family="Arial",size=8))


#2022 - All patients
LDL_2022_min_PREV<-MIN_LDL_Test_2022_PREV$min_ldl
y<-ecdf(LDL_2022_min_PREV)(L)
LDL_2022_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2022_S <- ggplot(LDL_2022_min_PREV,aes(x=L,y=y))+
labs(title='2022')+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+  
theme(plot.title = element_text(size = 15, hjust=0.5),panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2022 - U60
LDL_2022_U60_min_PREV<-MIN_LDL_Test_2022_U60_PREV$min_ldl
y<-ecdf(LDL_2022_U60_min_PREV)(L)
df_LDL_2022_U60_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2022_U60_S <- ggplot(df_LDL_2022_U60_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2022 - 60_85
LDL_2022_60_85_min_PREV<-MIN_LDL_Test_2022_60_85_PREV$min_ldl
y<-ecdf(LDL_2022_60_85_min_PREV)(L)
df_LDL_2022_60_85_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2022_60_85_S <- ggplot(df_LDL_2022_60_85_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2022 - O85
LDL_2022_O85_min_PREV<-MIN_LDL_Test_2022_O85_PREV$min_ldl
y<-ecdf(LDL_2022_O85_min_PREV)(L)
df_LDL_2022_O85_min_PREV<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2022_O85_S <- ggplot(df_LDL_2022_O85_min_PREV,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+   
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

```

```{r, echo=FALSE, fig.width=5, fig.height=8, fig.align = 'center', message=FALSE, warning=FALSE}

LDL_S_Prev_AGES <- LDL_2010_S + LDL_2022_S + LDL_2010_U60_S + LDL_2022_U60_S + LDL_2010_60_85_S + LDL_2022_60_85_S + LDL_2010_O85_S + LDL_2022_O85_S + plot_layout(ncol = 2) + plot_annotation(title = 'Prevalent', theme=theme(plot.title = element_text(hjust = 0.5, size = 17)))

LDL_S_Prev_AGES

```

```{r, echo = FALSE}

#ggsave(filename = 'LDL_S_Prev_AGES.tiff', plot = LDL_S_Prev_AGES, device = 'tiff', width=5, height=8, units ='in', dpi=300, compression = 'lzw')

```

<br>
<br>

```{r, include=FALSE}

MIN_LDL_Test_2010_2021_AGES <- db2_run(conn = Connection, query = 'SELECT year(DIAG) AS event_year, age_cat, MIN_LDL AS MIN_LDL FROM SAILW1483V.TEMP_LDL_CONTROL_AGES WHERE MIN_LDL <= 10')

MIN_LDL_Test_2010_AGES <- subset(subset(MIN_LDL_Test_2010_2021_AGES, event_year == 2010), !is.na(event_year))
MIN_LDL_Test_2021_AGES <- subset(subset(MIN_LDL_Test_2010_2021_AGES, event_year == 2021), !is.na(event_year))

MIN_LDL_Test_2010_U60 <- subset(MIN_LDL_Test_2010_AGES, age_cat == '< 60')
MIN_LDL_Test_2010_60_85 <-  subset(MIN_LDL_Test_2010_AGES, age_cat == '60 - 85')
MIN_LDL_Test_2010_O85 <- subset(MIN_LDL_Test_2010_AGES, age_cat == '> 85')
MIN_LDL_Test_2021_U60 <- subset(MIN_LDL_Test_2021_AGES, age_cat == '< 60')
MIN_LDL_Test_2021_60_85 <-  subset(MIN_LDL_Test_2021_AGES, age_cat == '60 - 85')
MIN_LDL_Test_2021_O85 <- subset(MIN_LDL_Test_2021_AGES, age_cat == '> 85')

```

```{r, include=FALSE}

L<-seq(0,4,0.001)

#2010 - All patients
LDL_2010_min<-MIN_LDL_Test_2010$min_ldl
y<-ecdf(LDL_2010_min)(L)
LDL_2010_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_S <- ggplot(LDL_2010_min,aes(x=L,y=y))+
labs(title='2010')+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4)) +
geom_vline(xintercept=1.8,linetype="dashed")+
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+
theme(plot.title = element_text(size = 15, hjust=0.5),panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - U60
LDL_2010_U60_min<-MIN_LDL_Test_2010_U60$min_ldl
y<-ecdf(LDL_2010_U60_min)(L)
df_LDL_2010_U60_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_U60_S <- ggplot(df_LDL_2010_U60_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8), axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - 60_85
LDL_2010_60_85_min<-MIN_LDL_Test_2010_60_85$min_ldl
y<-ecdf(LDL_2010_60_85_min)(L)
df_LDL_2010_60_85_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_60_85_S <- ggplot(df_LDL_2010_60_85_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+  
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_text(face="bold",family="Arial",size=8))

#2010 - O85
LDL_2010_O85_min<-MIN_LDL_Test_2010_O85$min_ldl
y<-ecdf(LDL_2010_O85_min)(L)
df_LDL_2010_O85_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2010_O85_S <- ggplot(df_LDL_2010_O85_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(labels = percent, name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+  
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_text(face="bold",family="Arial",size=8))


#2021 - All patients
LDL_2021_min<-MIN_LDL_Test_2021$min_ldl
y<-ecdf(LDL_2021_min)(L)
LDL_2021_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2021_S <- ggplot(LDL_2021_min,aes(x=L,y=y))+
labs(title='2021')+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+  
theme(plot.title = element_text(size = 15, hjust=0.5),panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2021 - U60
LDL_2021_U60_min<-MIN_LDL_Test_2021_U60$min_ldl
y<-ecdf(LDL_2021_U60_min)(L)
df_LDL_2021_U60_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2021_U60_S <- ggplot(df_LDL_2021_U60_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2021 - 60_85
LDL_2021_60_85_min<-MIN_LDL_Test_2021_60_85$min_ldl
y<-ecdf(LDL_2021_60_85_min)(L)
df_LDL_2021_60_85_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2021_60_85_S <- ggplot(df_LDL_2021_60_85_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+ 
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

#2021 - O85
LDL_2021_O85_min<-MIN_LDL_Test_2021_O85$min_ldl
y<-ecdf(LDL_2021_O85_min)(L)
df_LDL_2021_O85_min<-data.frame(L,y)
Pct_at_threshold <- y[1801]

LDL_2021_O85_S <- ggplot(df_LDL_2021_O85_min,aes(x=L,y=y))+
geom_smooth(size=1, colour = cbPalette_Overall[1])+
scale_y_continuous(name="Cumulative percent",limits = c(0,1),breaks = c(0,0.2,0.4,0.6,0.8,1), labels=NULL, sec.axis = sec_axis(~., breaks=Pct_at_threshold, labels = percent))+
scale_x_continuous(name="Lowest LDL-C level (mmol/L)",breaks =c(0,1,1.8,3,4))+
geom_vline(xintercept=1.8,linetype="dashed")+ 
geom_hline(yintercept=Pct_at_threshold,linetype="dashed")+   
theme(panel.grid.major.x = element_blank(),panel.grid.major.y = element_line(size=0.4,color="grey"),panel.grid.minor=element_blank(),panel.background=element_blank(),axis.line =element_line(colour="black"),axis.title.x = element_text(face="bold",family="Arial",size=8),axis.title.y = element_blank())

```

```{r, echo=FALSE, fig.width=5, fig.height=8, fig.align = 'center', message=FALSE, warning=FALSE}

LDL_S_Inc_AGES <- LDL_2010_S + LDL_2021_S + LDL_2010_U60_S + LDL_2021_U60_S + LDL_2010_60_85_S + LDL_2021_60_85_S + LDL_2010_O85_S + LDL_2021_O85_S + plot_layout(ncol = 2) + plot_annotation(title = 'Incident', theme=theme(plot.title = element_text(hjust = 0.5, size = 17)))

LDL_S_Inc_AGES

```

```{r, echo = FALSE}

#ggsave(filename = 'LDL_S_Inc_AGES.tiff', plot = LDL_S_Inc_AGES, device = 'tiff', width=5, height=8, units ='in', dpi=300, compression = 'lzw')

```

<br>
<br>

### LLT by age group

```{r, include=FALSE}

#Controlled

LLT_AGES_PREV <- db2_run(conn = Connection, query = 'SELECT YR AS YEAR, LLT, AGE_CAT, COUNT(LLT) AS LLT FROM SAILW1483V.TEMP_PREV_LLT_AGES GROUP BY YR, AGE_CAT, LLT ORDER BY YR, AGE_CAT, LLT')

LLT_AGES_PREV$llt_1[LLT_AGES_PREV$llt_1 < 10] <- 10
LLT_AGES_PREV <- subset(LLT_AGES_PREV, LLT_AGES_PREV$year < 2023)

#Rename columns
names(LLT_AGES_PREV)[names(LLT_AGES_PREV)=='age_cat'] <- 'Age'
names(LLT_AGES_PREV)[names(LLT_AGES_PREV)=='llt'] <- 'LLT'
names(LLT_AGES_PREV)[names(LLT_AGES_PREV)=='llt_1'] <- 'Count'

LLT_AGES_PREV$LLT <- replace(LLT_AGES_PREV$LLT, LLT_AGES_PREV$LLT == 'HIGH_STATIN', 'High-intensity statin')
LLT_AGES_PREV$LLT <- replace(LLT_AGES_PREV$LLT, LLT_AGES_PREV$LLT == 'LOW_STATIN', 'Non-high-intensity statin')
LLT_AGES_PREV$LLT <- replace(LLT_AGES_PREV$LLT, LLT_AGES_PREV$LLT == 'NOTX', 'No treatment')
LLT_AGES_PREV$LLT <- replace(LLT_AGES_PREV$LLT, LLT_AGES_PREV$LLT == 'INEGY', 'Combination statin')
LLT_AGES_PREV$LLT <- replace(LLT_AGES_PREV$LLT, LLT_AGES_PREV$LLT == 'STATIN_COMBI', 'Combination statin')
LLT_AGES_PREV$LLT <- replace(LLT_AGES_PREV$LLT, LLT_AGES_PREV$LLT == 'OTHER', 'Other treatment')

LLT_AGES_PREV$LLT <- factor(LLT_AGES_PREV$LLT, levels= c('Combination statin', 'High-intensity statin', 'Non-high-intensity statin', 'Other treatment', 'No treatment'))
LLT_AGES_PREV$Age <- factor(LLT_AGES_PREV$Age, levels= c('< 60', '60 - 85', '> 85'))
LLT_AGES_PREV$Group <- 'Prevalent'

```

```{r, include=FALSE}

#Controlled

LLT_AGES <- db2_run(conn = Connection, query = 'SELECT DRUG_YR AS YEAR, LLT, AGE_CAT, COUNT(LLT) AS LLT FROM SAILW1483V.TEMP_INC_LLT_AGES GROUP BY DRUG_YR, AGE_CAT, LLT ORDER BY DRUG_YR, AGE_CAT, LLT')

LLT_AGES$llt_1[LLT_AGES$llt_1 < 10] <- 10
LLT_AGES <- subset(LLT_AGES, LLT_AGES$year < 2022)

#Rename columns
names(LLT_AGES)[names(LLT_AGES)=='age_cat'] <- 'Age'
names(LLT_AGES)[names(LLT_AGES)=='llt'] <- 'LLT'
names(LLT_AGES)[names(LLT_AGES)=='llt_1'] <- 'Count'

LLT_AGES$LLT <- replace(LLT_AGES$LLT, LLT_AGES$LLT == 'HIGH_STATIN', 'High-intensity statin')
LLT_AGES$LLT <- replace(LLT_AGES$LLT, LLT_AGES$LLT == 'LOW_STATIN', 'Non-high-intensity statin')
LLT_AGES$LLT <- replace(LLT_AGES$LLT, LLT_AGES$LLT == 'NOTX', 'No treatment')
LLT_AGES$LLT <- replace(LLT_AGES$LLT, LLT_AGES$LLT == 'INEGY', 'Combination statin')
LLT_AGES$LLT <- replace(LLT_AGES$LLT, LLT_AGES$LLT == 'STATIN_COMBI', 'Combination statin')
LLT_AGES$LLT <- replace(LLT_AGES$LLT, LLT_AGES$LLT == 'OTHER', 'Other treatment')

LLT_AGES$LLT <- factor(LLT_AGES$LLT, levels= c('Combination statin', 'High-intensity statin', 'Non-high-intensity statin', 'Other treatment', 'No treatment'))
LLT_AGES$Age <- factor(LLT_AGES$Age, levels= c('< 60', '60 - 85', '> 85'))
LLT_AGES$Group <- 'Incident'

```

```{r, include=FALSE}

LLT_AGES_Comb <- rbind(LLT_AGES, LLT_AGES_PREV)
LLT_AGES_Comb$Group <- factor(LLT_AGES_Comb$Group, levels= c('Prevalent', 'Incident'))

```

```{r, echo=FALSE, fig.width=12, fig.height=6, fig.align = 'center', message=FALSE, warning=FALSE}

AGES_LLT <- ggplot(data=LLT_AGES_Comb, aes(x=year, y=Count, fill=LLT)) + 
geom_bar(position = 'fill',stat = 'identity') +
labs(x = 'Year', y = 'Proportion', color = 'Legend', legend='LLT') +
scale_x_continuous(breaks=seq(0,2022, 2)) +
scale_fill_manual(values=cbPalette)+ 
facet_grid(vars(Group),vars(Age))+
theme(plot.title = element_text(size = 15, hjust=0.5), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title = element_text(size = 11), axis.text.y = element_text(size = 10), axis.text.x = element_text(size = 10), legend.text = element_text(size = 10), legend.title = element_text(size = 11), axis.line.x = element_line(), axis.line.y = element_line(), panel.background = element_blank())

AGES_LLT

```

```{r, echo = FALSE}

#ggsave(filename = 'AGES_LLT.tiff', plot = AGES_LLT, device = 'tiff', width=12, height=6, units ='in', dpi=300, compression = 'lzw')

```

<br>
<br>

## Supplementary Tables

### Incident Baseline Cohort Characteristics - Follow-up Comp.

```{r, include=FALSE}

# Query master table in DB2

Cohort_Master <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.COHORT_MASTER_FINAL WHERE INCIDENT = 1')

```

```{r, include=FALSE}

Cohort_Master$diabetes_before <- replace(Cohort_Master$diabetes_before, Cohort_Master$diabetes_before == '0', '')
Cohort_Master$diabetes_before <- replace(Cohort_Master$diabetes_before, Cohort_Master$diabetes_before == '1', 'Diabetes')

Cohort_Master$dementia_before <- replace(Cohort_Master$dementia_before, Cohort_Master$dementia_before == '0', '')
Cohort_Master$dementia_before <- replace(Cohort_Master$dementia_before, Cohort_Master$dementia_before == '1', 'Dementia')

Cohort_Master$malignant_before <- replace(Cohort_Master$malignant_before, Cohort_Master$malignant_before == '0', '')
Cohort_Master$malignant_before <- replace(Cohort_Master$malignant_before, Cohort_Master$malignant_before == '1', 'Malignant')

Cohort_Master$asthma_before <- replace(Cohort_Master$asthma_before, Cohort_Master$asthma_before == '0', '')
Cohort_Master$asthma_before <- replace(Cohort_Master$asthma_before, Cohort_Master$asthma_before == '1', 'Asthma')

Cohort_Master$copd_before <- replace(Cohort_Master$copd_before, Cohort_Master$copd_before == '0', '')
Cohort_Master$copd_before <- replace(Cohort_Master$copd_before, Cohort_Master$copd_before == '1', 'COPD')

Cohort_Master$liver_before <- replace(Cohort_Master$liver_before, Cohort_Master$liver_before == '0', '')
Cohort_Master$liver_before <- replace(Cohort_Master$liver_before, Cohort_Master$liver_before == '1', 'Liver Disease')

Cohort_Master$renal_before <- replace(Cohort_Master$renal_before, Cohort_Master$renal_before == '0', '')
Cohort_Master$renal_before <- replace(Cohort_Master$renal_before, Cohort_Master$renal_before == '1', 'CKD')

Cohort_Master$resp_before <- replace(Cohort_Master$resp_before, Cohort_Master$resp_before == '0', '')
Cohort_Master$resp_before <- replace(Cohort_Master$resp_before, Cohort_Master$resp_before == '1', 'Respiratory Disease')

Cohort_Master$hf_before <- replace(Cohort_Master$hf_before, Cohort_Master$hf_before == '0', '')
Cohort_Master$hf_before <- replace(Cohort_Master$hf_before, Cohort_Master$hf_before == '1', 'Heart Failure')

Cohort_Master$hypertension_before <- replace(Cohort_Master$hypertension_before, Cohort_Master$hypertension_before == '0', '')
Cohort_Master$hypertension_before <- replace(Cohort_Master$hypertension_before, Cohort_Master$hypertension_before == '1', 'Hypertension')

Cohort_Master$Comorbidities <- paste(Cohort_Master$diabetes_before, Cohort_Master$dementia_before, Cohort_Master$malignant_before, Cohort_Master$asthma_before, Cohort_Master$copd_before, Cohort_Master$liver_before, Cohort_Master$renal_before, Cohort_Master$resp_before, Cohort_Master$hf_before, Cohort_Master$hypertension_before, sep=' ')

Cohort_Master$smoking_status <- replace(Cohort_Master$smoking_status, Cohort_Master$smoking_status == 'E', 'Ex-smoker')
Cohort_Master$smoking_status <- replace(Cohort_Master$smoking_status, Cohort_Master$smoking_status == 'N', 'Non-smoker')
Cohort_Master$smoking_status <- replace(Cohort_Master$smoking_status, Cohort_Master$smoking_status == 'S', 'Active smoker')

Cohort_Master$weight_cat <- ifelse(is.na(Cohort_Master$weight_cat), 'UN', Cohort_Master$weight_cat)
Cohort_Master$weight_cat <- ifelse(is.na(Cohort_Master$bmi), 'UN', Cohort_Master$weight_cat)

Cohort_Master$weight_cat <- replace(Cohort_Master$weight_cat, Cohort_Master$weight_cat == 'OW', 'Overweight')
Cohort_Master$weight_cat <- replace(Cohort_Master$weight_cat, Cohort_Master$weight_cat == 'UW', 'Underweight')
Cohort_Master$weight_cat <- replace(Cohort_Master$weight_cat, Cohort_Master$weight_cat == 'N', 'Normal weight')
Cohort_Master$weight_cat <- replace(Cohort_Master$weight_cat, Cohort_Master$weight_cat == 'NORM', 'Normal weight')
Cohort_Master$weight_cat <- replace(Cohort_Master$weight_cat, Cohort_Master$weight_cat == 'OB', 'Obese')
Cohort_Master$weight_cat <- replace(Cohort_Master$weight_cat, Cohort_Master$weight_cat == 'UN', 'Unknown')

Cohort_Master$ethnicity <- replace(Cohort_Master$ethnicity, Cohort_Master$ethnicity == 'Other', NA)
Cohort_Master$ethnicity <- ifelse(is.na(Cohort_Master$ethnicity), 'Unknown', Cohort_Master$ethnicity)

```

```{r, include=FALSE}

#Table 1

#Transformations
colnames(Cohort_Master)[2] <- 'Sex'
Cohort_Master$Sex <- replace(Cohort_Master$Sex, Cohort_Master$Sex == 1, 'Male')
Cohort_Master$Sex <- replace(Cohort_Master$Sex, Cohort_Master$Sex == 2, 'Female')
Cohort_Master$Sex <- replace(Cohort_Master$Sex, Cohort_Master$Sex == 0, NA)
Cohort_Master$Sex <- replace(Cohort_Master$Sex, Cohort_Master$Sex == 3, NA)
Cohort_Master$Sex <- replace(Cohort_Master$Sex, Cohort_Master$Sex == 9, NA)

Cohort_Master$type <- replace(Cohort_Master$type, Cohort_Master$type == 'ST', 'Stroke')

Cohort_Master$censor_reason <- replace(Cohort_Master$censor_reason, Cohort_Master$censor_reason == 'DEATH', 'Death')
Cohort_Master$censor_reason <- replace(Cohort_Master$censor_reason, Cohort_Master$censor_reason == 'GP_LOSS', 'GP Registration Loss')
Cohort_Master$censor_reason <- replace(Cohort_Master$censor_reason, Cohort_Master$censor_reason == 'MIGRATION', 'Migration Loss')

Cohort_Master$has_2_terr <- replace(Cohort_Master$has_2_terr, Cohort_Master$has_2_terr == '0', '')
Cohort_Master$has_2_terr <- replace(Cohort_Master$has_2_terr, Cohort_Master$has_2_terr == '1', ' ')

Cohort_Master$has_3_terr <- replace(Cohort_Master$has_3_terr, Cohort_Master$has_3_terr == '0', '')
Cohort_Master$has_3_terr <- replace(Cohort_Master$has_3_terr, Cohort_Master$has_3_terr == '1', ' ')

Cohort_Master$type <- ifelse(Cohort_Master$index_multi_terr == 1, 'Poly-vascular', Cohort_Master$type)

Cohort_Master$type <- factor(Cohort_Master$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

Cohort_Master$weight_cat <- factor(Cohort_Master$weight_cat, levels= c('Obese', 'Overweight', 'Normal weight', 'Underweight', 'Unknown'))

Cohort_Master$ethnicity <- factor(Cohort_Master$ethnicity, levels= c('White', 'Asian', 'Black',  'Mixed', 'Unknown'))

```


```{r, include=FALSE}

#Cohort characteristics - incident

tab_inc <- table1(subset(Cohort_Master, Cohort_Master$first_year >= 2010), 
       'Sex' = Sex, 
       'Age at entry/diagnosis' = age_diag, 
       'Age at death' = age_at_death, 
       'Territory' = type, 
       'Respiratory Disease' = factor(ifelse(grepl('Respiratory Disease', Comorbidities), ' ', '')),
       'Dementia' = factor(ifelse(grepl('Dementia', Comorbidities), ' ', '')),      
       'CKD' = factor(ifelse(grepl('CKD', Comorbidities), ' ', '')),
       'Liver Disease' = factor(ifelse(grepl('Liver Disease', Comorbidities), ' ', '')),          
       'Diabetes' = factor(ifelse(grepl('Diabetes', Comorbidities), ' ', '')), 
       'Heart Failure' = factor(ifelse(grepl('Heart Failure', Comorbidities), ' ', '')),
       'Hypertension' = factor(ifelse(grepl('Hypertension', Comorbidities), ' ', '')),       
       'Smoker Status' = smoking_status,
       'Weight' = weight_cat,
       'BMI' = bmi,
       'Ethnicity' = ethnicity,
       'WIMD' = factor(wimd_2019_quintile),
        splitby = ~inc_cat,
        na.rm=FALSE)

tab_inc <- as.data.frame(tab_inc)
```

```{r, include=FALSE}

tab_comb <- tab_inc

#Rename columns
names(tab_comb)[names(tab_comb)=='...1.year.follow.up'] <- '>= 1 year follow-up'
names(tab_comb)[names(tab_comb)=='Lost.to.death'] <- 'Lost to death'
names(tab_comb)[names(tab_comb)=='Lost.to.follow.up'] <- 'Lost to follow-up'
names(tab_comb)[names(tab_comb)=='.'] <- ''

#Reorder columns
tab_comb <- tab_comb[, c(1,3,4,2)]

tab_comb[7,1] <- 'Entry to study'
tab_comb[9,1] <- 'Death'
tab_comb[18,1] <- 'Respiratory Disease'
tab_comb[22,1] <- 'Dementia'
tab_comb[26,1] <- 'CKD'
tab_comb[30,1] <- 'Liver Disease'
tab_comb[34,1] <- 'Diabetes'
tab_comb[38,1] <- 'Heart Failure'
tab_comb[42,1] <- 'Hypertension'
tab_comb[48,1] <- 'Unknown'
tab_comb[71,1] <- 'Unknown'

#Remove rows
tab_comb <- tab_comb[-c(2,3,5,6,8,9,10,11,12,13,14,15,16,17,19,20,21,23,24,25,27,28,29,31,32,33,35,36,37,38,39,40,41,43,44,49,55,56,58,59,60,61,62,63,64,65),]

rownames(tab_comb) <- NULL

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
tab_comb %>% 
  kbl(caption = 'Table 1.Cohort characteristics and comorbidities, for incident cases who had at least 1 year follow-up, and those who did not due to death or loss to follow-up.') %>%
  pack_rows('Sex',2,2, label_row_css = 'background-color: #999; color: #fff') %>%
  pack_rows('Age (years)',3,3, label_row_css = 'background-color: #999; color: #fff') %>%
  pack_rows('Comorbidities',4,9, label_row_css = 'background-color: #999; color: #fff') %>%
  pack_rows('Smoker status',10,13, label_row_css = 'background-color: #999; color: #fff') %>%  
  pack_rows('Weight',14,18, label_row_css = 'background-color: #999; color: #fff') %>% 
  pack_rows('Body Mass Index (BMI)',19,19, label_row_css = 'background-color: #999; color: #fff') %>% 
  pack_rows('Welsh Index of Multiple Deprivation (WIMD) Quintile',20,25, label_row_css = 'background-color: #999; color: #fff') %>% 
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  column_spec(1, border_right = T) %>%
  column_spec(2, border_right = T) %>%
  column_spec(3, border_right = T) %>%  
  footnote(general = 'Categorical descriptors are presented as the % of the cohort included in that category. Continuous descriptors are presented as mean(SD).') %>%
  kable_paper()
```

<br>
<br>

### Incidence and Prevalence  

```{r, include=FALSE}

#Starting with denominator
denominator_yr$Name <- 'Denominator'

Base_df <- denominator_yr %>% dplyr::select(Year, Name, Denom) %>% pivot_wider(names_from = Year, values_from = Denom)

Base_df[1,1] <- ' '

```

```{r, include=FALSE}

#Adding prevalence per year, first raw then per 100k
Prev_base_raw <- prev_by_terr_stack %>% dplyr::select(Year, Territory, Count) %>% pivot_wider(names_from = Year, values_from = Count) %>% arrange(Territory)
colnames(Prev_base_raw)[1] <- 'Name'
Prev_base_raw <- Insert_total_of_n(Prev_base_raw,4)

Prev_base_100k <- prev_by_terr_stack %>% dplyr::select(Year, Territory, total_Per100k) %>% pivot_wider(names_from = Year, values_from = total_Per100k) %>% arrange(Territory)
colnames(Prev_base_100k)[1] <- 'Name'
Prev_base_100k <- Insert_total_of_n(Prev_base_100k,4)

Base_df <- rbind(Base_df, Prev_base_raw)
Base_df <- rbind(Base_df, Prev_base_100k)

```

```{r, include=FALSE}

#Adding incidence per year, first raw then per 100k
Inc_base_raw <- inc_by_terr_stack %>% dplyr::select(Year, Territory, Count) %>% pivot_wider(names_from = Year, values_from = Count)
colnames(Inc_base_raw)[1] <- 'Name'
Inc_base_raw <- Insert_total_of_n(Inc_base_raw,4)

Inc_base_100k <- inc_by_terr_stack %>% dplyr::select(Year, Territory, total_Per100k) %>% pivot_wider(names_from = Year, values_from = total_Per100k)
colnames(Inc_base_100k)[1] <- 'Name'
Inc_base_100k <- Insert_total_of_n(Inc_base_100k,4)

Base_df <- rbind(Base_df, Inc_base_raw)
Base_df <- rbind(Base_df, Inc_base_100k)

```

```{r, include=FALSE}

#Replace nulls
Base_df[is.na(Base_df)] <- 0

Base_df_char <- Base_df %>% mutate(across(where(is.numeric), as.character))

colnames(Base_df_char)[1] <- ' '

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

Base_df_char %>%
  kbl(caption = 'Suppl Table X. Prevalence and Incidence of ASCVD.') %>%
  pack_rows(index = c('Population denominator'=1,
                      'Prevalence'=5,
                      'Prevalence (per 100,000)'=5,                    
                      'Incidence'=5,
                      'Incidence (per 100,000)'=5),
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()

```

<br>
<br>

### LLT

```{r, include=FALSE}

Base_df <- denominator_yr %>% dplyr::select(Year, Name, Denom) %>% pivot_wider(names_from = Year, values_from = Denom)

Base_df[1,1] <- ' '

```

```{r, include=FALSE}

#Adding prevalent treated per year, by treatment, first raw then % treated
names(LLT_2010_2022_PREV_ALL)[names(LLT_2010_2022_PREV_ALL)=='year'] <- 'Year'

#Denominator
LLT_2010_2022_PREV_ALL_Denom <- LLT_2010_2022_PREV_ALL %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_Inc_Grouped_Prev_Long <- LLT_2010_2022_PREV_ALL %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year,LLT) %>% summarise(Treated = sum(Treated))

LLT_2010_2022_PREV_ALL_Grouped <- LLT_Inc_Grouped_Prev_Long %>% inner_join(LLT_2010_2022_PREV_ALL_Denom, by = c('Year' = 'Year'))
LLT_2010_2022_PREV_ALL_Grouped$pct_treated <- round((LLT_2010_2022_PREV_ALL_Grouped$Treated/LLT_2010_2022_PREV_ALL_Grouped$Total)*100,2)

#Prevalent Overall
LLT_Inc_Grouped_Prev <- LLT_2010_2022_PREV_ALL_Grouped %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_Grouped_Prev)[1] <- 'Name'
LLT_Inc_Grouped_Prev <- Insert_total_of_n(LLT_Inc_Grouped_Prev,5)

LLT_Inc_Grouped_pct_Prev <- LLT_2010_2022_PREV_ALL_Grouped %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = pct_treated) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_Grouped_pct_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_Inc_Grouped_Prev)
Base_df <- rbind(Base_df, LLT_Inc_Grouped_pct_Prev)

#Remove denominator row
Base_df <- Base_df[2:12,]

#Adding incident treated per year, by treatment, first raw then % treated
names(LLT_2010_2021)[names(LLT_2010_2021)=='year'] <- 'Year'

#Denominator
LLT_2010_2022_Denom <- LLT_2010_2021 %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_Inc_Grouped_Long <- LLT_2010_2021 %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year,LLT) %>% summarise(Treated = sum(Treated))

LLT_2010_2021_Grouped <- LLT_Inc_Grouped_Long %>% inner_join(LLT_2010_2022_Denom, by = c('Year' = 'Year'))
LLT_2010_2021_Grouped$pct_treated <- round((LLT_2010_2021_Grouped$Treated/LLT_2010_2021_Grouped$Total)*100,2)

##Incident Overall
LLT_Inc_Grouped <- LLT_2010_2021_Grouped %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_Grouped)[1] <- 'Name'
LLT_Inc_Grouped <- Insert_total_of_n(LLT_Inc_Grouped,5)

LLT_Inc_Grouped_pct <- LLT_2010_2021_Grouped %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = pct_treated) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_Grouped_pct)[1] <- 'Name'

LLT_Inc_Grouped$'2022' <- 'N/A'
LLT_Inc_Grouped_pct$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LLT_Inc_Grouped)
Base_df <- rbind(Base_df, LLT_Inc_Grouped_pct)


# IHD
LLT_2010_2022_PREV_ALL_IHD <- subset(LLT_2010_2022_PREV_ALL, LLT_2010_2022_PREV_ALL$type == 'IHD')

#Denominator
LLT_2010_2022_PREV_ALL_Denom_IHD <- LLT_2010_2022_PREV_ALL_IHD %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_Inc_Grouped_Prev_Long_IHD <- LLT_2010_2022_PREV_ALL_IHD %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year,LLT) %>% summarise(Treated = sum(Treated))

LLT_2010_2022_PREV_ALL_IHD_Calc <- LLT_Inc_Grouped_Prev_Long_IHD %>% inner_join(LLT_2010_2022_PREV_ALL_Denom_IHD, by = c('Year' = 'Year'))
LLT_2010_2022_PREV_ALL_IHD_Calc$pct_treated <- round((LLT_2010_2022_PREV_ALL_IHD_Calc$Treated/LLT_2010_2022_PREV_ALL_IHD_Calc$Total)*100,2)

LLT_Inc_IHD_Grouped_Prev <- LLT_2010_2022_PREV_ALL_IHD_Calc %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_IHD_Grouped_Prev)[1] <- 'Name'
LLT_Inc_IHD_Grouped_Prev <- Insert_total_of_n(LLT_Inc_IHD_Grouped_Prev,5)

LLT_Inc_IHD_Grouped_pct_Prev <- LLT_2010_2022_PREV_ALL_IHD_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_IHD_Grouped_pct_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_Inc_IHD_Grouped_Prev)
Base_df <- rbind(Base_df, LLT_Inc_IHD_Grouped_pct_Prev)

# IHD
LLT_2010_2021_IHD <- subset(LLT_2010_2021, LLT_2010_2021$type == 'IHD')

#Denominator
LLT_2010_2022_Denom_IHD <- LLT_2010_2021_IHD %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_Inc_Grouped_Long_IHD <- LLT_2010_2021_IHD %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year,LLT) %>% summarise(Treated = sum(Treated))

LLT_2010_2021_IHD_Calc <- LLT_Inc_Grouped_Long_IHD %>% inner_join(LLT_2010_2022_Denom_IHD, by = c('Year' = 'Year'))
LLT_2010_2021_IHD_Calc$pct_treated <- round((LLT_2010_2021_IHD_Calc$Treated/LLT_2010_2021_IHD_Calc$Total)*100,2)

LLT_Inc_IHD_Grouped <- LLT_2010_2021_IHD_Calc %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_IHD_Grouped)[1] <- 'Name'
LLT_Inc_IHD_Grouped <- Insert_total_of_n(LLT_Inc_IHD_Grouped,5)

LLT_Inc_IHD_Grouped_pct <- LLT_2010_2021_IHD_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_IHD_Grouped_pct)[1] <- 'Name'

LLT_Inc_IHD_Grouped$'2022' <- 'N/A'
LLT_Inc_IHD_Grouped_pct$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LLT_Inc_IHD_Grouped)
Base_df <- rbind(Base_df, LLT_Inc_IHD_Grouped_pct)


# ST
LLT_2010_2022_PREV_ALL_ST <- subset(LLT_2010_2022_PREV_ALL, LLT_2010_2022_PREV_ALL$type == 'Stroke')

#Denominator
LLT_2010_2022_PREV_ALL_Denom_ST <- LLT_2010_2022_PREV_ALL_ST %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_Inc_Grouped_Prev_Long_ST <- LLT_2010_2022_PREV_ALL_ST %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year,LLT) %>% summarise(Treated = sum(Treated))

LLT_2010_2022_PREV_ALL_ST_Calc <- LLT_Inc_Grouped_Prev_Long_ST %>% inner_join(LLT_2010_2022_PREV_ALL_Denom_ST, by = c('Year' = 'Year'))
LLT_2010_2022_PREV_ALL_ST_Calc$pct_treated <- round((LLT_2010_2022_PREV_ALL_ST_Calc$Treated/LLT_2010_2022_PREV_ALL_ST_Calc$Total)*100,2)

LLT_Inc_ST_Grouped_Prev <- LLT_2010_2022_PREV_ALL_ST_Calc %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_ST_Grouped_Prev)[1] <- 'Name'
LLT_Inc_ST_Grouped_Prev <- Insert_total_of_n(LLT_Inc_ST_Grouped_Prev,5)

LLT_Inc_ST_Grouped_pct_Prev <- LLT_2010_2022_PREV_ALL_ST_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_ST_Grouped_pct_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_Inc_ST_Grouped_Prev)
Base_df <- rbind(Base_df, LLT_Inc_ST_Grouped_pct_Prev)

# ST
LLT_2010_2021_ST <- subset(LLT_2010_2021, LLT_2010_2021$type == 'Stroke')

#Denominator
LLT_2010_2022_Denom_ST <- LLT_2010_2021_ST %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_Inc_Grouped_Long_ST <- LLT_2010_2021_ST %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year,LLT) %>% summarise(Treated = sum(Treated))

LLT_2010_2021_ST_Calc <- LLT_Inc_Grouped_Long_ST %>% inner_join(LLT_2010_2022_Denom_ST, by = c('Year' = 'Year'))
LLT_2010_2021_ST_Calc$pct_treated <- round((LLT_2010_2021_ST_Calc$Treated/LLT_2010_2021_ST_Calc$Total)*100,2)

LLT_Inc_ST_Grouped <- LLT_2010_2021_ST_Calc %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_ST_Grouped)[1] <- 'Name'
LLT_Inc_ST_Grouped <- Insert_total_of_n(LLT_Inc_ST_Grouped,5)

LLT_Inc_ST_Grouped_pct <- LLT_2010_2021_ST_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_ST_Grouped_pct)[1] <- 'Name'

LLT_Inc_ST_Grouped$'2022' <- 'N/A'
LLT_Inc_ST_Grouped_pct$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LLT_Inc_ST_Grouped)
Base_df <- rbind(Base_df, LLT_Inc_ST_Grouped_pct)


# PAD
LLT_2010_2022_PREV_ALL_PAD <- subset(LLT_2010_2022_PREV_ALL, LLT_2010_2022_PREV_ALL$type == 'PAD')

#Denominator
LLT_2010_2022_PREV_ALL_Denom_PAD <- LLT_2010_2022_PREV_ALL_PAD %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_Inc_Grouped_Prev_Long_PAD <- LLT_2010_2022_PREV_ALL_PAD %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year,LLT) %>% summarise(Treated = sum(Treated))

LLT_2010_2022_PREV_ALL_PAD_Calc <- LLT_Inc_Grouped_Prev_Long_PAD %>% inner_join(LLT_2010_2022_PREV_ALL_Denom_PAD, by = c('Year' = 'Year'))
LLT_2010_2022_PREV_ALL_PAD_Calc$pct_treated <- round((LLT_2010_2022_PREV_ALL_PAD_Calc$Treated/LLT_2010_2022_PREV_ALL_PAD_Calc$Total)*100,2)

LLT_Inc_PAD_Grouped_Prev <- LLT_2010_2022_PREV_ALL_PAD_Calc %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_PAD_Grouped_Prev)[1] <- 'Name'
LLT_Inc_PAD_Grouped_Prev <- Insert_total_of_n(LLT_Inc_PAD_Grouped_Prev,5)

LLT_Inc_PAD_Grouped_pct_Prev <- LLT_2010_2022_PREV_ALL_PAD_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_PAD_Grouped_pct_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_Inc_PAD_Grouped_Prev)
Base_df <- rbind(Base_df, LLT_Inc_PAD_Grouped_pct_Prev)

# PAD
LLT_2010_2021_PAD <- subset(LLT_2010_2021, LLT_2010_2021$type == 'PAD')

#Denominator
LLT_2010_2022_Denom_PAD <- LLT_2010_2021_PAD %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_Inc_Grouped_Long_PAD <- LLT_2010_2021_PAD %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year,LLT) %>% summarise(Treated = sum(Treated))

LLT_2010_2021_PAD_Calc <- LLT_Inc_Grouped_Long_PAD %>% inner_join(LLT_2010_2022_Denom_PAD, by = c('Year' = 'Year'))
LLT_2010_2021_PAD_Calc$pct_treated <- round((LLT_2010_2021_PAD_Calc$Treated/LLT_2010_2021_PAD_Calc$Total)*100,2)

LLT_Inc_PAD_Grouped <- LLT_2010_2021_PAD_Calc %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_PAD_Grouped)[1] <- 'Name'
LLT_Inc_PAD_Grouped <- Insert_total_of_n(LLT_Inc_PAD_Grouped,5)

LLT_Inc_PAD_Grouped_pct <- LLT_2010_2021_PAD_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_PAD_Grouped_pct)[1] <- 'Name'

LLT_Inc_PAD_Grouped$'2022' <- 'N/A'
LLT_Inc_PAD_Grouped_pct$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LLT_Inc_PAD_Grouped)
Base_df <- rbind(Base_df, LLT_Inc_PAD_Grouped_pct)


# POLY
LLT_2010_2022_PREV_ALL_POLY <- subset(LLT_2010_2022_PREV_ALL, LLT_2010_2022_PREV_ALL$type == 'Poly-vascular')

#Denominator
LLT_2010_2022_PREV_ALL_Denom_POLY <- LLT_2010_2022_PREV_ALL_POLY %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_Inc_Grouped_Prev_Long_POLY <- LLT_2010_2022_PREV_ALL_POLY %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year,LLT) %>% summarise(Treated = sum(Treated))

LLT_2010_2022_PREV_ALL_POLY_Calc <- LLT_Inc_Grouped_Prev_Long_POLY %>% inner_join(LLT_2010_2022_PREV_ALL_Denom_POLY, by = c('Year' = 'Year'))
LLT_2010_2022_PREV_ALL_POLY_Calc$pct_treated <- round((LLT_2010_2022_PREV_ALL_POLY_Calc$Treated/LLT_2010_2022_PREV_ALL_POLY_Calc$Total)*100,2)

LLT_Inc_POLY_Grouped_Prev <- LLT_2010_2022_PREV_ALL_POLY_Calc %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_POLY_Grouped_Prev)[1] <- 'Name'
LLT_Inc_POLY_Grouped_Prev <- Insert_total_of_n(LLT_Inc_POLY_Grouped_Prev,5)

LLT_Inc_POLY_Grouped_pct_Prev <- LLT_2010_2022_PREV_ALL_POLY_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_POLY_Grouped_pct_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_Inc_POLY_Grouped_Prev)
Base_df <- rbind(Base_df, LLT_Inc_POLY_Grouped_pct_Prev)

# POLY
LLT_2010_2021_POLY <- subset(LLT_2010_2021, LLT_2010_2021$type == 'Poly-vascular')

#Denominator
LLT_2010_2022_Denom_POLY <- LLT_2010_2021_POLY %>% dplyr::select(Year, Treated) %>% group_by(Year) %>% summarise(Total = sum(Treated))
LLT_Inc_Grouped_Long_POLY <- LLT_2010_2021_POLY %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year,LLT) %>% summarise(Treated = sum(Treated))

LLT_2010_2021_POLY_Calc <- LLT_Inc_Grouped_Long_POLY %>% inner_join(LLT_2010_2022_Denom_POLY, by = c('Year' = 'Year'))
LLT_2010_2021_POLY_Calc$pct_treated <- round((LLT_2010_2021_POLY_Calc$Treated/LLT_2010_2021_POLY_Calc$Total)*100,2)

LLT_Inc_POLY_Grouped <- LLT_2010_2021_POLY_Calc %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_POLY_Grouped)[1] <- 'Name'
LLT_Inc_POLY_Grouped <- Insert_total_of_n(LLT_Inc_POLY_Grouped,5)

LLT_Inc_POLY_Grouped_pct <- LLT_2010_2021_POLY_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_Inc_POLY_Grouped_pct)[1] <- 'Name'

LLT_Inc_POLY_Grouped$'2022' <- 'N/A'
LLT_Inc_POLY_Grouped_pct$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LLT_Inc_POLY_Grouped)
Base_df <- rbind(Base_df, LLT_Inc_POLY_Grouped_pct)

```

```{r, include=FALSE}

#Replace nulls
Base_df[is.na(Base_df)] <- 0

Base_df_char <- Base_df %>% mutate(across(where(is.numeric), as.character))

Base_df_char <- check_decimal(Base_df_char)
Base_df_char$pct <- as.character(Base_df_char$pct)

Base_df_char <- sqldf("SELECT Name,
                      CASE WHEN pct = 1 THEN ROUND([2010],1) ELSE [2010] END AS [2010],
                      CASE WHEN pct = 1 THEN ROUND([2011],1) ELSE [2011] END AS [2011],
                      CASE WHEN pct = 1 THEN ROUND([2012],1) ELSE [2012] END AS [2012],
                      CASE WHEN pct = 1 THEN ROUND([2013],1) ELSE [2013] END AS [2013],
                      CASE WHEN pct = 1 THEN ROUND([2014],1) ELSE [2014] END AS [2014],
                      CASE WHEN pct = 1 THEN ROUND([2015],1) ELSE [2015] END AS [2015],
                      CASE WHEN pct = 1 THEN ROUND([2016],1) ELSE [2016] END AS [2016],
                      CASE WHEN pct = 1 THEN ROUND([2017],1) ELSE [2017] END AS [2017],
                      CASE WHEN pct = 1 THEN ROUND([2018],1) ELSE [2018] END AS [2018],
                      CASE WHEN pct = 1 THEN ROUND([2019],1) ELSE [2019] END AS [2019],
                      CASE WHEN pct = 1 THEN ROUND([2020],1) ELSE [2020] END AS [2020],
                      CASE WHEN pct = 1 THEN ROUND([2021],1) ELSE [2021] END AS [2021],
                      CASE WHEN pct = 1 THEN ROUND([2022],1) ELSE [2022] END AS [2022],
                      [pct]
                      FROM Base_df_char")

Base_df_char[Base_df_char == '0.0'] <- 'N/A'

Base_df_char$pct<- NULL

colnames(Base_df_char) <- colnames(Base_df)
colnames(Base_df_char)[1] <- ' '

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

Base_df_char %>%
  kbl(caption = 'Suppl Table X. Prescribed LLT.') %>%
  pack_rows(index = c('Prevalent cases treated (each year) - Overall'=6,
                      'Prevalent cases % treated (each year) - Overall'=5,
                      'Incident cases treated (first year) - Overall'=6,
                      'Incident cases % treated (first year) - Overall'=5,
                      'Prevalent cases treated (each year) - IHD'=6,
                      'Prevalent cases % treated (each year) - IHD'=5,                      
                      'Incident cases treated (first year) - IHD'=6,
                      'Incident cases % treated (first year) - IHD'=5,
                      'Prevalent cases treated (each year) - Stroke'=6,
                      'Prevalent cases % treated (each year) - Stroke'=5,                      
                      'Incident cases treated (first year) - Stroke'=6,
                      'Incident cases % treated (first year) - Stroke'=5,
                      'Prevalent cases treated (each year) - PAD'=6,
                      'Prevalent cases % treated (each year) - PAD'=5,                      
                      'Incident cases treated (first year) - PAD'=6,
                      'Incident cases % treated (first year) - PAD'=5,
                      'Prevalent cases treated (each year) - Poly-vascular'=6,
                      'Prevalent cases % treated (each year) - Poly-vascular'=5,                      
                      'Incident cases treated (first year) - Poly-vascular'=6,
                      'Incident cases % treated (first year) - Poly-vascular'=5),
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()
```

<br>
<br>


### LLT by age

```{r, include=FALSE}

Base_df <- denominator_yr %>% dplyr::select(Year, Name, Denom) %>% pivot_wider(names_from = Year, values_from = Denom)

Base_df[1,1] <- ' '

```

```{r, include=FALSE}


#Adding prevalent treated per year, by treatment, first raw then % treated

names(LLT_AGES_PREV)[names(LLT_AGES_PREV)=='year'] <- 'Year'

LLT_AGES_PREV_U60 <- subset(LLT_AGES_PREV, LLT_AGES_PREV$Age == '< 60')

#Denominator
LLT_AGES_PREV_Denom_U60 <- LLT_AGES_PREV_U60 %>% dplyr::select(Year, Count) %>% group_by(Year) %>% summarise(Total = sum(Count))
LLT_Inc_Grouped_Prev_Long_U60 <- LLT_AGES_PREV_U60 %>% dplyr::select(Year, LLT, Count) %>% group_by(Year,LLT) %>% summarise(Count = sum(Count))

LLT_AGES_PREV_U60_Calc <- LLT_Inc_Grouped_Prev_Long_U60 %>% inner_join(LLT_AGES_PREV_Denom_U60, by = c('Year' = 'Year'))
LLT_AGES_PREV_U60_Calc$pct_treated <- round((LLT_AGES_PREV_U60_Calc$Count/LLT_AGES_PREV_U60_Calc$Total)*100,2)

#U60
LLT_Inc_U60_Grouped_Prev <- LLT_AGES_PREV_U60_Calc %>% dplyr::select(Year, LLT, Count) %>% group_by(Year, LLT) %>% summarise(Count = sum(Count)) %>% pivot_wider(names_from = Year, values_from = Count) %>% arrange(LLT)
colnames(LLT_Inc_U60_Grouped_Prev)[1] <- 'Name'
LLT_Inc_U60_Grouped_Prev <- Insert_total_of_n(LLT_Inc_U60_Grouped_Prev,5)

LLT_Inc_U60_Grouped_pct_Prev <- LLT_AGES_PREV_U60_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Count = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Count) %>% arrange(LLT)
colnames(LLT_Inc_U60_Grouped_pct_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_Inc_U60_Grouped_Prev)
Base_df <- rbind(Base_df, LLT_Inc_U60_Grouped_pct_Prev)

#Remove denominator row
Base_df <- Base_df[2:12,]



names(LLT_AGES)[names(LLT_AGES)=='year'] <- 'Year'

LLT_AGES_U60 <- subset(LLT_AGES, LLT_AGES$Age == '< 60')

#Denominator
LLT_AGES_Denom_U60 <- LLT_AGES_U60 %>% dplyr::select(Year, Count) %>% group_by(Year) %>% summarise(Total = sum(Count))
LLT_Inc_Grouped_Long_U60 <- LLT_AGES_U60 %>% dplyr::select(Year, LLT, Count) %>% group_by(Year,LLT) %>% summarise(Count = sum(Count))

LLT_AGES_U60_Calc <- LLT_Inc_Grouped_Long_U60 %>% inner_join(LLT_AGES_Denom_U60, by = c('Year' = 'Year'))
LLT_AGES_U60_Calc$pct_treated <- round((LLT_AGES_U60_Calc$Count/LLT_AGES_U60_Calc$Total)*100,2)


#U60
LLT_Inc_U60_Grouped <- LLT_AGES_U60_Calc %>% dplyr::select(Year, LLT, Count) %>% group_by(Year, LLT) %>% summarise(Count = sum(Count)) %>% pivot_wider(names_from = Year, values_from = Count) %>% arrange(LLT)
colnames(LLT_Inc_U60_Grouped)[1] <- 'Name'
LLT_Inc_U60_Grouped <- Insert_total_of_n(LLT_Inc_U60_Grouped,5)

LLT_Inc_U60_Grouped_pct <- LLT_AGES_U60_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Count = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Count) %>% arrange(LLT)
colnames(LLT_Inc_U60_Grouped_pct)[1] <- 'Name'

LLT_Inc_U60_Grouped$'2022' <- 'N/A'
LLT_Inc_U60_Grouped_pct$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LLT_Inc_U60_Grouped)
Base_df <- rbind(Base_df, LLT_Inc_U60_Grouped_pct)



LLT_AGES_PREV_60_85 <- subset(LLT_AGES_PREV, LLT_AGES_PREV$Age == '60 - 85')

#Denominator
LLT_AGES_PREV_Denom_60_85 <- LLT_AGES_PREV_60_85 %>% dplyr::select(Year, Count) %>% group_by(Year) %>% summarise(Total = sum(Count))
LLT_Inc_Grouped_Prev_Long_60_85 <- LLT_AGES_PREV_60_85 %>% dplyr::select(Year, LLT, Count) %>% group_by(Year,LLT) %>% summarise(Count = sum(Count))

LLT_AGES_PREV_60_85_Calc <- LLT_Inc_Grouped_Prev_Long_60_85 %>% inner_join(LLT_AGES_PREV_Denom_60_85, by = c('Year' = 'Year'))
LLT_AGES_PREV_60_85_Calc$pct_treated <- round((LLT_AGES_PREV_60_85_Calc$Count/LLT_AGES_PREV_60_85_Calc$Total)*100,2)

#60_85
LLT_Inc_60_85_Grouped_Prev <- LLT_AGES_PREV_60_85_Calc %>% dplyr::select(Year, LLT, Count) %>% group_by(Year, LLT) %>% summarise(Count = sum(Count)) %>% pivot_wider(names_from = Year, values_from = Count) %>% arrange(LLT)
colnames(LLT_Inc_60_85_Grouped_Prev)[1] <- 'Name'
LLT_Inc_60_85_Grouped_Prev <- Insert_total_of_n(LLT_Inc_60_85_Grouped_Prev,5)

LLT_Inc_60_85_Grouped_pct_Prev <- LLT_AGES_PREV_60_85_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Count = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Count) %>% arrange(LLT)
colnames(LLT_Inc_60_85_Grouped_pct_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_Inc_60_85_Grouped_Prev)
Base_df <- rbind(Base_df, LLT_Inc_60_85_Grouped_pct_Prev)



LLT_AGES_60_85 <- subset(LLT_AGES, LLT_AGES$Age == '60 - 85')

#Denominator
LLT_AGES_Denom_60_85 <- LLT_AGES_60_85 %>% dplyr::select(Year, Count) %>% group_by(Year) %>% summarise(Total = sum(Count))
LLT_Inc_Grouped_Long_60_85 <- LLT_AGES_60_85 %>% dplyr::select(Year, LLT, Count) %>% group_by(Year,LLT) %>% summarise(Count = sum(Count))

LLT_AGES_60_85_Calc <- LLT_Inc_Grouped_Long_60_85 %>% inner_join(LLT_AGES_Denom_60_85, by = c('Year' = 'Year'))
LLT_AGES_60_85_Calc$pct_treated <- round((LLT_AGES_60_85_Calc$Count/LLT_AGES_60_85_Calc$Total)*100,2)


#60_85
LLT_Inc_60_85_Grouped <- LLT_AGES_60_85_Calc %>% dplyr::select(Year, LLT, Count) %>% group_by(Year, LLT) %>% summarise(Count = sum(Count)) %>% pivot_wider(names_from = Year, values_from = Count) %>% arrange(LLT)
colnames(LLT_Inc_60_85_Grouped)[1] <- 'Name'
LLT_Inc_60_85_Grouped <- Insert_total_of_n(LLT_Inc_60_85_Grouped,5)

LLT_Inc_60_85_Grouped_pct <- LLT_AGES_60_85_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Count = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Count) %>% arrange(LLT)
colnames(LLT_Inc_60_85_Grouped_pct)[1] <- 'Name'

LLT_Inc_60_85_Grouped$'2022' <- 'N/A'
LLT_Inc_60_85_Grouped_pct$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LLT_Inc_60_85_Grouped)
Base_df <- rbind(Base_df, LLT_Inc_60_85_Grouped_pct)






LLT_AGES_PREV_O85 <- subset(LLT_AGES_PREV, LLT_AGES_PREV$Age == '> 85')

#Denominator
LLT_AGES_PREV_Denom_O85 <- LLT_AGES_PREV_O85 %>% dplyr::select(Year, Count) %>% group_by(Year) %>% summarise(Total = sum(Count))
LLT_Inc_Grouped_Prev_Long_O85 <- LLT_AGES_PREV_O85 %>% dplyr::select(Year, LLT, Count) %>% group_by(Year,LLT) %>% summarise(Count = sum(Count))

LLT_AGES_PREV_O85_Calc <- LLT_Inc_Grouped_Prev_Long_O85 %>% inner_join(LLT_AGES_PREV_Denom_O85, by = c('Year' = 'Year'))
LLT_AGES_PREV_O85_Calc$pct_treated <- round((LLT_AGES_PREV_O85_Calc$Count/LLT_AGES_PREV_O85_Calc$Total)*100,2)

#O85
LLT_Inc_O85_Grouped_Prev <- LLT_AGES_PREV_O85_Calc %>% dplyr::select(Year, LLT, Count) %>% group_by(Year, LLT) %>% summarise(Count = sum(Count)) %>% pivot_wider(names_from = Year, values_from = Count) %>% arrange(LLT)
colnames(LLT_Inc_O85_Grouped_Prev)[1] <- 'Name'
LLT_Inc_O85_Grouped_Prev <- Insert_total_of_n(LLT_Inc_O85_Grouped_Prev,5)

LLT_Inc_O85_Grouped_pct_Prev <- LLT_AGES_PREV_O85_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Count = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Count) %>% arrange(LLT)
colnames(LLT_Inc_O85_Grouped_pct_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_Inc_O85_Grouped_Prev)
Base_df <- rbind(Base_df, LLT_Inc_O85_Grouped_pct_Prev)



LLT_AGES_O85 <- subset(LLT_AGES, LLT_AGES$Age == '> 85')

#Denominator
LLT_AGES_Denom_O85 <- LLT_AGES_O85 %>% dplyr::select(Year, Count) %>% group_by(Year) %>% summarise(Total = sum(Count))
LLT_Inc_Grouped_Long_O85 <- LLT_AGES_O85 %>% dplyr::select(Year, LLT, Count) %>% group_by(Year,LLT) %>% summarise(Count = sum(Count))

LLT_AGES_O85_Calc <- LLT_Inc_Grouped_Long_O85 %>% inner_join(LLT_AGES_Denom_O85, by = c('Year' = 'Year'))
LLT_AGES_O85_Calc$pct_treated <- round((LLT_AGES_O85_Calc$Count/LLT_AGES_O85_Calc$Total)*100,2)


#O85
LLT_Inc_O85_Grouped <- LLT_AGES_O85_Calc %>% dplyr::select(Year, LLT, Count) %>% group_by(Year, LLT) %>% summarise(Count = sum(Count)) %>% pivot_wider(names_from = Year, values_from = Count) %>% arrange(LLT)
colnames(LLT_Inc_O85_Grouped)[1] <- 'Name'
LLT_Inc_O85_Grouped <- Insert_total_of_n(LLT_Inc_O85_Grouped,5)

LLT_Inc_O85_Grouped_pct <- LLT_AGES_O85_Calc %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Count = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Count) %>% arrange(LLT)
colnames(LLT_Inc_O85_Grouped_pct)[1] <- 'Name'

LLT_Inc_O85_Grouped$'2022' <- 'N/A'
LLT_Inc_O85_Grouped_pct$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LLT_Inc_O85_Grouped)
Base_df <- rbind(Base_df, LLT_Inc_O85_Grouped_pct)


```

```{r, include=FALSE}

#Replace nulls
Base_df[is.na(Base_df)] <- 0

Base_df_char <- Base_df %>% mutate(across(where(is.numeric), as.character))

Base_df_char <- check_decimal(Base_df_char)
Base_df_char$pct <- as.character(Base_df_char$pct)


Base_df_char <- sqldf("SELECT Name,
                      CASE WHEN pct = 1 THEN ROUND([2010],1) ELSE [2010] END AS [2010],
                      CASE WHEN pct = 1 THEN ROUND([2011],1) ELSE [2011] END AS [2011],
                      CASE WHEN pct = 1 THEN ROUND([2012],1) ELSE [2012] END AS [2012],
                      CASE WHEN pct = 1 THEN ROUND([2013],1) ELSE [2013] END AS [2013],
                      CASE WHEN pct = 1 THEN ROUND([2014],1) ELSE [2014] END AS [2014],
                      CASE WHEN pct = 1 THEN ROUND([2015],1) ELSE [2015] END AS [2015],
                      CASE WHEN pct = 1 THEN ROUND([2016],1) ELSE [2016] END AS [2016],
                      CASE WHEN pct = 1 THEN ROUND([2017],1) ELSE [2017] END AS [2017],
                      CASE WHEN pct = 1 THEN ROUND([2018],1) ELSE [2018] END AS [2018],
                      CASE WHEN pct = 1 THEN ROUND([2019],1) ELSE [2019] END AS [2019],
                      CASE WHEN pct = 1 THEN ROUND([2020],1) ELSE [2020] END AS [2020],
                      CASE WHEN pct = 1 THEN ROUND([2021],1) ELSE [2021] END AS [2021],
                      CASE WHEN pct = 1 THEN ROUND([2022],1) ELSE [2022] END AS [2022],
                      [pct]
                      FROM Base_df_char")

Base_df_char[Base_df_char == '0.0'] <- 'N/A'


Base_df_char$pct<- NULL

colnames(Base_df_char) <- colnames(Base_df)
colnames(Base_df_char)[1] <- ' '

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

Base_df_char %>%
  kbl(caption = 'Suppl Table X. Prescribed LLT.') %>%
  pack_rows(index = c('Prevalent cases treated (each year) - Aged < 60'=6,
                      'Prevalent cases % treated (each year) - Aged < 60'=5,                      
                      'Incident cases treated (first year) - Aged < 60'=6,
                      'Incident cases % treated (first year) - Aged < 60'=5,
                      'Prevalent cases treated (each year) - Aged 60 - 85'=6,
                      'Prevalent cases % treated (each year) - Aged 60 - 85'=5,                      
                      'Incident cases treated (first year) - Aged 60 - 85'=6,
                      'Incident cases % treated (first year) - Aged 60 - 85'=5,
                      'Prevalent cases treated (each year) - Aged > 85'=6,
                      'Prevalent cases % treated (each year) - Aged > 85'=5,                      
                      'Incident cases treated (first year) - Aged > 85'=6,
                      'Incident cases % treated (first year) - Aged > 85'=5),
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()
```

<br>
<br>


### Follow-up Inc Prev

```{r, include=FALSE}

Base_df <- denominator_yr %>% dplyr::select(Year, Name, Denom) %>% pivot_wider(names_from = Year, values_from = Denom)

Base_df[1,1] <- ' '

```

```{r, include=FALSE}

Base_df <- rbind(Base_df, LLT_Inc_Grouped_Prev[1,])

LLT_Inc_IHD_Grouped_Prev[1,1] <- 'IHD'
Base_df <- rbind(Base_df, LLT_Inc_IHD_Grouped_Prev[1,])

#Remove denominator row
Base_df <- Base_df[2:3,]

LLT_Inc_ST_Grouped_Prev[1,1] <- 'Stroke'
Base_df <- rbind(Base_df, LLT_Inc_ST_Grouped_Prev[1,])

LLT_Inc_PAD_Grouped_Prev[1,1] <- 'PAD'
Base_df <- rbind(Base_df, LLT_Inc_PAD_Grouped_Prev[1,])

LLT_Inc_POLY_Grouped_Prev[1,1] <- 'Poly-vascular'
Base_df <- rbind(Base_df, LLT_Inc_POLY_Grouped_Prev[1,])

```

```{r, include=FALSE}

Base_df <- rbind(Base_df, LLT_Inc_Grouped[1,])

LLT_Inc_IHD_Grouped[1,1] <- 'IHD'
Base_df <- rbind(Base_df, LLT_Inc_IHD_Grouped[1,])

LLT_Inc_ST_Grouped[1,1] <- 'Stroke'
Base_df <- rbind(Base_df, LLT_Inc_ST_Grouped[1,])

LLT_Inc_PAD_Grouped[1,1] <- 'PAD'
Base_df <- rbind(Base_df, LLT_Inc_PAD_Grouped[1,])

LLT_Inc_POLY_Grouped[1,1] <- 'Poly-vascular'
Base_df <- rbind(Base_df, LLT_Inc_POLY_Grouped[1,])

```

```{r, include=FALSE}

#Replace nulls
Base_df[is.na(Base_df)] <- 0

Base_df_char <- Base_df %>% mutate(across(where(is.numeric), as.character))

colnames(Base_df_char) <- colnames(Base_df)
colnames(Base_df_char)[1] <- ' '

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

Base_df_char %>%
  kbl(caption = 'Suppl Table X. Patients eligible for lipid analysis.') %>%
  pack_rows(index = c('Prevalent cases treated (each year)'=5,
                      'Incident cases treated (first year)'=5),
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()
```


<br>
<br>


### LDL test

```{r, include=FALSE}

Base_df <- denominator_yr %>% dplyr::select(Year, Name, Denom) %>% pivot_wider(names_from = Year, values_from = Denom)

Base_df[1,1] <- ' '

```

```{r, include=FALSE}

#Adding prevalent tested (LDL) per year, first raw then % tested
Test_Prev_base_raw_LDL <- Lipid_Test_Per_Year_Prev_LDL_GP %>% dplyr::select(Year, Territory, Tested) %>% pivot_wider(names_from = Year, values_from = Tested) %>% arrange(Territory)
colnames(Test_Prev_base_raw_LDL)[1] <- 'Name'
Test_Prev_base_raw_LDL <- Insert_total_of_n(Test_Prev_base_raw_LDL,4)

Test_Prev_base_pct_LDL <- Lipid_Test_Per_Year_Prev_LDL_GP %>% dplyr::select(Year, Territory, pct_tested) %>% pivot_wider(names_from = Year, values_from = pct_tested) %>% arrange(Territory)
colnames(Test_Prev_base_pct_LDL)[1] <- 'Name'
Test_Prev_base_pct_LDL <- Insert_total_of_n(Test_Prev_base_pct_LDL,4)
Test_Prev_base_pct_LDL <- Pct_denominator_prev(Lipid_Test_Per_Year_Prev_LDL_GP, Test_Prev_base_raw_LDL, Test_Prev_base_pct_LDL)

Base_df <- rbind(Base_df, Test_Prev_base_raw_LDL)
Base_df <- rbind(Base_df, Test_Prev_base_pct_LDL)

#Remove denominator row
Base_df <- Base_df[2:11,]


#Adding incident tested (LDL) per year, first raw then % tested
Test_Inc_base_raw_LDL <- Lipid_Test_Per_Year_Inc_LDL_GP %>% dplyr::select(Year, Territory, Tested) %>% pivot_wider(names_from = Year, values_from = Tested) %>% arrange(Territory)
colnames(Test_Inc_base_raw_LDL)[1] <- 'Name'
Test_Inc_base_raw_LDL <- Insert_total_of_n(Test_Inc_base_raw_LDL,4)


Test_Inc_base_pct_LDL <- Lipid_Test_Per_Year_Inc_LDL_GP %>% dplyr::select(Year, Territory, pct_tested) %>% pivot_wider(names_from = Year, values_from = pct_tested) %>% arrange(Territory)
colnames(Test_Inc_base_pct_LDL)[1] <- 'Name'
Test_Inc_base_pct_LDL <- Insert_total_of_n(Test_Inc_base_pct_LDL,4)
Test_Inc_base_pct_LDL <- Pct_denominator_inc(Lipid_Test_Per_Year_Inc_LDL_GP, Test_Inc_base_raw_LDL, Test_Inc_base_pct_LDL)

Test_Inc_base_raw_LDL$'2022' <- 'N/A'
Test_Inc_base_pct_LDL$'2022' <- 'N/A'

Base_df <- rbind(Base_df, Test_Inc_base_raw_LDL)
Base_df <- rbind(Base_df, Test_Inc_base_pct_LDL)

```

```{r, include=FALSE}

#Replace nulls
Base_df[is.na(Base_df)] <- 0

Base_df_char <- Base_df %>% mutate(across(where(is.numeric), as.character))

Base_df_char <- check_decimal(Base_df_char)
Base_df_char$pct <- as.character(Base_df_char$pct)


Base_df_char <- sqldf("SELECT Name,
                      CASE WHEN pct = 1 THEN ROUND([2010],1) ELSE [2010] END AS [2010],
                      CASE WHEN pct = 1 THEN ROUND([2011],1) ELSE [2011] END AS [2011],
                      CASE WHEN pct = 1 THEN ROUND([2012],1) ELSE [2012] END AS [2012],
                      CASE WHEN pct = 1 THEN ROUND([2013],1) ELSE [2013] END AS [2013],
                      CASE WHEN pct = 1 THEN ROUND([2014],1) ELSE [2014] END AS [2014],
                      CASE WHEN pct = 1 THEN ROUND([2015],1) ELSE [2015] END AS [2015],
                      CASE WHEN pct = 1 THEN ROUND([2016],1) ELSE [2016] END AS [2016],
                      CASE WHEN pct = 1 THEN ROUND([2017],1) ELSE [2017] END AS [2017],
                      CASE WHEN pct = 1 THEN ROUND([2018],1) ELSE [2018] END AS [2018],
                      CASE WHEN pct = 1 THEN ROUND([2019],1) ELSE [2019] END AS [2019],
                      CASE WHEN pct = 1 THEN ROUND([2020],1) ELSE [2020] END AS [2020],
                      CASE WHEN pct = 1 THEN ROUND([2021],1) ELSE [2021] END AS [2021],
                      CASE WHEN pct = 1 THEN ROUND([2022],1) ELSE [2022] END AS [2022],
                      [pct]
                      FROM Base_df_char")

Base_df_char[Base_df_char == '0.0'] <- 'N/A'


Base_df_char$pct<- NULL

colnames(Base_df_char) <- colnames(Base_df)
colnames(Base_df_char)[1] <- ' '

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

Base_df_char %>%
  kbl(caption = 'Suppl Table X. LDL-C test.') %>%
  pack_rows(index = c('Prevalent cases tested (LDL-C test)'=5,
                      'Prevalent cases % tested (LDL-C test)'=5,
                      'Incident cases tested (LDL-C test)'=5,
                      'Incident cases % tested (LDL-C test)'=5),
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()
```

<br>
<br>

### LDL levels

```{r, include=FALSE}

Base_df <- denominator_yr %>% dplyr::select(Year, Name, Denom) %>% pivot_wider(names_from = Year, values_from = Denom)

Base_df[1,1] <- ' '

```

```{r, include=FALSE}


#Adding prevalent control of LDL per year

MIN_LDL_Test_2010_2022_PREV[MIN_LDL_Test_2010_2022_PREV == 'ST'] <- 'Stroke'
MIN_LDL_Test_2010_2022_PREV[MIN_LDL_Test_2010_2022_PREV == 'POLY'] <- 'Poly-vascular'

Control_LDL_base_PREV <- MIN_LDL_Test_2010_2022_PREV %>% group_by(event_year, type) %>% summarise(mean = round(mean(min_ldl),1))
Control_LDL_base_PREV$mean <- round(Control_LDL_base_PREV$mean,2)
Control_LDL_base_PREV <- Control_LDL_base_PREV %>% dplyr::select(event_year, type, mean) %>% pivot_wider(names_from = event_year, values_from = mean) %>% arrange(type)
colnames(Control_LDL_base_PREV)[1] <- 'Name'
Control_LDL_base_PREV <- Insert_mean_of_n(Control_LDL_base_PREV,4)

#SD

Control_LDL_base_PREV_SD <- MIN_LDL_Test_2010_2022_PREV %>% group_by(event_year, type) %>% summarise(sd = round(sd(min_ldl),1))
Control_LDL_base_PREV_SD$sd <- round(Control_LDL_base_PREV_SD$sd,2)
Control_LDL_base_PREV_SD <- Control_LDL_base_PREV_SD %>% dplyr::select(event_year, type, sd) %>% pivot_wider(names_from = event_year, values_from = sd) %>% arrange(type)
colnames(Control_LDL_base_PREV_SD)[1] <- 'Name'
Control_LDL_base_PREV_SD <- Insert_mean_of_n(Control_LDL_base_PREV_SD,4)

Control_LDL_base_PREV_SD <- data.frame(lapply(Control_LDL_base_PREV_SD,function(x) paste('(', format(x, nsmall=1), ')')))

Control_LDL_base_PREV_SD$'Name' <- Control_LDL_base_PREV$Name
colnames(Control_LDL_base_PREV_SD) <- colnames(Base_df)

Control_LDL_base_PREV[-1] <- paste0(as.matrix(Control_LDL_base_PREV[-1]), ' ', as.matrix(Control_LDL_base_PREV_SD[-1]))

Base_df <- rbind(Base_df, Control_LDL_base_PREV)

#Remove denominator row
Base_df <- Base_df[2:6,]

```

```{r, include=FALSE}

#Adding incident control of LDL per year

MIN_LDL_Test_2010_2021[MIN_LDL_Test_2010_2021 == 'ST'] <- 'Stroke'
MIN_LDL_Test_2010_2021[MIN_LDL_Test_2010_2021 == 'POLY'] <- 'Poly-vascular'

Control_LDL_base <- MIN_LDL_Test_2010_2021 %>% group_by(event_year, type) %>% summarise(mean = round(mean(min_ldl),1))
Control_LDL_base$mean <- round(Control_LDL_base$mean,2)
Control_LDL_base <- Control_LDL_base %>% dplyr::select(event_year, type, mean) %>% pivot_wider(names_from = event_year, values_from = mean) %>% arrange(type)
colnames(Control_LDL_base)[1] <- 'Name'
Control_LDL_base <- Insert_mean_of_n(Control_LDL_base,4)

Control_LDL_base$'2022' <- 'N/A'

#SD

Control_LDL_base_SD <- MIN_LDL_Test_2010_2021 %>% group_by(event_year, type) %>% summarise(sd = round(sd(min_ldl),1))
Control_LDL_base_SD$sd <- round(Control_LDL_base_SD$sd,2)
Control_LDL_base_SD <- Control_LDL_base_SD %>% dplyr::select(event_year, type, sd) %>% pivot_wider(names_from = event_year, values_from = sd) %>% arrange(type)
colnames(Control_LDL_base_SD)[1] <- 'Name'
Control_LDL_base_SD <- Insert_mean_of_n(Control_LDL_base_SD,4)

Control_LDL_base_SD <- data.frame(lapply(Control_LDL_base_SD,function(x) paste('(', format(x, nsmall=1), ')')))

Control_LDL_base_SD$'X2022' <- ''
Control_LDL_base_SD$'Name' <- Control_LDL_base$Name
colnames(Control_LDL_base_SD) <- colnames(Base_df)


Control_LDL_base[-1] <- paste0(as.matrix(Control_LDL_base[-1]), ' ', as.matrix(Control_LDL_base_SD[-1]))

Base_df <- rbind(Base_df, Control_LDL_base)

```

```{r, include=FALSE}

#Replace nulls
Base_df[is.na(Base_df)] <- 0

Base_df_char <- Base_df %>% mutate(across(where(is.numeric), as.character))

Base_df_char[Base_df_char == '0.0'] <- 'N/A'

Base_df_char$pct<- NULL

colnames(Base_df_char) <- colnames(Base_df)
colnames(Base_df_char)[1] <- ' '

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

Base_df_char %>%
  kbl(caption = 'Suppl Table X. LDL-C levels') %>%
  pack_rows(index = c('Prevalent cases mean (SD) LDL-C level'=5,                    
                      'Incident cases mean (SD) LDL-C level'=5), 
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()
```

<br>
<br>


### Achievement of ESC Target LDL - 1.4

```{r, include=FALSE}

MIN_LDL_Test_2010_2021 <- db2_run(conn = Connection, query = 'SELECT year(DIAG) AS event_year, type, MIN_LDL AS MIN_LDL FROM SAILW1483V.TEMP_LDL_CONTROL WHERE MIN_LDL <= 10')

MIN_LDL_Test_2010_2022_PREV <- db2_run(conn = Connection, query = 'SELECT year(TEST) AS event_year, type, MIN_LDL AS MIN_LDL FROM SAILW1483V.TEMP_LDL_CONTROL_PREV WHERE MIN_LDL <= 10')


MIN_LDL_Test_2010_2021[MIN_LDL_Test_2010_2021== 'ST'] <- 'Stroke'
MIN_LDL_Test_2010_2021[MIN_LDL_Test_2010_2021== 'POLY'] <- 'Poly-vascular'
MIN_LDL_Test_2010_2021$type <- factor(MIN_LDL_Test_2010_2021$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

MIN_LDL_Test_2010_2022_PREV[MIN_LDL_Test_2010_2022_PREV== 'ST'] <- 'Stroke'
MIN_LDL_Test_2010_2022_PREV[MIN_LDL_Test_2010_2022_PREV== 'POLY'] <- 'Poly-vascular'
MIN_LDL_Test_2010_2022_PREV$type <- factor(MIN_LDL_Test_2010_2022_PREV$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))


MIN_LDL_Test_IHD <- subset(MIN_LDL_Test_2010_2021, type == 'IHD')
MIN_LDL_Test_ST <-  subset(MIN_LDL_Test_2010_2021, type == 'Stroke')
MIN_LDL_Test_PAD <- subset(MIN_LDL_Test_2010_2021, type == 'PAD')
MIN_LDL_Test_Poly <- subset(MIN_LDL_Test_2010_2021, type == 'Poly-vascular')

MIN_LDL_Test_IHD_PREV <- subset(MIN_LDL_Test_2010_2022_PREV, type == 'IHD')
MIN_LDL_Test_ST_PREV <-  subset(MIN_LDL_Test_2010_2022_PREV, type == 'Stroke')
MIN_LDL_Test_PAD_PREV <- subset(MIN_LDL_Test_2010_2022_PREV, type == 'PAD')
MIN_LDL_Test_Poly_PREV <- subset(MIN_LDL_Test_2010_2022_PREV, type == 'Poly-vascular')

```

```{r, include=FALSE}

#Overall
LDL_below_target <- MIN_LDL_Test_2010_2021 %>% filter(min_ldl <= 1.4)
Year_counts <- MIN_LDL_Test_2010_2021 %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target <- LDL_below_target %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#IHD
LDL_below_target_IHD <- MIN_LDL_Test_IHD %>% filter(min_ldl <= 1.4)
Year_counts_IHD <- MIN_LDL_Test_IHD %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_IHD <- LDL_below_target_IHD %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_IHD, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#ST
LDL_below_target_ST <- MIN_LDL_Test_ST %>% filter(min_ldl <= 1.4)
Year_counts_ST <- MIN_LDL_Test_ST %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_ST <- LDL_below_target_ST %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_ST, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#PAD
LDL_below_target_PAD <- MIN_LDL_Test_PAD %>% filter(min_ldl <= 1.4)
Year_counts_PAD <- MIN_LDL_Test_PAD %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_PAD <- LDL_below_target_PAD %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_PAD, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#POLY
LDL_below_target_POLY <- MIN_LDL_Test_Poly %>% filter(min_ldl <= 1.4)
Year_counts_POLY <- MIN_LDL_Test_Poly %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_POLY <- LDL_below_target_POLY %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_POLY, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

```

```{r, include=FALSE}

#Overall
LDL_below_target_Prev <- MIN_LDL_Test_2010_2022_PREV %>% filter(min_ldl <= 1.4)
Year_counts_Prev <- MIN_LDL_Test_2010_2022_PREV %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_Prev <- LDL_below_target_Prev %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_Prev, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#IHD
LDL_below_target_IHD_Prev <- MIN_LDL_Test_IHD_PREV %>% filter(min_ldl <= 1.4)
Year_counts_IHD_Prev <- MIN_LDL_Test_IHD_PREV %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_IHD_Prev <- LDL_below_target_IHD_Prev %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_IHD_Prev, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#ST
LDL_below_target_ST_Prev <- MIN_LDL_Test_ST_PREV %>% filter(min_ldl <= 1.4)
Year_counts_ST_Prev <- MIN_LDL_Test_ST_PREV %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_ST_Prev <- LDL_below_target_ST_Prev %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_ST_Prev, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#PAD
LDL_below_target_PAD_Prev <- MIN_LDL_Test_PAD_PREV %>% filter(min_ldl <= 1.4)
Year_counts_PAD_Prev <- MIN_LDL_Test_PAD_PREV %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_PAD_Prev <- LDL_below_target_PAD_Prev %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_PAD_Prev, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#POLY
LDL_below_target_POLY_Prev <- MIN_LDL_Test_Poly_PREV %>% filter(min_ldl <= 1.4)
Year_counts_POLY_Prev <- MIN_LDL_Test_Poly_PREV %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_POLY_Prev <- LDL_below_target_POLY_Prev %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_POLY_Prev, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

```


```{r, include=FALSE}

Base_df <- denominator_yr %>% dplyr::select(Year, Name, Denom) %>% pivot_wider(names_from = Year, values_from = Denom)

Base_df[1,1] <- ' '

Base_df_col_1 <- Base_df$Name

```

```{r, include=FALSE}

#Prevalent
LDL_below_target_wide_Prev <- Pct_below_target_Prev %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_IHD_wide_Prev <- Pct_below_target_IHD_Prev %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_ST_wide_Prev <- Pct_below_target_ST_Prev %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_PAD_wide_Prev <- Pct_below_target_PAD_Prev %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_POLY_wide_Prev <- Pct_below_target_POLY_Prev %>% pivot_wider(names_from = event_year, values_from = pct)


#Overall
LDL_below_target_wide_Prev <- cbind(Base_df_col_1, LDL_below_target_wide_Prev)
colnames(LDL_below_target_wide_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LDL_below_target_wide_Prev)

#Remove denominator row
Base_df <- Base_df[2:2,]

Base_df[1,1] <- 'Overall'

#IHD
LDL_below_target_IHD_wide_Prev <- cbind(Base_df_col_1, LDL_below_target_IHD_wide_Prev)
colnames(LDL_below_target_IHD_wide_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LDL_below_target_IHD_wide_Prev)
Base_df[2,1] <- 'IHD'


#ST
LDL_below_target_ST_wide_Prev <- cbind(Base_df_col_1, LDL_below_target_ST_wide_Prev)
colnames(LDL_below_target_ST_wide_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LDL_below_target_ST_wide_Prev)
Base_df[3,1] <- 'Stroke'


#PAD
LDL_below_target_PAD_wide_Prev <- cbind(Base_df_col_1, LDL_below_target_PAD_wide_Prev)
colnames(LDL_below_target_PAD_wide_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LDL_below_target_PAD_wide_Prev)
Base_df[4,1] <- 'PAD'


#POLY
LDL_below_target_POLY_wide_Prev <- cbind(Base_df_col_1, LDL_below_target_POLY_wide_Prev)
colnames(LDL_below_target_POLY_wide_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LDL_below_target_POLY_wide_Prev)
Base_df[5,1] <- 'Poly-vascular'


```

```{r, include=FALSE}

LDL_below_target_wide <- Pct_below_target %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_IHD_wide <- Pct_below_target_IHD %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_ST_wide <- Pct_below_target_ST %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_PAD_wide <- Pct_below_target_PAD %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_POLY_wide <- Pct_below_target_POLY %>% pivot_wider(names_from = event_year, values_from = pct)


#Overall
LDL_below_target_wide <- cbind(Base_df_col_1, LDL_below_target_wide)
colnames(LDL_below_target_wide)[1] <- 'Name'
LDL_below_target_wide$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LDL_below_target_wide)

Base_df[6,1] <- 'Overall'

#IHD
LDL_below_target_IHD_wide <- cbind(Base_df_col_1, LDL_below_target_IHD_wide)
colnames(LDL_below_target_IHD_wide)[1] <- 'Name'
LDL_below_target_IHD_wide$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LDL_below_target_IHD_wide)
Base_df[7,1] <- 'IHD'


#ST
LDL_below_target_ST_wide <- cbind(Base_df_col_1, LDL_below_target_ST_wide)
colnames(LDL_below_target_ST_wide)[1] <- 'Name'
LDL_below_target_ST_wide$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LDL_below_target_ST_wide)
Base_df[8,1] <- 'Stroke'


#PAD
LDL_below_target_PAD_wide <- cbind(Base_df_col_1, LDL_below_target_PAD_wide)
colnames(LDL_below_target_PAD_wide)[1] <- 'Name'
LDL_below_target_PAD_wide$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LDL_below_target_PAD_wide)
Base_df[9,1] <- 'PAD'


#POLY
LDL_below_target_POLY_wide <- cbind(Base_df_col_1, LDL_below_target_POLY_wide)
colnames(LDL_below_target_POLY_wide)[1] <- 'Name'
LDL_below_target_POLY_wide$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LDL_below_target_POLY_wide)
Base_df[10,1] <- 'Poly-vascular'

colnames(Base_df)[1] <- ' '

```

```{r, include=FALSE}

#Replace nulls
Base_df[is.na(Base_df)] <- 0

Base_df_char <- Base_df %>% mutate(across(where(is.numeric), as.character))

colnames(Base_df_char) <- colnames(Base_df)
colnames(Base_df_char)[1] <- ' '

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

Base_df_char %>%
  kbl(caption = 'Suppl Table X. Achieved ESC target LDL-C level (<= 1.4 mmol/L)') %>%
  pack_rows(index = c('Prevalent cases achieving ESC target LDL-C level (%)'=5,                    
                      'Incident cases achieving ESC target LDL-C level (%)'=5), 
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()
```

<br>
<br>

### Achievement of ESC Target LDL - 1.8

```{r, include=FALSE}

MIN_LDL_Test_2010_2021 <- db2_run(conn = Connection, query = 'SELECT year(DIAG) AS event_year, type, MIN_LDL AS MIN_LDL FROM SAILW1483V.TEMP_LDL_CONTROL WHERE MIN_LDL <= 10')

MIN_LDL_Test_2010_2022_PREV <- db2_run(conn = Connection, query = 'SELECT year(TEST) AS event_year, type, MIN_LDL AS MIN_LDL FROM SAILW1483V.TEMP_LDL_CONTROL_PREV WHERE MIN_LDL <= 10')


MIN_LDL_Test_2010_2021[MIN_LDL_Test_2010_2021== 'ST'] <- 'Stroke'
MIN_LDL_Test_2010_2021[MIN_LDL_Test_2010_2021== 'POLY'] <- 'Poly-vascular'
MIN_LDL_Test_2010_2021$type <- factor(MIN_LDL_Test_2010_2021$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))

MIN_LDL_Test_2010_2022_PREV[MIN_LDL_Test_2010_2022_PREV== 'ST'] <- 'Stroke'
MIN_LDL_Test_2010_2022_PREV[MIN_LDL_Test_2010_2022_PREV== 'POLY'] <- 'Poly-vascular'
MIN_LDL_Test_2010_2022_PREV$type <- factor(MIN_LDL_Test_2010_2022_PREV$type, levels= c('IHD', 'Stroke', 'PAD', 'Poly-vascular'))


MIN_LDL_Test_IHD <- subset(MIN_LDL_Test_2010_2021, type == 'IHD')
MIN_LDL_Test_ST <-  subset(MIN_LDL_Test_2010_2021, type == 'Stroke')
MIN_LDL_Test_PAD <- subset(MIN_LDL_Test_2010_2021, type == 'PAD')
MIN_LDL_Test_Poly <- subset(MIN_LDL_Test_2010_2021, type == 'Poly-vascular')

MIN_LDL_Test_IHD_PREV <- subset(MIN_LDL_Test_2010_2022_PREV, type == 'IHD')
MIN_LDL_Test_ST_PREV <-  subset(MIN_LDL_Test_2010_2022_PREV, type == 'Stroke')
MIN_LDL_Test_PAD_PREV <- subset(MIN_LDL_Test_2010_2022_PREV, type == 'PAD')
MIN_LDL_Test_Poly_PREV <- subset(MIN_LDL_Test_2010_2022_PREV, type == 'Poly-vascular')

```

```{r, include=FALSE}

#Overall
LDL_below_target <- MIN_LDL_Test_2010_2021 %>% filter(min_ldl <= 1.8)
Year_counts <- MIN_LDL_Test_2010_2021 %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target <- LDL_below_target %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#IHD
LDL_below_target_IHD <- MIN_LDL_Test_IHD %>% filter(min_ldl <= 1.8)
Year_counts_IHD <- MIN_LDL_Test_IHD %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_IHD <- LDL_below_target_IHD %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_IHD, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#ST
LDL_below_target_ST <- MIN_LDL_Test_ST %>% filter(min_ldl <= 1.8)
Year_counts_ST <- MIN_LDL_Test_ST %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_ST <- LDL_below_target_ST %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_ST, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#PAD
LDL_below_target_PAD <- MIN_LDL_Test_PAD %>% filter(min_ldl <= 1.8)
Year_counts_PAD <- MIN_LDL_Test_PAD %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_PAD <- LDL_below_target_PAD %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_PAD, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#POLY
LDL_below_target_POLY <- MIN_LDL_Test_Poly %>% filter(min_ldl <= 1.8)
Year_counts_POLY <- MIN_LDL_Test_Poly %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_POLY <- LDL_below_target_POLY %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_POLY, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

```

```{r, include=FALSE}

#Overall
LDL_below_target_Prev <- MIN_LDL_Test_2010_2022_PREV %>% filter(min_ldl <= 1.8)
Year_counts_Prev <- MIN_LDL_Test_2010_2022_PREV %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_Prev <- LDL_below_target_Prev %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_Prev, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#IHD
LDL_below_target_IHD_Prev <- MIN_LDL_Test_IHD_PREV %>% filter(min_ldl <= 1.8)
Year_counts_IHD_Prev <- MIN_LDL_Test_IHD_PREV %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_IHD_Prev <- LDL_below_target_IHD_Prev %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_IHD_Prev, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#ST
LDL_below_target_ST_Prev <- MIN_LDL_Test_ST_PREV %>% filter(min_ldl <= 1.8)
Year_counts_ST_Prev <- MIN_LDL_Test_ST_PREV %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_ST_Prev <- LDL_below_target_ST_Prev %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_ST_Prev, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#PAD
LDL_below_target_PAD_Prev <- MIN_LDL_Test_PAD_PREV %>% filter(min_ldl <= 1.8)
Year_counts_PAD_Prev <- MIN_LDL_Test_PAD_PREV %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_PAD_Prev <- LDL_below_target_PAD_Prev %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_PAD_Prev, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

#POLY
LDL_below_target_POLY_Prev <- MIN_LDL_Test_Poly_PREV %>% filter(min_ldl <= 1.8)
Year_counts_POLY_Prev <- MIN_LDL_Test_Poly_PREV %>% group_by(event_year) %>% summarise(denom = n())
Pct_below_target_POLY_Prev <- LDL_below_target_POLY_Prev %>% group_by(event_year) %>% summarise(achieved = n()) %>% left_join(Year_counts_POLY_Prev, by = 'event_year') %>% mutate(pct = round((achieved / denom) * 100, 1)) %>% dplyr::select(event_year, pct)

```


```{r, include=FALSE}

Base_df <- denominator_yr %>% dplyr::select(Year, Name, Denom) %>% pivot_wider(names_from = Year, values_from = Denom)

Base_df[1,1] <- ' '

Base_df_col_1 <- Base_df$Name

```

```{r, include=FALSE}

#Prevalent
LDL_below_target_wide_Prev <- Pct_below_target_Prev %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_IHD_wide_Prev <- Pct_below_target_IHD_Prev %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_ST_wide_Prev <- Pct_below_target_ST_Prev %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_PAD_wide_Prev <- Pct_below_target_PAD_Prev %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_POLY_wide_Prev <- Pct_below_target_POLY_Prev %>% pivot_wider(names_from = event_year, values_from = pct)


#Overall
LDL_below_target_wide_Prev <- cbind(Base_df_col_1, LDL_below_target_wide_Prev)
colnames(LDL_below_target_wide_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LDL_below_target_wide_Prev)

#Remove denominator row
Base_df <- Base_df[2:2,]

Base_df[1,1] <- 'Overall'

#IHD
LDL_below_target_IHD_wide_Prev <- cbind(Base_df_col_1, LDL_below_target_IHD_wide_Prev)
colnames(LDL_below_target_IHD_wide_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LDL_below_target_IHD_wide_Prev)
Base_df[2,1] <- 'IHD'


#ST
LDL_below_target_ST_wide_Prev <- cbind(Base_df_col_1, LDL_below_target_ST_wide_Prev)
colnames(LDL_below_target_ST_wide_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LDL_below_target_ST_wide_Prev)
Base_df[3,1] <- 'Stroke'


#PAD
LDL_below_target_PAD_wide_Prev <- cbind(Base_df_col_1, LDL_below_target_PAD_wide_Prev)
colnames(LDL_below_target_PAD_wide_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LDL_below_target_PAD_wide_Prev)
Base_df[4,1] <- 'PAD'


#POLY
LDL_below_target_POLY_wide_Prev <- cbind(Base_df_col_1, LDL_below_target_POLY_wide_Prev)
colnames(LDL_below_target_POLY_wide_Prev)[1] <- 'Name'

Base_df <- rbind(Base_df, LDL_below_target_POLY_wide_Prev)
Base_df[5,1] <- 'Poly-vascular'


```

```{r, include=FALSE}

LDL_below_target_wide <- Pct_below_target %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_IHD_wide <- Pct_below_target_IHD %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_ST_wide <- Pct_below_target_ST %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_PAD_wide <- Pct_below_target_PAD %>% pivot_wider(names_from = event_year, values_from = pct) 
LDL_below_target_POLY_wide <- Pct_below_target_POLY %>% pivot_wider(names_from = event_year, values_from = pct)


#Overall
LDL_below_target_wide <- cbind(Base_df_col_1, LDL_below_target_wide)
colnames(LDL_below_target_wide)[1] <- 'Name'
LDL_below_target_wide$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LDL_below_target_wide)

Base_df[6,1] <- 'Overall'

#IHD
LDL_below_target_IHD_wide <- cbind(Base_df_col_1, LDL_below_target_IHD_wide)
colnames(LDL_below_target_IHD_wide)[1] <- 'Name'
LDL_below_target_IHD_wide$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LDL_below_target_IHD_wide)
Base_df[7,1] <- 'IHD'


#ST
LDL_below_target_ST_wide <- cbind(Base_df_col_1, LDL_below_target_ST_wide)
colnames(LDL_below_target_ST_wide)[1] <- 'Name'
LDL_below_target_ST_wide$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LDL_below_target_ST_wide)
Base_df[8,1] <- 'Stroke'


#PAD
LDL_below_target_PAD_wide <- cbind(Base_df_col_1, LDL_below_target_PAD_wide)
colnames(LDL_below_target_PAD_wide)[1] <- 'Name'
LDL_below_target_PAD_wide$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LDL_below_target_PAD_wide)
Base_df[9,1] <- 'PAD'


#POLY
LDL_below_target_POLY_wide <- cbind(Base_df_col_1, LDL_below_target_POLY_wide)
colnames(LDL_below_target_POLY_wide)[1] <- 'Name'
LDL_below_target_POLY_wide$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LDL_below_target_POLY_wide)
Base_df[10,1] <- 'Poly-vascular'

colnames(Base_df)[1] <- ' '

```

```{r, include=FALSE}

#Replace nulls
Base_df[is.na(Base_df)] <- 0

Base_df_char <- Base_df %>% mutate(across(where(is.numeric), as.character))

#Base_df_char[Base_df_char == '0.0'] <- 'N/A'

colnames(Base_df_char) <- colnames(Base_df)
colnames(Base_df_char)[1] <- ' '

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

Base_df_char %>%
  kbl(caption = 'Suppl Table X. Achieved ESC target LDL-C level (<= 1.8 mmol/L)') %>%
  pack_rows(index = c('Prevalent cases achieving ESC target LDL-C level (%)'=5,                    
                      'Incident cases achieving ESC target LDL-C level (%)'=5), 
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()
```

<br>
<br>


### LLT where LDL controlled

```{r, include=FALSE}

Base_df <- denominator_yr %>% dplyr::select(Year, Name, Denom) %>% pivot_wider(names_from = Year, values_from = Denom)

Base_df[1,1] <- ' '

Base_df_col_1 <- Base_df$Name

```


```{r, include=FALSE}


##Prevalent LDL Controlled

names(LLT_LDL_CTRL_PREV)[names(LLT_LDL_CTRL_PREV)=='year'] <- 'Year'

LLT_LDL_Prev_CTRL_Raw <- LLT_LDL_CTRL_PREV %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_LDL_Prev_CTRL_Raw)[1] <- 'Name'
LLT_LDL_Prev_CTRL_Raw <- Insert_total_of_n(LLT_LDL_Prev_CTRL_Raw,5)

Base_df <- rbind(Base_df, LLT_LDL_Prev_CTRL_Raw)

#Remove denominator row
Base_df <- Base_df[2:7,]


LLT_LDL_Prev_CTRL_pct <- LLT_LDL_CTRL_PREV %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated/4),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_LDL_Prev_CTRL_pct)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_LDL_Prev_CTRL_pct)




##Incident LDL Controlled

names(LLT_LDL_CTRL)[names(LLT_LDL_CTRL)=='year'] <- 'Year'

LLT_LDL_Inc_CTRL_Raw <- LLT_LDL_CTRL %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_LDL_Inc_CTRL_Raw)[1] <- 'Name'
LLT_LDL_Inc_CTRL_Raw <- Insert_total_of_n(LLT_LDL_Inc_CTRL_Raw,5)

LLT_LDL_Inc_CTRL_Raw$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LLT_LDL_Inc_CTRL_Raw)



LLT_LDL_Inc_CTRL_pct <- LLT_LDL_CTRL %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated/4),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_LDL_Inc_CTRL_pct)[1] <- 'Name'

LLT_LDL_Inc_CTRL_pct$'2022' <- 'N/A'


Base_df <- rbind(Base_df, LLT_LDL_Inc_CTRL_pct)

```



```{r, include=FALSE}

#Replace nulls
Base_df[is.na(Base_df)] <- 0

Base_df_char <- Base_df %>% mutate(across(where(is.numeric), as.character))


Base_df_char <- check_decimal(Base_df_char)
Base_df_char$pct <- as.character(Base_df_char$pct)


Base_df_char <- sqldf("SELECT Name,
                      CASE WHEN pct = 1 THEN ROUND([2010],1) ELSE [2010] END AS [2010],
                      CASE WHEN pct = 1 THEN ROUND([2011],1) ELSE [2011] END AS [2011],
                      CASE WHEN pct = 1 THEN ROUND([2012],1) ELSE [2012] END AS [2012],
                      CASE WHEN pct = 1 THEN ROUND([2013],1) ELSE [2013] END AS [2013],
                      CASE WHEN pct = 1 THEN ROUND([2014],1) ELSE [2014] END AS [2014],
                      CASE WHEN pct = 1 THEN ROUND([2015],1) ELSE [2015] END AS [2015],
                      CASE WHEN pct = 1 THEN ROUND([2016],1) ELSE [2016] END AS [2016],
                      CASE WHEN pct = 1 THEN ROUND([2017],1) ELSE [2017] END AS [2017],
                      CASE WHEN pct = 1 THEN ROUND([2018],1) ELSE [2018] END AS [2018],
                      CASE WHEN pct = 1 THEN ROUND([2019],1) ELSE [2019] END AS [2019],
                      CASE WHEN pct = 1 THEN ROUND([2020],1) ELSE [2020] END AS [2020],
                      CASE WHEN pct = 1 THEN ROUND([2021],1) ELSE [2021] END AS [2021],
                      CASE WHEN pct = 1 THEN ROUND([2022],1) ELSE [2022] END AS [2022],
                      [pct]
                      FROM Base_df_char")

Base_df_char[Base_df_char == '0.0'] <- 'N/A'


Base_df_char$pct<- NULL

colnames(Base_df_char) <- colnames(Base_df)
colnames(Base_df_char)[1] <- ' '

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

Base_df_char %>%
  kbl(caption = 'Suppl Table X. LLT where ESC target LDL-C level achieved (<= 1.8 mmol/L)') %>%
  pack_rows(index = c('Prevalent cases treated'=6,
                      'Prevalent cases % treated'=5,
                      'Incident cases treated'=6,
                      'Incident cases % treated'=5), 
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()
```

<br>
<br>

### LLT where LDL not controlled

```{r, include=FALSE}

Base_df <- denominator_yr %>% dplyr::select(Year, Name, Denom) %>% pivot_wider(names_from = Year, values_from = Denom)

Base_df[1,1] <- ' '

Base_df_col_1 <- Base_df$Name

```


```{r, include=FALSE}


##Prevalent LDL Not Controlled

names(LLT_LDL_NO_CTRL_PREV)[names(LLT_LDL_NO_CTRL_PREV)=='year'] <- 'Year'

LLT_LDL_Prev_NO_CTRL_Raw <- LLT_LDL_NO_CTRL_PREV %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_LDL_Prev_NO_CTRL_Raw)[1] <- 'Name'
LLT_LDL_Prev_NO_CTRL_Raw <- Insert_total_of_n(LLT_LDL_Prev_NO_CTRL_Raw,5)

LLT_LDL_Prev_NO_CTRL_pct <- LLT_LDL_NO_CTRL_PREV %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated/4),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_LDL_Prev_NO_CTRL_pct)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_LDL_Prev_NO_CTRL_Raw)

#Remove denominator row
Base_df <- Base_df[2:7,]

Base_df <- rbind(Base_df, LLT_LDL_Prev_NO_CTRL_pct)



##Incident LDL Not Controlled

names(LLT_LDL_NO_CTRL)[names(LLT_LDL_NO_CTRL)=='year'] <- 'Year'

LLT_LDL_Inc_No_CTRL_Raw <- LLT_LDL_NO_CTRL %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_LDL_Inc_No_CTRL_Raw)[1] <- 'Name'
LLT_LDL_Inc_No_CTRL_Raw <- Insert_total_of_n(LLT_LDL_Inc_No_CTRL_Raw,5)

LLT_LDL_Inc_No_CTRL_pct <- LLT_LDL_NO_CTRL %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated/4),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_LDL_Inc_No_CTRL_pct)[1] <- 'Name'

LLT_LDL_Inc_No_CTRL_Raw$'2022' <- 'N/A'
LLT_LDL_Inc_No_CTRL_pct$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LLT_LDL_Inc_No_CTRL_Raw)
Base_df <- rbind(Base_df, LLT_LDL_Inc_No_CTRL_pct)

```



```{r, include=FALSE}

#Replace nulls
Base_df[is.na(Base_df)] <- 0

Base_df_char <- Base_df %>% mutate(across(where(is.numeric), as.character))


Base_df_char <- check_decimal(Base_df_char)
Base_df_char$pct <- as.character(Base_df_char$pct)


Base_df_char <- sqldf("SELECT Name,
                      CASE WHEN pct = 1 THEN ROUND([2010],1) ELSE [2010] END AS [2010],
                      CASE WHEN pct = 1 THEN ROUND([2011],1) ELSE [2011] END AS [2011],
                      CASE WHEN pct = 1 THEN ROUND([2012],1) ELSE [2012] END AS [2012],
                      CASE WHEN pct = 1 THEN ROUND([2013],1) ELSE [2013] END AS [2013],
                      CASE WHEN pct = 1 THEN ROUND([2014],1) ELSE [2014] END AS [2014],
                      CASE WHEN pct = 1 THEN ROUND([2015],1) ELSE [2015] END AS [2015],
                      CASE WHEN pct = 1 THEN ROUND([2016],1) ELSE [2016] END AS [2016],
                      CASE WHEN pct = 1 THEN ROUND([2017],1) ELSE [2017] END AS [2017],
                      CASE WHEN pct = 1 THEN ROUND([2018],1) ELSE [2018] END AS [2018],
                      CASE WHEN pct = 1 THEN ROUND([2019],1) ELSE [2019] END AS [2019],
                      CASE WHEN pct = 1 THEN ROUND([2020],1) ELSE [2020] END AS [2020],
                      CASE WHEN pct = 1 THEN ROUND([2021],1) ELSE [2021] END AS [2021],
                      CASE WHEN pct = 1 THEN ROUND([2022],1) ELSE [2022] END AS [2022],
                      [pct]
                      FROM Base_df_char")

Base_df_char[Base_df_char == '0.0'] <- 'N/A'


Base_df_char$pct<- NULL

colnames(Base_df_char) <- colnames(Base_df)
colnames(Base_df_char)[1] <- ' '

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

Base_df_char %>%
  kbl(caption = 'Suppl Table X. LLT prior to ESC target LDL-C level not achieved (> 1.8 mmol/L)') %>%
  pack_rows(index = c('Prevalent cases treated'=6,
                      'Prevalent cases % treated'=5,
                      'Incident cases treated'=6,
                      'Incident cases % treated'=5), 
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()
```

<br>
<br>

### LLT Poly 

```{r, include=FALSE}

LLT_POLY_PAD <- db2_run(conn = Connection, query = 'SELECT DRUG_YR AS YEAR, LLT, TYPE, COUNT(LLT) AS LLT FROM SAILW1483V.TEMP_LLT_POLY_PAD_PREV GROUP BY DRUG_YR, TYPE, LLT ORDER BY DRUG_YR, TYPE, LLT')

LLT_POLY_PAD <- subset(LLT_POLY_PAD, LLT_POLY_PAD$year <= 2022)

#Rename columns
names(LLT_POLY_PAD)[names(LLT_POLY_PAD)=='llt'] <- 'LLT'
names(LLT_POLY_PAD)[names(LLT_POLY_PAD)=='llt_1'] <- 'Count'

LLT_POLY_PAD$LLT <- replace(LLT_POLY_PAD$LLT, LLT_POLY_PAD$LLT == 'HIGH_STATIN', 'High-intensity statin')
LLT_POLY_PAD$LLT <- replace(LLT_POLY_PAD$LLT, LLT_POLY_PAD$LLT == 'LOW_STATIN', 'Non-high-intensity statin')
LLT_POLY_PAD$LLT <- replace(LLT_POLY_PAD$LLT, LLT_POLY_PAD$LLT == 'NOTX', 'No treatment')
LLT_POLY_PAD$LLT <- replace(LLT_POLY_PAD$LLT, LLT_POLY_PAD$LLT == 'INEGY', 'Combination statin')
LLT_POLY_PAD$LLT <- replace(LLT_POLY_PAD$LLT, LLT_POLY_PAD$LLT == 'STATIN_COMBI', 'Combination statin')
LLT_POLY_PAD$LLT <- replace(LLT_POLY_PAD$LLT, LLT_POLY_PAD$LLT == 'OTHER', 'Other treatment')
LLT_POLY_PAD$type <- replace(LLT_POLY_PAD$type, LLT_POLY_PAD$type == 'ST', 'Stroke')
LLT_POLY_PAD$type <- replace(LLT_POLY_PAD$type, LLT_POLY_PAD$type == 'POLY', 'Poly-vascular')

LLT_POLY_PAD$LLT <- factor(LLT_POLY_PAD$LLT, levels= c('Combination statin', 'High-intensity statin', 'Non-high-intensity statin', 'Other treatment', 'No treatment'))

```

```{r, include=FALSE}

#Controlled
LLT_POLY_PAD_Inc <- db2_run(conn = Connection, query = 'SELECT DRUG_YR AS YEAR, LLT, TYPE, COUNT(LLT) AS LLT FROM SAILW1483V.TEMP_LLT_POLY_PAD_INC GROUP BY DRUG_YR, TYPE, LLT ORDER BY DRUG_YR, TYPE, LLT')

LLT_POLY_PAD_Inc <- subset(LLT_POLY_PAD_Inc, LLT_POLY_PAD_Inc$year < 2022)

#Rename columns
names(LLT_POLY_PAD_Inc)[names(LLT_POLY_PAD_Inc)=='llt'] <- 'LLT'
names(LLT_POLY_PAD_Inc)[names(LLT_POLY_PAD_Inc)=='llt_1'] <- 'Count'

LLT_POLY_PAD_Inc$LLT <- replace(LLT_POLY_PAD_Inc$LLT, LLT_POLY_PAD_Inc$LLT == 'HIGH_STATIN', 'Combination or high-intensity statin')
LLT_POLY_PAD_Inc$LLT <- replace(LLT_POLY_PAD_Inc$LLT, LLT_POLY_PAD_Inc$LLT == 'LOW_STATIN', 'Non-high-intensity statin')
LLT_POLY_PAD_Inc$LLT <- replace(LLT_POLY_PAD_Inc$LLT, LLT_POLY_PAD_Inc$LLT == 'NOTX', 'Other or no treatment')
LLT_POLY_PAD_Inc$LLT <- replace(LLT_POLY_PAD_Inc$LLT, LLT_POLY_PAD_Inc$LLT == 'INEGY', 'Combination or high-intensity statin')
LLT_POLY_PAD_Inc$LLT <- replace(LLT_POLY_PAD_Inc$LLT, LLT_POLY_PAD_Inc$LLT == 'STATIN_COMBI', 'Combination or high-intensity statin')
LLT_POLY_PAD_Inc$LLT <- replace(LLT_POLY_PAD_Inc$LLT, LLT_POLY_PAD_Inc$LLT == 'OTHER', 'Other or no treatment')

LLT_POLY_PAD_Inc$LLT <- factor(LLT_POLY_PAD_Inc$LLT, levels= c('Combination or high-intensity statin', 'Non-high-intensity statin', 'Other or no treatment'))

LLT_POLY_PAD_Inc <- LLT_POLY_PAD_Inc %>% group_by(year, LLT, type) %>% summarise(Count = sum(Count))

```

```{r, include=FALSE}

Base_df <- denominator_yr %>% dplyr::select(Year, Name, Denom) %>% pivot_wider(names_from = Year, values_from = Denom)

Base_df[1,1] <- ' '

Base_df_col_1 <- Base_df$Name

```

```{r, include=FALSE}

#Denominators
#Prevalent treated per year
names(LLT_POLY_PAD)[names(LLT_POLY_PAD)=='year'] <- 'Year'

#Incident treated per year
names(LLT_POLY_PAD_Inc)[names(LLT_POLY_PAD_Inc)=='year'] <- 'Year'

LLT_POLY_PAD_PREV_Denom_IHD_PAD <- subset(LLT_POLY_PAD, type == 'IHD PAD') %>% dplyr::select(Year, Count) %>% group_by(Year) %>% summarise(Total = sum(Count)) 
LLT_POLY_PAD_PREV_Denom_PAD_ST <- subset(LLT_POLY_PAD, type == 'PAD ST') %>% dplyr::select(Year, Count) %>% group_by(Year) %>% summarise(Total = sum(Count)) 
LLT_POLY_PAD_PREV_Denom_ST_IHD_PAD <- subset(LLT_POLY_PAD, type == 'ST IHD PAD') %>% dplyr::select(Year, Count) %>% group_by(Year) %>% summarise(Total = sum(Count)) 

LLT_POLY_PAD_Inc_Denom_INCL_IHD <- subset(LLT_POLY_PAD_Inc, type == 'Including IHD') %>% dplyr::select(Year, Count) %>% group_by(Year) %>% summarise(Total = sum(Count)) 
LLT_POLY_PAD_Inc_Denom_NOT_INCL_IHD <- subset(LLT_POLY_PAD_Inc, type == 'Not including IHD') %>% dplyr::select(Year, Count) %>% group_by(Year) %>% summarise(Total = sum(Count))

#Prev
LLT_POLY_PAD_PREV_Denom_IHD_PAD$type <- 'IHD PAD'
POLY_PAD_Denom_df_prev <- LLT_POLY_PAD_PREV_Denom_IHD_PAD
LLT_POLY_PAD_PREV_Denom_PAD_ST$type <- 'PAD ST'
POLY_PAD_Denom_df_prev <- rbind(POLY_PAD_Denom_df_prev, LLT_POLY_PAD_PREV_Denom_PAD_ST)
LLT_POLY_PAD_PREV_Denom_ST_IHD_PAD$type <- 'ST IHD PAD'
POLY_PAD_Denom_df_prev <- rbind(POLY_PAD_Denom_df_prev, LLT_POLY_PAD_PREV_Denom_ST_IHD_PAD)

#Inc
LLT_POLY_PAD_Inc_Denom_INCL_IHD$type <- 'Including IHD'
POLY_PAD_Denom_df_inc <- LLT_POLY_PAD_Inc_Denom_INCL_IHD
LLT_POLY_PAD_Inc_Denom_NOT_INCL_IHD$type <- 'Not including IHD'
POLY_PAD_Denom_df_inc <- rbind(POLY_PAD_Denom_df_inc, LLT_POLY_PAD_Inc_Denom_NOT_INCL_IHD)

names(POLY_PAD_Denom_df_prev)[names(POLY_PAD_Denom_df_prev)=='Year'] <- 'year'
names(POLY_PAD_Denom_df_inc)[names(POLY_PAD_Denom_df_inc)=='Year'] <- 'year'


POLY_PAD_Denom_Overall <- POLY_PAD_Denom_df_prev %>% group_by(year) %>% summarise(Total = sum(Total))
POLY_PAD_Denom_Overall$type <- 'Overall'
POLY_PAD_Denom <- rbind(POLY_PAD_Denom_df_prev, POLY_PAD_Denom_Overall)
POLY_PAD_Denom <- subset(POLY_PAD_Denom, year <= 2022)

POLY_PAD_Denom_Inc_Overall <- POLY_PAD_Denom_df_inc %>% group_by(year) %>% summarise(Total = sum(Total))
POLY_PAD_Denom_Inc_Overall$type <- 'Overall'
POLY_PAD_Denom_Inc <- rbind(POLY_PAD_Denom_df_inc, POLY_PAD_Denom_Inc_Overall)
POLY_PAD_Denom_Inc <- subset(POLY_PAD_Denom_Inc, year < 2022)

```

```{r, include=FALSE}

##Prevalent Poly containing PAD

#Calculate pct - Prev
names(LLT_POLY_PAD)[names(LLT_POLY_PAD)=='Year'] <- 'year'

Overall_LLT_POLY_PAD_Prev <- LLT_POLY_PAD %>% group_by(year, LLT) %>% summarise(Count = sum(Count))
Overall_LLT_POLY_PAD_Prev$type <- 'Overall'
LLT_POLY_PAD_Prev_Calc <- rbind(dplyr::select(LLT_POLY_PAD, LLT, year, type, Count), Overall_LLT_POLY_PAD_Prev)

LLT_POLY_PAD_Prev_Calc <- inner_join(x=LLT_POLY_PAD_Prev_Calc, y=POLY_PAD_Denom, by = c('year' = 'year', 'type' = 'type'))
colnames(LLT_POLY_PAD_Prev_Calc)[4] <- 'Treated'
colnames(LLT_POLY_PAD_Prev_Calc)[5] <- 'Prevalence'
LLT_POLY_PAD_Prev_Calc$pct_treated <- round((LLT_POLY_PAD_Prev_Calc$Treated / LLT_POLY_PAD_Prev_Calc$Prevalence) * 100,2)


##Prevalent Poly containing PAD - Overall

LLT_POLY_PAD_ALL <- subset(LLT_POLY_PAD_Prev_Calc, type == 'Overall')

names(LLT_POLY_PAD_ALL)[names(LLT_POLY_PAD_ALL)=='year'] <- 'Year'

LLT_POLY_PAD_ALL_Raw <- LLT_POLY_PAD_ALL %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_ALL_Raw)[1] <- 'Name'
LLT_POLY_PAD_ALL_Raw <- Insert_total_of_n(LLT_POLY_PAD_ALL_Raw,5)

LLT_POLY_PAD_ALL_pct <- LLT_POLY_PAD_ALL %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = pct_treated) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_ALL_pct)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_POLY_PAD_ALL_Raw)

#Remove denominator row
Base_df <- Base_df[2:7,]

Base_df <- rbind(Base_df, LLT_POLY_PAD_ALL_pct)

```

```{r, include=FALSE}

##Prevalent Poly containing PAD - ST IHD PAD

LLT_POLY_PAD_INCL_ST_IHD_PAD <- subset(LLT_POLY_PAD_Prev_Calc, type == 'ST IHD PAD')

names(LLT_POLY_PAD_INCL_ST_IHD_PAD)[names(LLT_POLY_PAD_INCL_ST_IHD_PAD)=='year'] <- 'Year'

LLT_POLY_PAD_INCL_ST_IHD_PAD_Raw <- LLT_POLY_PAD_INCL_ST_IHD_PAD %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_INCL_ST_IHD_PAD_Raw)[1] <- 'Name'
LLT_POLY_PAD_INCL_ST_IHD_PAD_Raw <- Insert_total_of_n(LLT_POLY_PAD_INCL_ST_IHD_PAD_Raw,5)

LLT_POLY_PAD_INCL_ST_IHD_PAD_pct <- LLT_POLY_PAD_INCL_ST_IHD_PAD %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_INCL_ST_IHD_PAD_pct)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_POLY_PAD_INCL_ST_IHD_PAD_Raw)
Base_df <- rbind(Base_df, LLT_POLY_PAD_INCL_ST_IHD_PAD_pct)

##Prevalent Poly containing PAD - IHD PAD

LLT_POLY_PAD_INCL_IHD_PAD <- subset(LLT_POLY_PAD_Prev_Calc, type == 'IHD PAD')

names(LLT_POLY_PAD_INCL_IHD_PAD)[names(LLT_POLY_PAD_INCL_IHD_PAD)=='year'] <- 'Year'

LLT_POLY_PAD_INCL_IHD_PAD_Raw <- LLT_POLY_PAD_INCL_IHD_PAD %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_INCL_IHD_PAD_Raw)[1] <- 'Name'
LLT_POLY_PAD_INCL_IHD_PAD_Raw <- Insert_total_of_n(LLT_POLY_PAD_INCL_IHD_PAD_Raw,5)

LLT_POLY_PAD_INCL_IHD_PAD_pct <- LLT_POLY_PAD_INCL_IHD_PAD %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_INCL_IHD_PAD_pct)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_POLY_PAD_INCL_IHD_PAD_Raw)
Base_df <- rbind(Base_df, LLT_POLY_PAD_INCL_IHD_PAD_pct)


##Prevalent Poly containing PAD - PAD ST

LLT_POLY_PAD_NOT_INCL_PAD_ST <- subset(LLT_POLY_PAD_Prev_Calc, type == 'PAD ST')

names(LLT_POLY_PAD_NOT_INCL_PAD_ST)[names(LLT_POLY_PAD_NOT_INCL_PAD_ST)=='year'] <- 'Year'

LLT_POLY_PAD_NOT_INCL_PAD_ST_Raw <- LLT_POLY_PAD_NOT_INCL_PAD_ST %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_NOT_INCL_PAD_ST_Raw)[1] <- 'Name'
LLT_POLY_PAD_NOT_INCL_PAD_ST_Raw <- Insert_total_of_n(LLT_POLY_PAD_NOT_INCL_PAD_ST_Raw,5)

LLT_POLY_PAD_NOT_INCL_PAD_ST_pct <- LLT_POLY_PAD_NOT_INCL_PAD_ST %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_NOT_INCL_PAD_ST_pct)[1] <- 'Name'

Base_df <- rbind(Base_df, LLT_POLY_PAD_NOT_INCL_PAD_ST_Raw)
Base_df <- rbind(Base_df, LLT_POLY_PAD_NOT_INCL_PAD_ST_pct)

```

```{r, include=FALSE}

##Incident Poly containing PAD

#Calculate pct - Inc
POLY_PAD_Denom_Inc$type <- replace(POLY_PAD_Denom_Inc$type, POLY_PAD_Denom_Inc$type == 'IHD PAD', 'Including IHD')
POLY_PAD_Denom_Inc$type <- replace(POLY_PAD_Denom_Inc$type, POLY_PAD_Denom_Inc$type == 'ST IHD PAD', 'Including IHD')
POLY_PAD_Denom_Inc$type <- replace(POLY_PAD_Denom_Inc$type, POLY_PAD_Denom_Inc$type == 'PAD ST', 'Not including IHD')

POLY_PAD_Denom_Inc <- POLY_PAD_Denom_Inc %>% group_by(year, type) %>% summarise(Total = sum(Total))

names(LLT_POLY_PAD_Inc)[names(LLT_POLY_PAD_Inc)=='Year'] <- 'year'

Overall_LLT_POLY_PAD_Inc <- LLT_POLY_PAD_Inc %>% group_by(year, LLT) %>% summarise(Count = sum(Count))
Overall_LLT_POLY_PAD_Inc$type <- 'Overall'
LLT_POLY_PAD_Inc_Calc <- rbind(dplyr::select(LLT_POLY_PAD_Inc, year, type, Count), Overall_LLT_POLY_PAD_Inc)

LLT_POLY_PAD_Inc_Calc <- inner_join(x=LLT_POLY_PAD_Inc_Calc, y=POLY_PAD_Denom_Inc, by = c('year' = 'year', 'type' = 'type'))
colnames(LLT_POLY_PAD_Inc_Calc)[4] <- 'Treated'
colnames(LLT_POLY_PAD_Inc_Calc)[5] <- 'Incidence'
LLT_POLY_PAD_Inc_Calc$pct_treated <- round((LLT_POLY_PAD_Inc_Calc$Treated / LLT_POLY_PAD_Inc_Calc$Incidence) * 100,2)

##Overall

LLT_POLY_PAD_ALL <- subset(LLT_POLY_PAD_Inc_Calc, type == 'Overall')

names(LLT_POLY_PAD_ALL)[names(LLT_POLY_PAD_ALL)=='year'] <- 'Year'

LLT_POLY_PAD_ALL_Raw <- LLT_POLY_PAD_ALL %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_ALL_Raw)[1] <- 'Name'
LLT_POLY_PAD_ALL_Raw <- Insert_total_of_n(LLT_POLY_PAD_ALL_Raw,3)

LLT_POLY_PAD_ALL_pct <- LLT_POLY_PAD_ALL %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_ALL_pct)[1] <- 'Name'

LLT_POLY_PAD_ALL_Raw$'2022' <- 'N/A'
LLT_POLY_PAD_ALL_pct$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LLT_POLY_PAD_ALL_Raw)

Base_df <- rbind(Base_df, LLT_POLY_PAD_ALL_pct)

```


```{r, include=FALSE}
##Incident Poly containing PAD - Including IHD

LLT_POLY_PAD_INCL_IHD <- subset(LLT_POLY_PAD_Inc_Calc, type == 'Including IHD')

names(LLT_POLY_PAD_INCL_IHD)[names(LLT_POLY_PAD_INCL_IHD)=='year'] <- 'Year'

LLT_POLY_PAD_INCL_IHD_Raw <- LLT_POLY_PAD_INCL_IHD %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_INCL_IHD_Raw)[1] <- 'Name'
LLT_POLY_PAD_INCL_IHD_Raw <- Insert_total_of_n(LLT_POLY_PAD_INCL_IHD_Raw,3)

LLT_POLY_PAD_INCL_IHD_pct <- LLT_POLY_PAD_INCL_IHD %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_INCL_IHD_pct)[1] <- 'Name'

LLT_POLY_PAD_INCL_IHD_Raw$'2022' <- 'N/A'
LLT_POLY_PAD_INCL_IHD_pct$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LLT_POLY_PAD_INCL_IHD_Raw)
Base_df <- rbind(Base_df, LLT_POLY_PAD_INCL_IHD_pct)

##Incident Poly containing PAD - Not containing IHD

LLT_POLY_PAD_NOT_INCL_IHD <- subset(LLT_POLY_PAD_Inc_Calc, type == 'Not including IHD')

names(LLT_POLY_PAD_NOT_INCL_IHD)[names(LLT_POLY_PAD_NOT_INCL_IHD)=='year'] <- 'Year'

LLT_POLY_PAD_NOT_INCL_IHD_Raw <- LLT_POLY_PAD_NOT_INCL_IHD %>% dplyr::select(Year, LLT, Treated) %>% group_by(Year, LLT) %>% summarise(Treated = sum(Treated)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_NOT_INCL_IHD_Raw)[1] <- 'Name'
LLT_POLY_PAD_NOT_INCL_IHD_Raw <- Insert_total_of_n(LLT_POLY_PAD_NOT_INCL_IHD_Raw,3)

LLT_POLY_PAD_NOT_INCL_IHD_pct <- LLT_POLY_PAD_NOT_INCL_IHD %>% dplyr::select(Year, LLT, pct_treated) %>% group_by(Year, LLT) %>% summarise(Treated = round(sum(pct_treated),2)) %>% pivot_wider(names_from = Year, values_from = Treated) %>% arrange(LLT)
colnames(LLT_POLY_PAD_NOT_INCL_IHD_pct)[1] <- 'Name'

LLT_POLY_PAD_NOT_INCL_IHD_Raw$'2022' <- 'N/A'
LLT_POLY_PAD_NOT_INCL_IHD_pct$'2022' <- 'N/A'

Base_df <- rbind(Base_df, LLT_POLY_PAD_NOT_INCL_IHD_Raw)
Base_df <- rbind(Base_df, LLT_POLY_PAD_NOT_INCL_IHD_pct)

```

```{r, include=FALSE}

#Replace nulls
Base_df[is.na(Base_df)] <- 0

Base_df_char <- Base_df %>% mutate(across(where(is.numeric), as.character))

Base_df_char <- check_decimal(Base_df_char)
Base_df_char$pct <- as.character(Base_df_char$pct)


Base_df_char <- sqldf("SELECT Name,
                      CASE WHEN pct = 1 THEN ROUND([2010],1) ELSE [2010] END AS [2010],
                      CASE WHEN pct = 1 THEN ROUND([2011],1) ELSE [2011] END AS [2011],
                      CASE WHEN pct = 1 THEN ROUND([2012],1) ELSE [2012] END AS [2012],
                      CASE WHEN pct = 1 THEN ROUND([2013],1) ELSE [2013] END AS [2013],
                      CASE WHEN pct = 1 THEN ROUND([2014],1) ELSE [2014] END AS [2014],
                      CASE WHEN pct = 1 THEN ROUND([2015],1) ELSE [2015] END AS [2015],
                      CASE WHEN pct = 1 THEN ROUND([2016],1) ELSE [2016] END AS [2016],
                      CASE WHEN pct = 1 THEN ROUND([2017],1) ELSE [2017] END AS [2017],
                      CASE WHEN pct = 1 THEN ROUND([2018],1) ELSE [2018] END AS [2018],
                      CASE WHEN pct = 1 THEN ROUND([2019],1) ELSE [2019] END AS [2019],
                      CASE WHEN pct = 1 THEN ROUND([2020],1) ELSE [2020] END AS [2020],
                      CASE WHEN pct = 1 THEN ROUND([2021],1) ELSE [2021] END AS [2021],
                      CASE WHEN pct = 1 THEN ROUND([2022],1) ELSE [2022] END AS [2022],
                      [pct]
                      FROM Base_df_char")

Base_df_char[Base_df_char == '0.0'] <- 'N/A'


Base_df_char$pct<- NULL

colnames(Base_df_char) <- colnames(Base_df)
colnames(Base_df_char)[1] <- ' '

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

Base_df_char %>%
  kbl(caption = 'Suppl Table X. Poly-vascular with PAD - Prescribed LLT.') %>%
  pack_rows(index = c('Prevalent cases treated (each year) - Overall'=6,
                      'Prevalent cases % treated (each year) - Overall'=5,
                      'Prevalent cases treated (each year) - ST IHD PAD'=6,
                      'Prevalent cases % treated (each year) - ST IHD PAD'=5,
                      'Prevalent cases treated (each year) - IHD PAD'=6,
                      'Prevalent cases % treated (each year) - IHD PAD'=5,
                      'Prevalent cases treated (each year) - PAD ST'=6,
                      'Prevalent cases % treated (each year) - PAD ST'=5,
                      'Incident cases treated (first year) - Overall'=4,
                      'Incident cases % treated (first year) - Overall'=3,
                      'Incident cases treated (first year) - Including IHD'=4,
                      'Incident cases % treated (first year) - Including IHD'=3,
                      'Incident cases treated (first year) - Not including IHD'=4,
                      'Incident cases % treated (first year) - Not including IHD'=3                      
                      ),
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()
```

<br>
<br>

### Prior prescriptions

```{r, include=FALSE}

#Did receive

Prev_2022_No_HI_statin <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_PREV_2022_NO_HI_STATIN')
Prev_2010_No_HI_statin <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_PREV_2010_NO_HI_STATIN')
Inc_2021_No_HI_statin <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_INC_2021_NO_HI_STATIN')
Inc_2010_No_HI_statin <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_INC_2010_NO_HI_STATIN')

Prev_2022_No_treat <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_PREV_2022_NO_TREAT')
Prev_2010_No_treat <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_PREV_2010_NO_TREAT')
Inc_2021_No_treat <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_INC_2021_NO_TREAT')
Inc_2010_No_treat <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_INC_2010_NO_TREAT')

Prev_2022_No_HI_statin_count <- Prev_2022_No_HI_statin %>% summarise(n = n())
Prev_2022_No_HI_statin_mean_follow_up <- Prev_2022_No_HI_statin %>% summarise(mean = mean(follow_up_yrs))
Prev_2022_No_HI_statin_sd_follow_up <- Prev_2022_No_HI_statin %>% summarise(sd = sd(follow_up_yrs))

Prev_2010_No_HI_statin_count <- Prev_2010_No_HI_statin %>% summarise(n = n())
Prev_2010_No_HI_statin_mean_follow_up <- Prev_2010_No_HI_statin %>% summarise(mean = mean(follow_up_yrs))
Prev_2010_No_HI_statin_sd_follow_up <- Prev_2010_No_HI_statin %>% summarise(sd = sd(follow_up_yrs))


Inc_2021_No_HI_statin_count <- Inc_2021_No_HI_statin %>% summarise(n = n())
Inc_2021_No_HI_statin_mean_follow_up <- Inc_2021_No_HI_statin %>% summarise(mean = mean(follow_up_yrs))
Inc_2021_No_HI_statin_sd_follow_up <- Inc_2021_No_HI_statin %>% summarise(sd = sd(follow_up_yrs))

Inc_2010_No_HI_statin_count <- Inc_2010_No_HI_statin %>% summarise(n = n())
Inc_2010_No_HI_statin_mean_follow_up <- Inc_2010_No_HI_statin %>% summarise(mean = mean(follow_up_yrs))
Inc_2010_No_HI_statin_sd_follow_up <- Inc_2010_No_HI_statin %>% summarise(sd = sd(follow_up_yrs))


Prev_2022_No_treat_count <- Prev_2022_No_treat %>% summarise(n = n())
Prev_2022_No_treat_mean_follow_up <- Prev_2022_No_treat %>% summarise(mean = mean(follow_up_yrs))
Prev_2022_No_treat_sd_follow_up <- Prev_2022_No_treat %>% summarise(sd = sd(follow_up_yrs))

Prev_2010_No_treat_count <- Prev_2010_No_treat %>% summarise(n = n())
Prev_2010_No_treat_mean_follow_up <- Prev_2010_No_treat %>% summarise(mean = mean(follow_up_yrs))
Prev_2010_No_treat_sd_follow_up <- Prev_2010_No_treat %>% summarise(sd = sd(follow_up_yrs))


Inc_2021_No_treat_count <- Inc_2021_No_treat %>% summarise(n = n())
Inc_2021_No_treat_mean_follow_up <- Inc_2021_No_treat %>% summarise(mean = mean(follow_up_yrs))
Inc_2021_No_treat_sd_follow_up <- Inc_2021_No_treat %>% summarise(sd = sd(follow_up_yrs))

Inc_2010_No_treat_count <- Inc_2010_No_treat %>% summarise(n = n())
Inc_2010_No_treat_mean_follow_up <- Inc_2010_No_treat %>% summarise(mean = mean(follow_up_yrs))
Inc_2010_No_treat_sd_follow_up <- Inc_2010_No_treat %>% summarise(sd = sd(follow_up_yrs))


Prev_2022_No_HI_statin_N <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_PREV_2022_NO_HI_STATIN_N')
Prev_2010_No_HI_statin_N <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_PREV_2010_NO_HI_STATIN_N')
Inc_2021_No_HI_statin_N <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_INC_2021_NO_HI_STATIN_N')
Inc_2010_No_HI_statin_N <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_INC_2010_NO_HI_STATIN_N')

Prev_2022_No_treat_N <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_PREV_2022_NO_TREAT_N')
Prev_2010_No_treat_N <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_PREV_2010_NO_TREAT_N')
Inc_2021_No_treat_N <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_INC_2021_NO_TREAT_N')
Inc_2010_No_treat_N <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.TEMP_INC_2010_NO_TREAT_N')

Prev_2022_No_HI_statin_N_count <- Prev_2022_No_HI_statin_N %>% summarise(n = n())
Prev_2022_No_HI_statin_N_mean_follow_up <- Prev_2022_No_HI_statin_N %>% summarise(mean = mean(follow_up_yrs))
Prev_2022_No_HI_statin_N_sd_follow_up <- Prev_2022_No_HI_statin_N %>% summarise(sd = sd(follow_up_yrs))

Prev_2010_No_HI_statin_N_count <- Prev_2010_No_HI_statin_N %>% summarise(n = n())
Prev_2010_No_HI_statin_N_mean_follow_up <- Prev_2010_No_HI_statin_N %>% summarise(mean = mean(follow_up_yrs))
Prev_2010_No_HI_statin_N_sd_follow_up <- Prev_2010_No_HI_statin_N %>% summarise(sd = sd(follow_up_yrs))


Inc_2021_No_HI_statin_N_count <- Inc_2021_No_HI_statin_N %>% summarise(n = n())
Inc_2021_No_HI_statin_N_mean_follow_up <- Inc_2021_No_HI_statin_N %>% summarise(mean = mean(follow_up_yrs))
Inc_2021_No_HI_statin_N_sd_follow_up <- Inc_2021_No_HI_statin_N %>% summarise(sd = sd(follow_up_yrs))

Inc_2010_No_HI_statin_N_count <- Inc_2010_No_HI_statin_N %>% summarise(n = n())
Inc_2010_No_HI_statin_N_mean_follow_up <- Inc_2010_No_HI_statin_N %>% summarise(mean = mean(follow_up_yrs))
Inc_2010_No_HI_statin_N_sd_follow_up <- Inc_2010_No_HI_statin_N %>% summarise(sd = sd(follow_up_yrs))


Prev_2022_No_treat_N_count <- Prev_2022_No_treat_N %>% summarise(n = n())
Prev_2022_No_treat_N_mean_follow_up <- Prev_2022_No_treat_N %>% summarise(mean = mean(follow_up_yrs))
Prev_2022_No_treat_N_sd_follow_up <- Prev_2022_No_treat_N %>% summarise(sd = sd(follow_up_yrs))

Prev_2010_No_treat_N_count <- Prev_2010_No_treat_N %>% summarise(n = n())
Prev_2010_No_treat_N_mean_follow_up <- Prev_2010_No_treat_N %>% summarise(mean = mean(follow_up_yrs))
Prev_2010_No_treat_N_sd_follow_up <- Prev_2010_No_treat_N %>% summarise(sd = sd(follow_up_yrs))


Inc_2021_No_treat_N_count <- Inc_2021_No_treat_N %>% summarise(n = n())
Inc_2021_No_treat_N_mean_follow_up <- Inc_2021_No_treat_N %>% summarise(mean = mean(follow_up_yrs))
Inc_2021_No_treat_N_sd_follow_up <- Inc_2021_No_treat_N %>% summarise(sd = sd(follow_up_yrs))

Inc_2010_No_treat_N_count <- Inc_2010_No_treat_N %>% summarise(n = n())
Inc_2010_No_treat_N_mean_follow_up <- Inc_2010_No_treat_N %>% summarise(mean = mean(follow_up_yrs))
Inc_2010_No_treat_N_sd_follow_up <- Inc_2010_No_treat_N %>% summarise(sd = sd(follow_up_yrs))

```

```{r, include=FALSE}

#Initialise prev table

Prev_table <- as.data.frame(cbind('2022','',''))
colnames(Prev_table) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

#2022 had statin

Temp_X <- as.data.frame(cbind('Had received', paste(Prev_2022_No_HI_statin_count,' ','(', round(Prev_2022_No_HI_statin_count / (Prev_2022_No_HI_statin_count + Prev_2022_No_HI_statin_N_count)*100,0),'%)', sep = ''), paste(round(Prev_2022_No_HI_statin_mean_follow_up,1),' ','(',round(Prev_2022_No_HI_statin_sd_follow_up,1),')', sep = '')
  ))

colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Prev_table <- rbind(Prev_table, Temp_X)

#2022 not had statin

Temp_X <- as.data.frame(cbind('Had not received', paste(Prev_2022_No_HI_statin_N_count,' ','(', round(Prev_2022_No_HI_statin_N_count / (Prev_2022_No_HI_statin_count + Prev_2022_No_HI_statin_N_count)*100,0),'%)', sep = ''), paste(round(Prev_2022_No_HI_statin_N_mean_follow_up,1),' ','(',round(Prev_2022_No_HI_statin_N_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Prev_table <- rbind(Prev_table, Temp_X)


Temp_X <- as.data.frame(cbind('2010','',''))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')
Prev_table <- rbind(Prev_table, Temp_X)


#2010 had statin

Temp_X <- as.data.frame(cbind('Had received', paste(Prev_2010_No_HI_statin_count,' ','(', round(Prev_2010_No_HI_statin_count / (Prev_2010_No_HI_statin_count + Prev_2010_No_HI_statin_N_count)*100,0),'%)', sep = ''), paste(round(Prev_2010_No_HI_statin_mean_follow_up,1),' ','(',round(Prev_2010_No_HI_statin_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Prev_table <- rbind(Prev_table, Temp_X)

#2010 not had statin

Temp_X <- as.data.frame(cbind('Had not received', paste(Prev_2010_No_HI_statin_N_count,' ','(', round(Prev_2010_No_HI_statin_N_count / (Prev_2010_No_HI_statin_count + Prev_2010_No_HI_statin_N_count)*100,0),'%)', sep = ''), paste(round(Prev_2010_No_HI_statin_N_mean_follow_up,1),' ','(',round(Prev_2010_No_HI_statin_N_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Prev_table <- rbind(Prev_table, Temp_X)



Temp_X <- as.data.frame(cbind('2022','',''))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')
Prev_table <- rbind(Prev_table, Temp_X)


#2022 had treatment

Temp_X <- as.data.frame(cbind('Had received', paste(Prev_2022_No_treat_count,' ','(', round(Prev_2022_No_treat_count / (Prev_2022_No_treat_count + Prev_2022_No_treat_N_count)*100,0),'%)', sep = ''), paste(round(Prev_2022_No_treat_mean_follow_up,1),' ','(',round(Prev_2022_No_treat_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Prev_table <- rbind(Prev_table, Temp_X)

#2022 not had treatment

Temp_X <- as.data.frame(cbind('Had not received', paste(Prev_2022_No_treat_N_count,' ','(', round(Prev_2022_No_treat_N_count / (Prev_2022_No_treat_count + Prev_2022_No_treat_N_count)*100,0),'%)', sep = ''), paste(round(Prev_2022_No_treat_N_mean_follow_up,1),' ','(',round(Prev_2022_No_treat_N_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Prev_table <- rbind(Prev_table, Temp_X)



Temp_X <- as.data.frame(cbind('2010','',''))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')
Prev_table <- rbind(Prev_table, Temp_X)



#2010 had treatment

Temp_X <- as.data.frame(cbind('Had received', paste(Prev_2010_No_treat_count,' ','(', round(Prev_2010_No_treat_count / (Prev_2010_No_treat_count + Prev_2010_No_treat_N_count)*100,0),'%)', sep = ''), paste(round(Prev_2010_No_treat_mean_follow_up,1),' ','(',round(Prev_2010_No_treat_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Prev_table <- rbind(Prev_table, Temp_X)

#2010 not had treatment

Temp_X <- as.data.frame(cbind('Had not received', paste(Prev_2010_No_treat_N_count,' ','(', round(Prev_2010_No_treat_N_count / (Prev_2010_No_treat_count + Prev_2010_No_treat_N_count)*100,0),'%)', sep = ''), paste(round(Prev_2010_No_treat_N_mean_follow_up,1),' ','(',round(Prev_2010_No_treat_N_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Prev_table <- rbind(Prev_table, Temp_X)



```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
Prev_table %>% 
  kbl(caption = 'Suppl Table X. Prevalent ') %>%
  pack_rows(index = c('No high-intensity statin therapy – received high-intensity statin prior'=6,
                      'No lipid-lowering therapy – received any statin therapy prior'=6), 
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()
```

<br>
<br>

```{r, include=FALSE}

#Initialise Inc table

Inc_table <- as.data.frame(cbind('2021','',''))
colnames(Inc_table) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

#2021 had statin

Temp_X <- as.data.frame(cbind('Had received', paste(Inc_2021_No_HI_statin_count,' ','(', round(Inc_2021_No_HI_statin_count / (Inc_2021_No_HI_statin_count + Inc_2021_No_HI_statin_N_count)*100,0),'%)', sep = ''), paste(round(Inc_2021_No_HI_statin_mean_follow_up,1),' ','(',round(Inc_2021_No_HI_statin_sd_follow_up,1),')', sep = '')
  ))

colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Inc_table <- rbind(Inc_table, Temp_X)

#2021 not had statin

Temp_X <- as.data.frame(cbind('Had not received', paste(Inc_2021_No_HI_statin_N_count,' ','(', round(Inc_2021_No_HI_statin_N_count / (Inc_2021_No_HI_statin_count + Inc_2021_No_HI_statin_N_count)*100,0),'%)', sep = ''), paste(round(Inc_2021_No_HI_statin_N_mean_follow_up,1),' ','(',round(Inc_2021_No_HI_statin_N_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Inc_table <- rbind(Inc_table, Temp_X)


Temp_X <- as.data.frame(cbind('2010','',''))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')
Inc_table <- rbind(Inc_table, Temp_X)


#2010 had statin

Temp_X <- as.data.frame(cbind('Had received', paste(Inc_2010_No_HI_statin_count,' ','(', round(Inc_2010_No_HI_statin_count / (Inc_2010_No_HI_statin_count + Inc_2010_No_HI_statin_N_count)*100,0),'%)', sep = ''), paste(round(Inc_2010_No_HI_statin_mean_follow_up,1),' ','(',round(Inc_2010_No_HI_statin_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Inc_table <- rbind(Inc_table, Temp_X)

#2010 not had statin

Temp_X <- as.data.frame(cbind('Had not received', paste(Inc_2010_No_HI_statin_N_count,' ','(', round(Inc_2010_No_HI_statin_N_count / (Inc_2010_No_HI_statin_count + Inc_2010_No_HI_statin_N_count)*100,0),'%)', sep = ''), paste(round(Inc_2010_No_HI_statin_N_mean_follow_up,1),' ','(',round(Inc_2010_No_HI_statin_N_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Inc_table <- rbind(Inc_table, Temp_X)



Temp_X <- as.data.frame(cbind('2021','',''))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')
Inc_table <- rbind(Inc_table, Temp_X)


#2021 had treatment

Temp_X <- as.data.frame(cbind('Had received', paste(Inc_2021_No_treat_count,' ','(', round(Inc_2021_No_treat_count / (Inc_2021_No_treat_count + Inc_2021_No_treat_N_count)*100,0),'%)', sep = ''), paste(round(Inc_2021_No_treat_mean_follow_up,1),' ','(',round(Inc_2021_No_treat_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Inc_table <- rbind(Inc_table, Temp_X)

#2021 not had treatment

Temp_X <- as.data.frame(cbind('Had not received', paste(Inc_2021_No_treat_N_count,' ','(', round(Inc_2021_No_treat_N_count / (Inc_2021_No_treat_count + Inc_2021_No_treat_N_count)*100,0),'%)', sep = ''), paste(round(Inc_2021_No_treat_N_mean_follow_up,1),' ','(',round(Inc_2021_No_treat_N_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Inc_table <- rbind(Inc_table, Temp_X)



Temp_X <- as.data.frame(cbind('2010','',''))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')
Inc_table <- rbind(Inc_table, Temp_X)



#2010 had treatment

Temp_X <- as.data.frame(cbind('Had received', paste(Inc_2010_No_treat_count,' ','(', round(Inc_2010_No_treat_count / (Inc_2010_No_treat_count + Inc_2010_No_treat_N_count)*100,0),'%)', sep = ''), paste(round(Inc_2010_No_treat_mean_follow_up,1),' ','(',round(Inc_2010_No_treat_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Inc_table <- rbind(Inc_table, Temp_X)

#2010 not had treatment

Temp_X <- as.data.frame(cbind('Had not received', paste(Inc_2010_No_treat_N_count,' ','(', round(Inc_2010_No_treat_N_count / (Inc_2010_No_treat_count + Inc_2010_No_treat_N_count)*100,0),'%)', sep = ''), paste(round(Inc_2010_No_treat_N_mean_follow_up,1),' ','(',round(Inc_2010_No_treat_N_sd_follow_up,1),')', sep = '')))
colnames(Temp_X) <- c('', 'N (%)', 'Mean (SD) patient follow-up years prior')

Inc_table <- rbind(Inc_table, Temp_X)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
Inc_table %>% 
  kbl(caption = 'Suppl Table X. Incident ') %>%
  pack_rows(index = c('No high-intensity statin therapy – received high-intensity statin prior'=6,
                      'No lipid-lowering therapy – received any statin therapy prior'=6), 
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()
```

<br>
<br>

### Diagnosed in GP vs PEDW

```{r, include=FALSE}

DIAG_SPLIT <- db2_run(conn = Connection, query = 'SELECT * FROM SAILW1483V.COHORT_DIAG_SPLIT ORDER BY FIRST_YEAR')

DIAG_SPLIT[DIAG_SPLIT == 'ST'] <- 'Stroke'
DIAG_SPLIT[DIAG_SPLIT == 'ALL'] <- 'Overall'
DIAG_SPLIT$type <- factor(DIAG_SPLIT$type, levels= c('Overall', 'IHD', 'Stroke', 'PAD'))

DIAG_SPLIT_ALL <- DIAG_SPLIT %>% filter(type == 'Overall') %>% dplyr::select(-type)
DIAG_SPLIT_IHD <- DIAG_SPLIT %>% filter(type == 'IHD') %>% dplyr::select(-type)
DIAG_SPLIT_ST <- DIAG_SPLIT %>% filter(type == 'Stroke') %>% dplyr::select(-type)
DIAG_SPLIT_PAD <- DIAG_SPLIT %>% filter(type == 'PAD') %>% dplyr::select(-type)

```

```{r, include=FALSE}

DIAG_SPLIT_ALL_wide <- DIAG_SPLIT_ALL %>% pivot_wider(names_from = first_year, values_from = count_pct)  %>% arrange(diag)
DIAG_SPLIT_IHD_wide <- DIAG_SPLIT_IHD %>% pivot_wider(names_from = first_year, values_from = count_pct)  %>% arrange(diag)
DIAG_SPLIT_ST_wide <- DIAG_SPLIT_ST %>% pivot_wider(names_from = first_year, values_from = count_pct)  %>% arrange(diag)
DIAG_SPLIT_PAD_wide <- DIAG_SPLIT_PAD %>% pivot_wider(names_from = first_year, values_from = count_pct)  %>% arrange(diag)

Base_df <- rbind(DIAG_SPLIT_ALL_wide, DIAG_SPLIT_IHD_wide, DIAG_SPLIT_ST_wide, DIAG_SPLIT_PAD_wide)

Base_df[Base_df == 'GP'] <- 'Primary care'
Base_df[Base_df == 'PEDW'] <- 'Secondary care'

colnames(Base_df)[1] <- ' '

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

Base_df %>%
  kbl(caption = 'Suppl Table X. Index diagnoses made in primary and secondary care by index vascular territory and year of diagnosis.') %>%
  pack_rows(index = c('Overall'=2,
                      'IHD'=2,                    
                      'Stroke'=2,
                      'PAD'=2), 
                      label_row_css = 'background-color: #999; color: #fff') %>%
  kable_styling(bootstrap_options = c('hover','condensed')) %>%
  kable_paper()
```

<br>
<br>

```{r, include=FALSE}

# Close connection to DB2

db2_close(conn = Connection)
```


