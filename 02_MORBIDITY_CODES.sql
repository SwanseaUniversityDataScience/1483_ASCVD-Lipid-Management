------------------------------------------
--
-- Script:			02_MORBIDITY_CODES.sql
-- SAIL project:	1483 - Cardiovascular disease risk prediction and optimisation of risk factor management
--
-- About:			Comorbidity diagnostic codes for primary care data
-- Author:			Daniel King
------------------------------------------
--
--Drop Table
CALL FNC.DROP_IF_EXISTS('SAILW1483V.PHEN_MORB_READ');
COMMIT;
------------------------------------------ 
--
-- Create Table
CREATE TABLE SAILW1483V.PHEN_MORB_READ
(
	READ_CODE		VARCHAR(5),
	DESC			VARCHAR(198),
	READ_TYPE		VARCHAR(16)
) 
;
COMMIT;
------------------------------------------
--
--Insert into Table
INSERT INTO SAILW1483V.PHEN_MORB_READ
(
--
--AF
SELECT
	R.READ_CODE,
	CASE
		WHEN R.PREF_TERM_198 IS NULL AND R.PREF_TERM_60 IS NULL THEN R.PREF_TERM_30
		WHEN R.PREF_TERM_198 IS NULL THEN R.PREF_TERM_60
		ELSE PREF_TERM_198
	END AS DESC,
	'AF' AS READ_TYPE
FROM
	SAILUKHDV.READ_CD_CV2_SCD R
WHERE
(
 READ_CODE IN ('3272.','3273.','14AN.','14AR.','8CMW2')
 OR 
 READ_CODE LIKE 'G573%'
)
AND IS_LATEST = 1

UNION
--
--WEIGHT
SELECT
	R.READ_CODE,
	CASE
		WHEN R.PREF_TERM_198 IS NULL AND R.PREF_TERM_60 IS NULL THEN R.PREF_TERM_30
		WHEN R.PREF_TERM_198 IS NULL THEN R.PREF_TERM_60
		ELSE PREF_TERM_198
	END AS DESC,
	'WEIGHT' AS READ_TYPE
FROM
	SAILUKHDV.READ_CD_CV2_SCD R
WHERE
(
 READ_CODE LIKE '22k%'
 OR 
 READ_CODE LIKE '22A%'
 OR 
 READ_CODE LIKE '22K%'
)
AND IS_LATEST = 1

UNION
--
--CKD(Chronic Kidney Disease)/CRF(Chronic Renal Failure)
SELECT
	R.READ_CODE,
	CASE
		WHEN R.PREF_TERM_198 IS NULL AND R.PREF_TERM_60 IS NULL THEN R.PREF_TERM_30
		WHEN R.PREF_TERM_198 IS NULL THEN R.PREF_TERM_60
		ELSE PREF_TERM_198
	END AS DESC,
	'CRF' AS READ_TYPE
FROM
	SAILUKHDV.READ_CD_CV2_SCD R
WHERE
READ_CODE IN 
('K054.','K053.','1Z1B.','1Z1C.',
 '1Z1D.','1Z1E.','1Z1F.','1Z1G.',
 '1Z1T.','1Z1V.','1Z1W.','1Z1X.',
 '1Z1Y.','1Z1Z.','1Z1a.','1Z1b.',
 '1Z1c.','1Z1d.','1Z1e.','1Z1f.',
 'K055.','1Z13.','1Z14.','1Z15.',
 '1Z16.','K05..','1Z1H.','1Z1J.',
 '1Z1K.','1Z1L.','1Z12.')
AND IS_LATEST = 1

UNION
--
--Hypertension
SELECT
	R.READ_CODE,
	CASE
		WHEN R.PREF_TERM_198 IS NULL AND R.PREF_TERM_60 IS NULL THEN R.PREF_TERM_30
		WHEN R.PREF_TERM_198 IS NULL THEN R.PREF_TERM_60
		ELSE PREF_TERM_198
	END AS DESC,
	'HYPERTENSION' AS READ_TYPE
FROM
	SAILUKHDV.READ_CD_CV2_SCD R
WHERE
(
 READ_CODE IN('14A2.')
 OR 
 READ_CODE LIKE 'G2%'
)
AND IS_LATEST = 1

UNION
--
--Liver Disease
SELECT
	R.READ_CODE,
	CASE
		WHEN R.PREF_TERM_198 IS NULL AND R.PREF_TERM_60 IS NULL THEN R.PREF_TERM_30
		WHEN R.PREF_TERM_198 IS NULL THEN R.PREF_TERM_60
		ELSE PREF_TERM_198
	END AS DESC,
	'LIVER_DISEASE' AS READ_TYPE
FROM
	SAILUKHDV.READ_CD_CV2_SCD R
WHERE
(
 READ_CODE IN('J6152','C3104','Jyu71','G8522','G8523','J6356')
 OR 
 READ_CODE LIKE 'J615%'
 OR 
 READ_CODE LIKE 'J612%'
 OR 
 READ_CODE LIKE 'J61%'
)
AND IS_LATEST = 1

UNION
--
--Dementia
SELECT
	R.READ_CODE,
	CASE
		WHEN R.PREF_TERM_198 IS NULL AND R.PREF_TERM_60 IS NULL THEN R.PREF_TERM_30
		WHEN R.PREF_TERM_198 IS NULL THEN R.PREF_TERM_60
		ELSE PREF_TERM_198
	END AS DESC,
	'DEMENTIA' AS READ_TYPE
FROM
	SAILUKHDV.READ_CD_CV2_SCD R
WHERE
(
 READ_CODE LIKE 'E00%'
 OR 
 READ_CODE LIKE 'Eu0%'
)
AND IS_LATEST = 1

UNION
--
--Diabetes
SELECT
	R.READ_CODE,
	CASE
		WHEN R.PREF_TERM_198 IS NULL AND R.PREF_TERM_60 IS NULL THEN R.PREF_TERM_30
		WHEN R.PREF_TERM_198 IS NULL THEN R.PREF_TERM_60
		ELSE PREF_TERM_198
	END AS DESC,
	'DIABETES' AS READ_TYPE
FROM
	SAILUKHDV.READ_CD_CV2_SCD R
WHERE
(
READ_CODE IN('C1000','C1010','C1020','C1030','C1040','C1050',
'C1060','C1070','C1080','C1082','C1085','C1087','C1088','C1089',
'C10E.','C10E0','C10E1','C10E2','C10E3','C10E4','C10E5','C10E6',
'C10E7','C10E8','C10E9','C10EA','C10EB','C10EC','C10ED','C10EE',
'C10EF','C10EG','C10EH','C10EJ','C10EK','C10EL','C10EM','C10EN',
'C10EP','C10EQ','C10y0','C10z0','L180A','C108.','C1081','C1083',
'C1084','C1086','C108A','C108B','C108C','C108D','C108E','C108F',
'C108G','C108H','C108J','L1805','X40J4','C1011','C1021','C1031',
'C1041','C1051','C1061','C1071','C109.','C1090','C1091','C1092',
'C1093','C1094','C1095','C1096','C1097','C1099','C109A','C109B',
'C109C','C109D','C109E','C109F','C109G','C109H','C109J','C109K',
'C10D.','C10F.','C10F0','C10F1','C10F2','C10F3','C10F4','C10F5',
'C10F6','C10F7','C10F9','C10FA','C10FB','C10FC','C10FD','C10FE',
'C10FF','C10FG','C10FH','C10FJ','C10FK','C10FL','C10FM','C10FN',
'C10FP','C10FQ','C10FR','C10y1','C10z1','L1806','L180B','X40J5',
'X40J6','C1001','L180.','L1800','L1802','L1804','L1808','L180z',
'C10A.','C10A0','C10A1','C10A2','C10A3','C10A4','XE10H','XE10I',
'C10A5','C10A6','C10A7','C10AW','C10AX','Cyu21','Cyu22','L1807',
'X40J8','X40J9','C10ER','C10Q.','XSETH','XacoB','66A3.','66A4.',	
'66A5.','66AJ1','66o2.','66o5.','66o6.','C10..','C100.','C100z',
'C101.','C101y','C101z','C102.','C102z','C103.','C103y','C103z',
'C104.','C104y','C104z','C105.','C105y','C105z','C106.','C106y',
'C106z','C107.','C1072','C107y','C107z','C108y','C108z','C10B.',
'C10B0','C10C.','C10FS','C10H.','C10H0','C10M.','C10M0','C10y.',
'C10yy','C10yz','C10z.','C10zy','C10zz','C11y0','Cyu2.','Cyu20',
'Cyu23','L1801','L1803','L180X','Lyu29','Q441.','X40J7','XE10G',
'XE12M')
)
AND IS_LATEST = 1

UNION
--
--Heart Failure
SELECT
	R.READ_CODE,
	CASE
		WHEN R.PREF_TERM_198 IS NULL AND R.PREF_TERM_60 IS NULL THEN R.PREF_TERM_30
		WHEN R.PREF_TERM_198 IS NULL THEN R.PREF_TERM_60
		ELSE PREF_TERM_198
	END AS DESC,
	'HEART_FAILURE' AS READ_TYPE
FROM
	SAILUKHDV.READ_CD_CV2_SCD R
WHERE
(
 READ_CODE LIKE 'G58%'
)
AND IS_LATEST = 1

UNION
--
--Valvular Disease
SELECT
	R.READ_CODE,
	CASE
		WHEN R.PREF_TERM_198 IS NULL AND R.PREF_TERM_60 IS NULL THEN R.PREF_TERM_30
		WHEN R.PREF_TERM_198 IS NULL THEN R.PREF_TERM_60
		ELSE PREF_TERM_198
	END AS DESC,
	'VALVULAR_DISEASE' AS READ_TYPE
FROM
	SAILUKHDV.READ_CD_CV2_SCD R
WHERE
(
 READ_CODE IN('G54z5','I4S4.','P6yy7','79144','14T3.','ZV422','ZV433','P6z0.','7919.','ZV45H','G5440','G5441','G5804','SP002','G5442','SP004')
 OR
 READ_CODE LIKE '791%'
 OR
 READ_CODE LIKE '7N40%'
 OR
 READ_CODE LIKE 'A932%'
 OR
 READ_CODE LIKE 'p60%'
 OR
 READ_CODE LIKE 'G140%'
 OR
 READ_CODE LIKE 'G11%'
 OR
 READ_CODE LIKE 'G12%'
 OR
 READ_CODE LIKE 'G141%'
 OR
 READ_CODE LIKE 'G13%'
 OR
 READ_CODE LIKE 'G54%'
 OR
 READ_CODE LIKE '791%'
 OR
 READ_CODE LIKE 'P6%'
)
AND IS_LATEST = 1

UNION
--
--Dyslipidaemia
SELECT
	R.READ_CODE,
	CASE
		WHEN R.PREF_TERM_198 IS NULL AND R.PREF_TERM_60 IS NULL THEN R.PREF_TERM_30
		WHEN R.PREF_TERM_198 IS NULL THEN R.PREF_TERM_60
		ELSE PREF_TERM_198
	END AS DESC,
	'DYSLIPID' AS READ_TYPE
FROM
	SAILUKHDV.READ_CD_CV2_SCD R
WHERE
(
 READ_CODE IN('C324.','C328.','C329.')
 OR
 READ_CODE LIKE 'C320%'
 OR
 READ_CODE LIKE 'C321%'
 OR
 READ_CODE LIKE 'C322%'
)
AND IS_LATEST = 1

UNION
--
--COPD
SELECT
	R.READ_CODE,
	CASE
		WHEN R.PREF_TERM_198 IS NULL AND R.PREF_TERM_60 IS NULL THEN R.PREF_TERM_30
		WHEN R.PREF_TERM_198 IS NULL THEN R.PREF_TERM_60
		ELSE PREF_TERM_198
	END AS DESC,
	'COPD' AS READ_TYPE
FROM
	SAILUKHDV.READ_CD_CV2_SCD R
WHERE
(
 READ_CODE IN('H3...','H36..','H37..','H38..','H39..','H3A..','H3121','H3122','H3z..','H300.')
 OR
 READ_CODE LIKE 'H32%'
 OR
 READ_CODE LIKE 'H3y%'
 OR
 READ_CODE LIKE 'H3B%'
)
AND IS_LATEST = 1
) 
; 
COMMIT;
--
------------------------------------------
--
-- Select all results
SELECT 
	* 
FROM 
	SAILW1483V.PHEN_MORB_READ;
--
-- Count all results
SELECT 
	COUNT(*)
FROM 
	SAILW1483V.PHEN_MORB_READ;
--	
